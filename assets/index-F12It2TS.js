var ue=Object.defineProperty;var he=(i,e,t)=>e in i?ue(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var a=(i,e,t)=>(he(i,typeof e!="symbol"?e+"":e,t),t),q=(i,e,t)=>{if(!e.has(i))throw TypeError("Cannot "+t)};var h=(i,e,t)=>(q(i,e,"read from private field"),t?t.call(i):e.get(i)),M=(i,e,t)=>{if(e.has(i))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(i):e.set(i,t)},x=(i,e,t,s)=>(q(i,e,"write to private field"),s?s.call(i,t):e.set(i,t),t);var _=(i,e,t,s)=>({set _(r){x(i,e,r,t)},get _(){return h(i,e,s)}}),$=(i,e,t)=>(q(i,e,"access private method"),t);import{r as m,j as w,_ as X}from"./index-UYsiQFoh.js";function P(i){const[e,t]=m.useState(i),s=m.useRef(e);return[s,o=>{o instanceof Function?(s.current=o(s.current),t(o)):(s.current=o,t(o))}]}class c{constructor(e,t){a(this,"x");a(this,"y");this.x=e,this.y=t}add(e){return new c(this.x+e.x,this.y+e.y)}}const I={NW:new c(-1,-1),N:new c(0,-1),NE:new c(1,-1),E:new c(1,0),SE:new c(1,1),S:new c(0,1),SW:new c(-1,1),W:new c(-1,0)};var C;class Y{constructor(e,t){a(this,"empty",!1);a(this,"color");a(this,"grid");a(this,"shouldTryAwakeNeighbours");a(this,"index",-1);a(this,"position",new c(0,0));M(this,C,!0);a(this,"maxSpeed",8);a(this,"acceleration",.4);a(this,"velocity",0);a(this,"dir",{NW:()=>this.getNeighbourInDirection(I.NW),N:()=>this.getNeighbourInDirection(I.N),NE:()=>this.getNeighbourInDirection(I.NE),E:()=>this.getNeighbourInDirection(I.E),SE:()=>this.getNeighbourInDirection(I.SE),S:()=>this.getNeighbourInDirection(I.S),SW:()=>this.getNeighbourInDirection(I.SW),W:()=>this.getNeighbourInDirection(I.W)});const{isEmpty:s,shouldTryAwakeNeighbours:r}={shouldTryAwakeNeighbours:!0,...t};this.grid=e,this.shouldTryAwakeNeighbours=r,this.empty=s||!1,this.maxSpeed=8,this.acceleration=.4,this.velocity=0,this.color=this.getRGBA()}isSleeping(){return h(this,C)}sleep(){x(this,C,!0),this.grid.registerChanged(this)}awake(){x(this,C,!1),this.grid.registerChanged(this)}getPosition(){return this.grid.positionOf(this)}getNeighbourInDirection(e){const t=this.grid,s=t.positionOf(this);if(s)return t.getAtPosition(s.add(e))}swap(e){this.grid.swap(this,e)}}C=new WeakMap;class ee extends Y{constructor(e){super(e,{isEmpty:!0})}awake(){}getRGBA(){return[128,128,128,255]}step(){}}class B extends Y{}class H extends Y{constructor(t,s){super(t,s);a(this,"numFramesOfHorizontalMovement",0);a(this,"maxFramesOfHorizontalMovement",100);a(this,"dispersionRate");a(this,"fallDirection");a(this,"erosionFactor");const{dispersionRate:r,fallDirection:o,erosionFactor:n}=s||{};this.dispersionRate=r||5,this.fallDirection=o||1,this.erosionFactor=n||.01}step(){let t=!1;const s=[-this.dispersionRate,this.dispersionRate];Math.random()>.5&&s.reverse(),this.shouldTryAwakeNeighbours&&!this.isSleeping()&&s.every(o=>{const n=this.getNeighbourInDirection(new c(o,0));n!=null&&n.empty||n==null||n.awake(),this.erosionFactor>0&&n instanceof te&&Math.random()<this.erosionFactor&&this.swap(n)});const r=this.getNeighbourInDirection(new c(0,this.fallDirection));r!=null&&r.empty?(this.swap(r),t=!0,this.numFramesOfHorizontalMovement=0):this.numFramesOfHorizontalMovement<=this.maxFramesOfHorizontalMovement&&s.every(o=>{const n=this.grid;return n.getPositionsInLine(this.position,this.position.add(new c(o,0)),{excludeStart:!0}).every(D=>{const f=n.getAtPosition(D);return f!=null&&f.empty?(this.swap(f),t=!0,this.numFramesOfHorizontalMovement++,!1):!(f instanceof B)}),!t}),t||this.sleep()}}var O,z;class te extends B{constructor(){super(...arguments);M(this,O,0);M(this,z,100)}step(){let t=!1;const s=[-1,1];Math.random()>=.5&&s.reverse();const r=this.dir.S();r!=null&&r.empty||r instanceof H?(this.swap(r),t=!0):this.isSleeping()||s.every(o=>{const n=this.getNeighbourInDirection(new c(o,1));return n!=null&&n.empty||n instanceof H?(this.swap(n),t=!0,!1):!0}),t?(s.every(o=>{const n=this.getNeighbourInDirection(new c(o,0));return n!=null&&n.empty||n==null||n.awake(),!0}),x(this,O,0)):(_(this,O)._++,h(this,O)>=h(this,z)&&this.sleep())}}O=new WeakMap,z=new WeakMap;class de extends te{getRGBA(){const e=Math.random()*20;return[191-e,155-e,123-e,255]}}class le extends H{constructor(e,t){super(e,{...t,dispersionRate:3})}getRGBA(){return[46,137,255,Math.round(Math.random()*100)+155]}}class fe extends B{constructor(e,t){super(e,{shouldTryAwakeNeighbours:!1,...t})}awake(){}step(){}}class ge extends fe{getRGBA(){return[100,100,100,255]}}class U extends H{constructor(e,t){super(e,{fallDirection:-1,dispersionRate:3,erosionFactor:0,shouldTryAwakeNeighbours:!1,...t})}step(){super.step();const e=[-this.dispersionRate,this.dispersionRate];Math.random()>.5&&e.reverse();let t=!1;if(Math.random()<.98){const s=this.dir.N();s instanceof H&&!(s instanceof U)&&(this.swap(s),t=!0)}else this.numFramesOfHorizontalMovement<=this.maxFramesOfHorizontalMovement&&e.every(s=>{const r=this.grid;return r.getPositionsInLine(this.position,this.position.add(new c(s,0)),{excludeStart:!0}).every(n=>{const u=r.getAtPosition(n);return u!=null&&u.empty?(this.swap(u),t=!0,this.numFramesOfHorizontalMovement++,!1):!(u instanceof B)}),!t});t||this.sleep()}}class me extends U{getRGBA(){return[90,90,90,Math.round(Math.random()*185)+70]}}var y,k;class pe{constructor(e,t){a(this,"width");a(this,"height");M(this,y,void 0);M(this,k,void 0);this.width=e,this.height=t,x(this,y,[]),x(this,k,new Set([])),this.clear()}clear(){for(let e=0;e<this.width*this.height;e++)this.setAtIndex(e,new ee(this))}indexOf(e){return e?e.index:-1}positionOf(e){if(e)return e.position}forEach(e){const t=new Set;for(let s=0;s<h(this,y).length;s++){const r=h(this,y)[s];if(t.has(r))continue;if(e(r,s)===!1)break;t.add(r)}}forEachChanged(e,t=!0){h(this,k).forEach(s=>e(s)),t&&h(this,k).clear()}position2index(e){const{x:t,y:s}=e;return t<0||t>=this.width||s<0||s>=this.height?-1:t+s*this.width}index2position(e){let t=Math.floor(e/this.width),s=e-t*this.width;return new c(s,t)}get(e){return this.getAtPosition(e)}set(e,t){this.setAtPosition(e,t)}getPositionsInLine(e,t,s){const{excludeStart:r,excludeEnd:o}=s||{},n=t.x-e.x,u=t.y-e.y;if(n===0&&u===0)return[e];const D=n<0?-1:1,f=u<0?-1:1,R=Math.abs(n),b=Math.abs(u),S=R>=b,W=Math.min(R,b),v=Math.max(R,b),g=W/v,l=[];for(let p=r?1:0;p<(o?v:v+1);p++){const G=Math.round(p*g);S?l.push(new c(e.x+p*D,e.y+G*f)):l.push(new c(e.x+G*D,e.y+p*f))}return l}getAtPosition(e){const t=this.position2index(e);if(t!==-1)return this.getAtIndex(t)}setAtPosition(e,t){const s=this.position2index(e);this.setAtIndex(s,t)}getAtIndex(e){return h(this,y)[e]}registerChanged(e){h(this,k).add(e)}swap(e,t){const s=this.indexOf(e),r=this.indexOf(t),o=h(this,y)[s];this.setAtIndex(s,h(this,y)[r]),this.setAtIndex(r,o),e.awake(),t.awake()}setAtIndex(e,t){t.index=e,t.position=this.index2position(e),h(this,y)[e]=t,this.registerChanged(t)}}y=new WeakMap,k=new WeakMap;var N,E,T,se;class we{constructor(e){M(this,T);M(this,N,void 0);M(this,E,!0);a(this,"materialPalette");const{width:t,height:s}=e;x(this,N,new pe(t,s)),this.materialPalette=$(this,T,se).call(this,h(this,N))}isRunning(){return h(this,E)}start(){x(this,E,!0)}stop(){x(this,E,!1)}restart(){this.stop(),h(this,N).clear(),this.start()}getGrid(){return h(this,N)}step(){if(!h(this,E))return;h(this,N).forEach(t=>{t.empty||t.step(-1)})}}N=new WeakMap,E=new WeakMap,T=new WeakSet,se=function(e){return{empty:()=>new ee(e),sand:()=>new de(e),water:()=>new le(e),stone:()=>new ge(e),smoke:()=>new me(e)}};const xe=m.forwardRef((i,e)=>{const{grid:t,scale:s,debugDraw:r,...o}={scale:4,...i},n=m.useRef(null),u=m.useRef(),[D,f]=P(!0);m.useImperativeHandle(e,()=>({clear:S,render:W})),m.useEffect(()=>{f(!0),S()},[t]);function R(){return n.current?n.current.getContext("2d"):null}function b(){if(u.current)return u.current;if(!t)return;const g=R();if(g)return u.current=g.createImageData(t.width,t.height),u.current}function S(){const g=b();g&&(g.data.fill(0),f(!0))}function W(){if(!t)return;const g=R();if(!g)return;const l=b();l&&(D.current===!0?t.forEach(p=>v(l,p)):t.forEachChanged(p=>v(l,p)),g.putImageData(l,0,0),f(!1))}function v(g,l){l.index!==-1&&t&&g.data.set(r&&!l.isSleeping()?[255,255,255,255]:l.color,l.index*4)}return t?w.jsx("canvas",{className:"grid",ref:n,width:t.width,height:t.height,style:{imageRendering:"pixelated",transform:"scale(4)",background:"white"},...o}):null});function Me(){var Q;const s=m.useRef(null),r=m.useRef(null),o=m.useRef(),n=m.useRef(),u=m.useRef(),[D,f]=P(!1),[R,b]=P([0,0]),[S,W]=P(void 0),[v,g]=P(!1),[l,p]=P("sand"),[G,ie]=m.useState([]);m.useEffect(()=>(o.current=new we({width:256,height:256}),n.current=o.current.getGrid(),ie(X.keys(o.current.materialPalette)),K(),u.current=requestAnimationFrame(J),()=>{u.current!==void 0&&cancelAnimationFrame(u.current)}),[]);function ne(d){d.preventDefault()}function re(d){const F=d.target,{x:j,y:A,width:V,height:L}=F.getBoundingClientRect();b([(d.clientX-j)/V,(d.clientY-A)/L])}function J(d){var A;const F=o.current;if(!F)return;const j=F.getGrid();ce(j),F.step(),(A=s.current)==null||A.render(),u.current=requestAnimationFrame(J)}function oe(){f(!0)}function ae(){f(!1),W(void 0)}function ce(d){if(!D.current||!l.current)return;const[F,j]=R.current,A=new c(Math.floor(F*256),Math.floor(j*256));(S.current?d.getPositionsInLine(S.current,A):[A]).every(L=>{var Z;return d.setAtPosition(L,X.invoke((Z=o.current)==null?void 0:Z.materialPalette,l.current)),!0}),S.current=A}function K(){const d=o.current;d&&d.restart()}return w.jsxs("div",{className:"route sand",ref:r,children:[w.jsxs("div",{className:"materials",children:[w.jsx("div",{className:"material",children:"reset",onClick:K}),w.jsx("div",{className:"separator"}),X.map(G,d=>w.jsx("div",{className:"material",children:d,onClick:()=>p(d),style:l.current===d?{border:"1px solid white"}:void 0},d)),w.jsx("div",{className:"separator"}),w.jsxs("div",{children:[w.jsx("input",{id:"debugDraw",type:"checkbox",checked:v.current,onChange:d=>g(d.target.checked)}),w.jsx("label",{htmlFor:"debugDraw",children:"debugDraw"})]})]}),w.jsx(xe,{ref:s,grid:(Q=o.current)==null?void 0:Q.getGrid(),scale:2,debugDraw:v.current,onMouseDown:oe,onMouseUp:ae,onMouseMove:re,onContextMenu:ne})]})}export{Me as default};

var fe=Object.defineProperty;var pe=(s,e,t)=>e in s?fe(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var i=(s,e,t)=>(pe(s,typeof e!="symbol"?e+"":e,t),t),I=(s,e,t)=>{if(!e.has(s))throw TypeError("Cannot "+t)};var h=(s,e,t)=>(I(s,e,"read from private field"),t?t.call(s):e.get(s)),w=(s,e,t)=>{if(e.has(s))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(s):e.set(s,t)},m=(s,e,t,r)=>(I(s,e,"write to private field"),r?r.call(s,t):e.set(s,t),t);var te=(s,e,t,r)=>({set _(n){m(s,e,n,t)},get _(){return h(s,e,r)}}),se=(s,e,t)=>(I(s,e,"access private method"),t);import{r as M,_ as ie,j as l}from"./index-O0Fl2C7K.js";import{G as ge,V as d,a as we,u as z,b as Me}from"./index-IS-IpSmw.js";var x;class O extends ge{constructor(t,r){super(t);i(this,"empty");i(this,"shouldTryAwakeNeighbours");i(this,"color");w(this,x,!1);i(this,"index",-1);i(this,"position",new d(0,0));i(this,"brushSize",4);i(this,"brushFillRate",.05);i(this,"maxSpeed",8);i(this,"acceleration",.4);i(this,"velocity",0);const{empty:n,shouldTryAwakeNeighbours:c}={empty:!1,shouldTryAwakeNeighbours:!0,...r};this.empty=n,this.shouldTryAwakeNeighbours=c,this.maxSpeed=8,this.acceleration=.4,this.velocity=0,this.color=this.getRGBA()}isSleeping(){return h(this,x)}sleep(){m(this,x,!0),this.grid.registerChanged(this)}awake(){m(this,x,!1),this.grid.registerChanged(this)}die(){this.grid.set(this.position,new W(this.grid))}getRGBA(){return h(this,x)?this.color:[255,255,255,255]}}x=new WeakMap;class W extends O{constructor(t){super(t,{empty:!0});i(this,"brushSize",2);i(this,"brushFillRate",1);i(this,"color",[50,50,50,255]);this.sleep()}awake(){}step(){}}class C extends O{}class R extends O{constructor(t,r){super(t,r);i(this,"numFramesOfHorizontalMovement",0);i(this,"maxFramesOfHorizontalMovement",100+Math.random()*25);i(this,"dispersionRate");i(this,"fallDirection");i(this,"erosionFactor");const{dispersionRate:n,fallDirection:c,erosionFactor:o}=r||{};this.dispersionRate=n||8,this.fallDirection=c||1,this.erosionFactor=o||.03}step(){var o,k;let t=!1;const r=[-this.dispersionRate,this.dispersionRate];Math.random()>.5&&r.reverse(),this.shouldTryAwakeNeighbours&&!this.isSleeping()&&r.every(v=>{const u=this.getNeighbourInDirection(new d(v,0));u!=null&&u.empty||u==null||u.awake(),this.erosionFactor>0&&u instanceof T&&Math.random()<this.erosionFactor&&this.swapWith(u)});const n=this.getNeighbourInDirection(new d(0,this.fallDirection)),c=this.getNeighbourInDirection(new d(0,-this.fallDirection));n!=null&&n.empty?(this.swapWith(n),t=!0,this.numFramesOfHorizontalMovement=0):this.numFramesOfHorizontalMovement<=this.maxFramesOfHorizontalMovement&&(c instanceof R&&Math.random()<1e-4?this.swapWith(c):r.every(v=>{const u=this.grid;return u.getPositionsInLine(this.position,this.position.add(new d(v,0)),{excludeStart:!0}).every(S=>{const p=u.getAtPosition(S);return p!=null&&p.empty?(this.swapWith(p),t=!0,this.numFramesOfHorizontalMovement++,!1):!(p instanceof C)}),!t})),t||((o=this.dir.W())!=null&&o.empty||(k=this.dir.E())!=null&&k.empty?this.die():this.sleep())}}var b,j;class T extends C{constructor(){super(...arguments);w(this,b,0);w(this,j,100)}step(){let t=!1;const r=[-1,1];Math.random()>=.5&&r.reverse();const n=this.dir.S();n!=null&&n.empty||n instanceof R?(this.swapWith(n),t=!0):this.isSleeping()||r.every(c=>{const o=this.getNeighbourInDirection(new d(c,1));return o!=null&&o.empty||o instanceof R?(this.swapWith(o),t=!0,!1):!0}),t?(r.every(c=>{const o=this.getNeighbourInDirection(new d(c,0));return o!=null&&o.empty||o==null||o.awake(),!0}),m(this,b,0)):(te(this,b)._++,h(this,b)>=h(this,j)&&this.sleep())}}b=new WeakMap,j=new WeakMap;class xe extends T{constructor(){super(...arguments);i(this,"_r",Math.random()*20);i(this,"color",[191-this._r,155-this._r,123-this._r,255])}}class E extends R{}class q extends E{constructor(t,r){super(t,{...r,dispersionRate:3});i(this,"_r",Math.round(Math.random()*100)+155);i(this,"color",[46,137,255,this._r])}die(){this.grid.set(this.position,new ne(this.grid))}}class ye extends C{constructor(t,r){super(t,{shouldTryAwakeNeighbours:!1,...r});i(this,"brushSize",2);i(this,"brushFillRate",1);this.sleep()}awake(){}step(){}}class ve extends ye{constructor(){super(...arguments);i(this,"color",[100,100,100,255])}}class re extends R{constructor(e,t){super(e,{fallDirection:-1,dispersionRate:3,erosionFactor:0,shouldTryAwakeNeighbours:!1,...t})}step(){const e=this.dir.N();if(e instanceof E){this.swapWith(e),this.numFramesOfHorizontalMovement=0;return}super.step()}}class be extends re{constructor(){super(...arguments);i(this,"color",[90,90,90,Math.round(Math.random()*185)+70])}}class ne extends re{constructor(){super(...arguments);i(this,"_r",Math.round(Math.random()*100)+55);i(this,"color",[255,255,255,this._r])}die(){this.grid.set(this.position,Math.random()<.05?new q(this.grid):new W(this.grid))}}class B extends T{constructor(){super(...arguments);i(this,"_r",Math.random()*20);i(this,"color",[220-this._r,220-this._r,255,255])}step(){this.getNeighbourhood().map(n=>n.empty?.5:n instanceof B?-1:n instanceof C?2:n instanceof E?1:0).reduce((n,c)=>n+c)>0&&Math.random()<.005?this.grid.set(this.position,new q(this.grid)):super.step()}}var f,y,P,oe;class Re{constructor(e){w(this,P);w(this,f,void 0);w(this,y,!0);i(this,"materialPalette");m(this,f,new we({...e,createEmpty:t=>new W(t)})),this.materialPalette=se(this,P,oe).call(this,h(this,f))}isRunning(){return h(this,y)}start(){m(this,y,!0)}stop(){m(this,y,!1)}restart(){this.stop(),h(this,f).clear(),this.start()}getGrid(){return h(this,f)}step(){if(!h(this,y))return;h(this,f).forEach(t=>{t.empty||t.step(-1)},{alternateRows:!0})}}f=new WeakMap,y=new WeakMap,P=new WeakSet,oe=function(e){return{empty:()=>new W(e),sand:()=>new xe(e),water:()=>new q(e),stone:()=>new ve(e),smoke:()=>new be(e),steam:()=>new ne(e),snow:()=>new B(e)}};function Ae(){var J;const t=M.useRef(null),r=M.useRef(),n=M.useRef(),c=M.useRef(),o=M.useRef(void 0),[k,v]=z(!1),[u,L]=z([0,0]),[S,p]=z("sand"),[V,ae]=z(!1),[ce,ue]=M.useState([]);M.useEffect(()=>(r.current=new Re({width:320,height:180}),n.current=r.current.getGrid(),ue(ie.keys(r.current.materialPalette)),U(),c.current=requestAnimationFrame(X),()=>{c.current!==void 0&&cancelAnimationFrame(c.current)}),[]);function he(a){a.preventDefault()}function le(a){const g=a.target,{x:F,y:D,width:A,height:K}=g.getBoundingClientRect();L([(a.clientX-F)/A,(a.clientY-D)/K])}function X(a){const g=r.current;if(!g)return;const F=g.getGrid();me(F),g.step(),c.current=requestAnimationFrame(X)}function de(){v(!0)}function Y(){v(!1),o.current=void 0}function me(a){if(!k.current||!S.current)return;const[g,F]=u.current,D=new d(Math.floor(g*320),Math.floor(F*180)),A=r.current;if(!A)return;const G=A.materialPalette[S.current];if(!G)return;const N=G(),Q=Math.floor(N.brushSize);(o.current?a.getPositionsInLine(o.current,D):[D]).every(Z=>{for(let _=-Q;_<N.brushSize;_++)for(let H=-Q;H<N.brushSize;H++){if(Math.random()>N.brushFillRate)continue;const $=Z.x+H;if($<0)continue;const ee=Z.y+_;ee<0||a.setAtPosition(new d($,ee),G())}return!0}),o.current=D}function U(){const a=r.current;a&&a.restart()}return l.jsxs("div",{className:"route sand",ref:t,children:[l.jsxs("div",{className:"materials",children:[l.jsx("div",{className:"material",children:"reset",onClick:U}),l.jsx("div",{className:"separator"}),ie.map(ce,a=>l.jsx("div",{className:"material",children:a,onClick:()=>p(a),style:S.current===a?{border:"1px solid white"}:void 0},a)),l.jsx("div",{className:"separator"}),l.jsxs("div",{children:[l.jsx("input",{id:"debugDraw",type:"checkbox",checked:V.current,onChange:a=>ae(a.target.checked)}),l.jsx("label",{htmlFor:"debugDraw",children:"debugDraw"})]})]}),l.jsx(Me,{grid:(J=r.current)==null?void 0:J.getGrid(),onMouseDown:de,onMouseUp:Y,onMouseLeave:Y,onMouseMove:le,onContextMenu:he,pickColor:a=>V.current&&!a.isSleeping()?[255,255,255,255]:a.color})]})}export{Ae as default};

var ve=Object.defineProperty;var Me=(s,e,t)=>e in s?ve(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var r=(s,e,t)=>(Me(s,typeof e!="symbol"?e+"":e,t),t),O=(s,e,t)=>{if(!e.has(s))throw TypeError("Cannot "+t)};var d=(s,e,t)=>(O(s,e,"read from private field"),t?t.call(s):e.get(s)),F=(s,e,t)=>{if(e.has(s))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(s):e.set(s,t)},v=(s,e,t,i)=>(O(s,e,"write to private field"),i?i.call(s,t):e.set(s,t),t);var ie=(s,e,t,i)=>({set _(u){v(s,e,u,t)},get _(){return d(s,e,i)}}),re=(s,e,t)=>(O(s,e,"access private method"),t);import{r as g,_ as ne,j as l}from"./index-AqJILOme.js";import{G as ye,V as m,a as xe,u as j,b as Fe}from"./index-A5hoYkzl.js";var b;class I extends ye{constructor(t,i){super(t);r(this,"empty");r(this,"shouldTryAwakeNeighbours");r(this,"color");F(this,b,!1);r(this,"index",-1);r(this,"position",new m(0,0));r(this,"brushSize",4);r(this,"brushFillRate",.05);r(this,"velocity",new m(0,0));r(this,"gravity",new m(0,2));const{empty:u,shouldTryAwakeNeighbours:n}={empty:!1,shouldTryAwakeNeighbours:!0,...i};this.empty=u,this.shouldTryAwakeNeighbours=n,this.color=this.getRGBA()}isSleeping(){return d(this,b)}sleep(){v(this,b,!0),this.grid.registerChanged(this)}awake(){v(this,b,!1),this.grid.registerChanged(this)}die(){this.grid.set(this.position,new k(this.grid))}getRGBA(){return this.color}}b=new WeakMap;class k extends I{constructor(t){super(t,{empty:!0});r(this,"brushSize",2);r(this,"brushFillRate",1);r(this,"color",[50,50,50,255]);this.sleep()}awake(){}step(){}}class G extends I{}class S extends I{constructor(t,i){super(t,i);r(this,"numFramesOfHorizontalMovement",0);r(this,"maxFramesOfHorizontalMovement",100+Math.random()*25);r(this,"numFramesWithoutMovement",0);r(this,"maxFramesWithoutMovement",100+Math.random()*25);r(this,"dispersionRate");r(this,"erosionFactor");const{dispersionRate:u,erosionFactor:n}=i||{};this.dispersionRate=u||12,this.erosionFactor=n||.03}step(t){var n,h;let i=!1;const u=[-1,1];if(Math.random()>.5&&u.reverse(),this.isSleeping()){const o=this.getNeighbourInDirection(this.gravity.ceil());o!=null&&o.empty&&this.swapWith(o),this.numFramesOfHorizontalMovement=0}else{this.velocity=this.velocity.add(this.gravity.divideScalar(t));let o=this;if(this.getLineTo(this.position.add(this.velocity),{excludeStart:!0}).every(c=>{const f=this.grid.get(c);return f!=null&&f.empty?(o=f,!0):!1}),o!==this)this.swapWith(o),i=!0,this.numFramesOfHorizontalMovement=0;else if(this.numFramesOfHorizontalMovement<=this.maxFramesOfHorizontalMovement){const c=this.dir.N();c instanceof S&&Math.random()<5e-4?this.swapWith(c):u.every(f=>{const N=this.grid;return this.erosionFactor>0&&c instanceof E&&Math.random()<this.erosionFactor&&this.swapWith(c),N.getPositionsInLine(this.position,this.position.add(new m(f*this.dispersionRate,0)),{excludeStart:!0}).every(D=>{const y=N.getAtPosition(D);return y!=null&&y.empty?(this.swapWith(y),i=!0,this.numFramesOfHorizontalMovement++,!1):!(y instanceof G)}),!i})}else((n=this.dir.W())!=null&&n.empty||(h=this.dir.E())!=null&&h.empty)&&this.die()}i?(u.every(o=>{const c=this.getNeighbourInDirection(new m(o,0));return c!=null&&c.empty||c==null||c.awake(),!0}),this.numFramesWithoutMovement=0):(this.numFramesWithoutMovement++,this.numFramesWithoutMovement>=this.maxFramesWithoutMovement&&this.sleep())}}var W,z;class E extends G{constructor(){super(...arguments);F(this,W,0);F(this,z,100)}step(t){let i=!1;const u=[-1,1];if(Math.random()>=.5&&u.reverse(),this.isSleeping()){const n=this.dir.S();(n!=null&&n.empty||n instanceof S)&&this.swapWith(n)}else{this.velocity=this.velocity.add(this.gravity.divideScalar(t));let n=this;this.getLineTo(this.position.add(this.velocity),{excludeStart:!0}).every(h=>{const o=this.grid.get(h);return o==null||o.awake(),o!=null&&o.empty||o instanceof S?(n=o,!0):!1}),n!==this?(this.swapWith(n),i=!0):u.every(h=>{const o=this.getNeighbourInDirection(new m(h,1));return o!=null&&o.empty||o instanceof S?(this.swapWith(o),i=!0,!1):!0})}i?(u.every(n=>{const h=this.getNeighbourInDirection(new m(n,0));return h!=null&&h.empty||h==null||h.awake(),!0}),v(this,W,0)):(ie(this,W)._++,d(this,W)>=d(this,z)&&this.sleep())}}W=new WeakMap,z=new WeakMap;class Re extends E{constructor(){super(...arguments);r(this,"_r",Math.random()*20);r(this,"color",[191-this._r,155-this._r,123-this._r,255])}}class B extends S{}class oe extends S{constructor(t,i){super(t,{dispersionRate:8,erosionFactor:0,shouldTryAwakeNeighbours:!1,...i});r(this,"gravity",new m(0,-.1))}step(t){const i=this.dir.N();if(i instanceof B){this.swapWith(i);return}super.step(t)}}class Se extends oe{constructor(){super(...arguments);r(this,"color",[90,90,90,Math.round(Math.random()*185)+70])}}class L extends E{constructor(){super(...arguments);r(this,"_r",Math.random()*20);r(this,"color",[220-this._r,220-this._r,255,255])}step(t){if(!this.isSleeping()||Math.random()<.995){super.step(t);return}this.getNeighbourhood().map(n=>n.empty?.5:n instanceof L?-1:n instanceof G?2:n instanceof B?1:0).reduce((n,h)=>n+h)>0&&this.die()}getRGBA(){return this.isSleeping()?this.color:[255,255,255,255]}die(){this.grid.set(this.position,Math.random()<.25?new q(this.grid):new k(this.grid))}}class ae extends oe{constructor(){super(...arguments);r(this,"_r",Math.round(Math.random()*80)+100);r(this,"color",[255,255,255,this._r])}die(){this.grid.set(this.position,Math.random()<.05?new q(this.grid):new k(this.grid))}}class he extends G{constructor(t,i){super(t,{shouldTryAwakeNeighbours:!1,...i});r(this,"brushSize",2);r(this,"brushFillRate",1);this.sleep()}awake(){}step(){}}class be extends he{constructor(){super(...arguments);r(this,"color",[100,100,100,255])}}class q extends B{constructor(t,i){super(t,{...i,dispersionRate:3});r(this,"_r",Math.round(Math.random()*100)+155);r(this,"color",[46,137,255,this._r])}die(){this.grid.set(this.position,Math.random()<.25?new ae(this.grid):new k(this.grid))}}class We extends he{constructor(){super(...arguments);r(this,"_r",Math.random()*20);r(this,"color",[180-this._r,100-this._r,100-this._r,255-this._r])}}var M,R,C,ue;class ke{constructor(e){F(this,C);F(this,M,void 0);F(this,R,!0);r(this,"materialPalette");v(this,M,new xe({...e,createEmpty:t=>new k(t)})),this.materialPalette=re(this,C,ue).call(this,d(this,M))}isRunning(){return d(this,R)}start(){v(this,R,!0)}stop(){v(this,R,!1)}restart(){this.stop(),d(this,M).clear(),this.start()}getGrid(){return d(this,M)}step(e){if(!d(this,R))return;d(this,M).forEach(i=>{i.empty||i.step(e)},{alternateRows:!0})}}M=new WeakMap,R=new WeakMap,C=new WeakSet,ue=function(e){return{empty:()=>new k(e),sand:()=>new Re(e),smoke:()=>new Se(e),snow:()=>new L(e),steam:()=>new ae(e),stone:()=>new be(e),water:()=>new q(e),wood:()=>new We(e)}};function je(){var Q;const t=g.useRef(null),i=g.useRef(),u=g.useRef(),n=g.useRef(),h=g.useRef(),o=g.useRef(void 0),[c,f]=j(!1),[N,V]=j([0,0]),[D,y]=j("sand"),[X,ce]=g.useState([0]),[Y,le]=j(!1),[de,me]=g.useState([]);g.useEffect(()=>(i.current=new ke({width:320,height:180}),u.current=i.current.getGrid(),me(ne.keys(i.current.materialPalette)),K(),n.current=requestAnimationFrame(U),()=>{n.current!==void 0&&cancelAnimationFrame(n.current)}),[]);function fe(a){a.preventDefault()}function pe(a){const p=a.target,{x:A,y:w,width:x,height:Z}=p.getBoundingClientRect();V([(a.clientX-A)/x,(a.clientY-w)/Z])}function U(a){if(h.current!==void 0){const p=i.current;if(!p)return;const A=p.getGrid();we(A);const w=a-h.current;p.step(w),ce(x=>[...x.slice(x.length-100),1e3/w])}h.current=a,n.current=requestAnimationFrame(U)}function ge(){f(!0)}function J(){f(!1),o.current=void 0}function we(a){if(!c.current||!D.current)return;const[p,A]=N.current,w=new m(Math.floor(p*a.width),Math.floor(A*a.height)),x=i.current;if(!x)return;const P=x.materialPalette[D.current];if(!P)return;const _=P(),$=Math.floor(_.brushSize);(o.current?a.getPositionsInLine(o.current,w):[w]).every(ee=>{for(let T=-$;T<_.brushSize;T++)for(let H=-$;H<_.brushSize;H++){if(Math.random()>_.brushFillRate)continue;const te=ee.x+H;if(te<0)continue;const se=ee.y+T;se<0||a.setAtPosition(new m(te,se),P())}return!0}),o.current=w}function K(){const a=i.current;a&&a.restart()}return l.jsxs("div",{className:"route sand",ref:t,children:[l.jsxs("div",{className:"materials",children:[l.jsx("div",{className:"material",children:"reset",onClick:K}),l.jsx("div",{className:"separator"}),ne.map(de,a=>l.jsx("div",{className:"material",children:a,onClick:()=>y(a),style:D.current===a?{border:"1px solid white"}:void 0},a)),l.jsx("div",{className:"separator"}),l.jsxs("div",{children:[l.jsx("input",{id:"debugDraw",type:"checkbox",checked:Y.current,onChange:a=>le(a.target.checked)}),l.jsx("label",{htmlFor:"debugDraw",children:"debugDraw"})]}),l.jsx("div",{className:"separator"}),l.jsxs("div",{children:["fps: ",(X.reduce((a,p)=>a+p)/X.length||1).toFixed(2)]})]}),l.jsx(Fe,{grid:(Q=i.current)==null?void 0:Q.getGrid(),onMouseDown:ge,onMouseUp:J,onMouseLeave:J,onMouseMove:pe,onContextMenu:fe,pickColor:a=>Y.current&&!a.isSleeping()?[255,255,255,255]:a.getRGBA()})]})}export{je as default};

var Ht=Object.defineProperty;var It=(i,e,t)=>e in i?Ht(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var r=(i,e,t)=>(It(i,typeof e!="symbol"?e+"":e,t),t),$=(i,e,t)=>{if(!e.has(i))throw TypeError("Cannot "+t)};var h=(i,e,t)=>($(i,e,"read from private field"),t?t.call(i):e.get(i)),p=(i,e,t)=>{if(e.has(i))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(i):e.set(i,t)},g=(i,e,t,s)=>($(i,e,"write to private field"),s?s.call(i,t):e.set(i,t),t);var tt=(i,e,t,s)=>({set _(n){g(i,e,n,t)},get _(){return h(i,e,s)}}),ft=(i,e,t)=>($(i,e,"access private method"),t);import{r as M,_ as gt,j as l,F as zt,i as Lt,l as Ot}from"./index-gPDt2v28.js";import{G as vt,a as pt,V as m,u as E,b as qt}from"./index-wdF-5WWh.js";class wt extends vt{}function Vt(i){return new Worker("/assets/worker-_i2HlGok.js",{name:i==null?void 0:i.name})}var x,H;class Xt extends pt{constructor(t){const{chunkWidth:s,chunkHeight:n,...a}={chunkWidth:64,chunkHeight:64,...t};super(a);r(this,"chunkWidth");r(this,"chunkHeight");p(this,x,void 0);p(this,H,void 0);this.chunkWidth=s,this.chunkHeight=n,g(this,x,new pt({width:this.width/s,height:this.height/n,createEmpty:u=>new wt(u)})),g(this,H,new Vt),h(this,H).postMessage("initialized chunk worker"),this.clearChunks()}clearChunks(){for(let t=0;t<h(this,x).width*h(this,x).height;t++)h(this,x).setAtIndex(t,new wt(h(this,x)))}chunkOf(t){if(!t)return;const s=t.position.divide(new m(this.chunkWidth,this.chunkHeight)).floor();return h(this,x).get(s)}forEachChunk(t,s){h(this,x).forEach(t,s)}mapChunks(t){return h(this,x).map(t)}forEachChunkPass(t){[[!1,!1],[!1,!0],[!0,!1],[!0,!0]].forEach(([n,a])=>{const u=[];this.forEachChunk(c=>{u.push(c)},{evenRows:!n,oddRows:n,evenCols:!a,oddCols:a}),t(u)})}}x=new WeakMap,H=new WeakMap;var W;class et extends vt{constructor(t,s){super(t);r(this,"shouldTryAwakeNeighbours");r(this,"empty");r(this,"behaviors");r(this,"color");p(this,W,!1);r(this,"index",-1);r(this,"position",new m(0,0));r(this,"age",0);r(this,"brushSize",4);r(this,"brushFillRate",.05);r(this,"velocity",new m(0,0));const{empty:n,shouldTryAwakeNeighbours:a,behaviors:u}={empty:!1,shouldTryAwakeNeighbours:!0,behaviors:[],...s};this.empty=n,this.shouldTryAwakeNeighbours=a,this.color=this.getRGBA(),this.behaviors=u}isSleeping(){return h(this,W)}sleep(){g(this,W,!0),this.grid.registerChanged(this)}awake(){g(this,W,!1),this.grid.registerChanged(this)}die(){this.grid.set(this.position,new P(this.grid))}getRGBA(){return this.color}addBehaviors(...t){this.behaviors.push(...t)}step(t){this.age+=t,this.behaviors.forEach(s=>{s.step({deltaTime:t,cell:this,grid:this.grid})})}}W=new WeakMap;class P extends et{constructor(t){super(t,{empty:!0});r(this,"name","empty");r(this,"brushSize",2);r(this,"brushFillRate",1);r(this,"color",[50,50,50,255]);this.sleep()}awake(){}step(){}}class w{}class xt extends et{constructor(e,t){super(e,t);const{gravity:s,dispersionRate:n,erosionFactor:a}=t||{};this.addBehaviors(new yt(s),new Ut(n),new Zt(a))}}class T extends xt{}class V extends w{constructor(t=1){super();r(this,"sinkChance");this.sinkChance=t}step({cell:t}){if(Math.random()>this.sinkChance)return;const s=t.dir.S();if(s instanceof T){t.swapWith(s);return}const n=[-1,1];Math.random()>=.5&&n.reverse(),n.every(a=>{const u=t.getNeighbourInDirection(new m(a,1));return u instanceof T?(t.swapWith(u),!1):!0})}}class Mt extends w{constructor(t=1){super();r(this,"floatChance");this.floatChance=t}step({cell:t}){if(Math.random()>this.floatChance)return;const s=t.dir.N();s instanceof T&&t.swapWith(s)}}class Yt extends w{constructor(t,s=3,n=5,a=.005){super();r(this,"spawn");r(this,"breedMinAge");r(this,"breedMaxAge");r(this,"breedChance");this.spawn=t,this.breedMinAge=s,this.breedMaxAge=n,this.breedChance=a}step({cell:t,grid:s}){if(t.isSleeping()||t.age<this.breedMinAge||t.age>this.breedMaxAge||Math.random()>this.breedChance)return;const n=t.dir.S();n&&n.constructor.prototype===t.constructor.prototype&&(n.age<this.breedMinAge||n.age>this.breedMaxAge||t.getNeighbourhood().every(a=>a!=null&&a.empty?(s.setAtIndex(a.index,this.spawn()),!1):!0))}}class X extends et{}class C extends X{constructor(e,t){super(e,t),this.addBehaviors(new yt)}}class Jt extends w{constructor(t=.05){super();r(this,"digChance");this.digChance=t}step({cell:t}){if(Math.random()>this.digChance)return;const s=t.getNeighbourhood().filter(n=>n&&!(n!=null&&n.empty)&&n instanceof C);if(s.length>0){const n=s[Math.floor(Math.random()*s.length)];if(!n)return;t.swapWith(n)}}}var I,L;class Ut extends w{constructor(t=50){super();p(this,I,0);p(this,L,100+Math.random()*25);r(this,"dispersionRate");this.dispersionRate=t}step({cell:t,grid:s}){var u,c;let n=!1;const a=[-1,1];Math.random()>=.5&&a.reverse(),t.isSleeping()&&a.every(f=>{const d=t.getNeighbourInDirection(new m(f,0));return d!=null&&d.empty?(t.swapWith(d),!1):!0}),h(this,I)<=h(this,L)?a.every(f=>(s.getPositionsInLine(t.position,t.position.add(new m(f*this.dispersionRate,0)),{excludeStart:!0}).every(d=>{const v=s.getAtPosition(d);return v!=null&&v.empty?(t.swapWith(v),n=!0,tt(this,I)._++,!1):!(v instanceof X)}),!n)):((u=t.dir.W())!=null&&u.empty||(c=t.dir.E())!=null&&c.empty)&&t.die()}}I=new WeakMap,L=new WeakMap;class Kt extends w{constructor(t=.05){super();r(this,"survivalChance");this.survivalChance=t}step({cell:t}){if(Math.random()<this.survivalChance)return;t.getNeighbourhood().map(a=>a instanceof T?1:0).reduce((a,u)=>a+u)>2&&t.die()}}var G;class Qt extends w{constructor(t=.05,s=5){super();r(this,"eatChance");r(this,"starveTime");p(this,G,0);this.eatChance=t,this.starveTime=s}step({cell:t,deltaTime:s}){if(g(this,G,h(this,G)+s),h(this,G)>this.starveTime){t.die();return}if(Math.random()>this.eatChance)return;const n=t.getNeighbourhood().filter(a=>a&&!(a!=null&&a.empty)&&a instanceof bt);if(n.length>0){const a=n[Math.floor(Math.random()*n.length)];if(!a)return;a.die(),g(this,G,0)}}}G=new WeakMap;class Zt extends w{constructor(t=.005){super();r(this,"erosionFactor");this.erosionFactor=t}step({cell:t}){if(this.erosionFactor>0){const s=t.dir.S();s instanceof C&&Math.random()<this.erosionFactor&&t.swapWith(s)}}}class $t extends w{constructor(t,s=1){super();r(this,"maxAge");r(this,"survivalChance");this.maxAge=t,this.survivalChance=s}step({cell:t}){Math.random()<this.survivalChance||t.age>this.maxAge&&t.die()}}class Y extends X{constructor(t,s){super(t,{shouldTryAwakeNeighbours:!1,...s});r(this,"brushSize",2);r(this,"brushFillRate",1);this.sleep()}awake(){}step(){}}var N,O;class yt extends w{constructor(t=new m(0,9)){super();p(this,N,0);p(this,O,100);r(this,"isFalling",!1);r(this,"gravity");this.gravity=t}step({cell:t,grid:s,deltaTime:n}){let a=!1;const u=[-1,1];if(Math.random()>=.5&&u.reverse(),t.isSleeping()){const c=t.getNeighbourInDirection(this.gravity.y<0?m.up():m.down());c!=null&&c.empty&&(t.swapWith(c),a=!0,this.isFalling=!0)}else{t.velocity=t.velocity.add(this.gravity.multiplyScalar(n));let c=t;t.getLineTo(t.position.add(t.velocity),{excludeStart:!0}).every(f=>{const d=s.get(f);if(!(d!=null&&d.empty)){if(this.isFalling&&(d instanceof Y||d instanceof C)){const v=t.velocity.subtract((d==null?void 0:d.velocity)||m.zero()).abs(),J=Math.random()*.2,U=Math.random()*.05;v.length()>0&&(t.velocity=new m(t.velocity.x+(Math.random()<.5?-1:1)*v.y*J,-v.y*U),c=t,this.isFalling=!1)}return!1}return c=d,!0}),c!==t?(t.swapWith(c),a=!0):u.every(f=>{const d=t.getNeighbourInDirection(new m(f,1));return d!=null&&d.empty?(t.swapWith(d),a=!0,!1):!0})}a?(u.every(c=>{const f=t.getNeighbourInDirection(new m(c,0));return f!=null&&f.empty||f==null||f.awake(),!0}),g(this,N,0)):(this.isFalling=!1,tt(this,N)._++,h(this,N)>=h(this,O)&&t.sleep())}}N=new WeakMap,O=new WeakMap;class te extends w{constructor(t=.05,s=1,n=2){super();r(this,"jumpChance");r(this,"jumpHeight");r(this,"jumpLength");this.jumpChance=t,this.jumpHeight=s,this.jumpLength=n}step({cell:t}){if(Math.random()>this.jumpChance)return;const s=(Math.random()*2-1)*this.jumpLength,n=-Math.random()*this.jumpHeight;t.velocity=new m(s,n),Math.random()<.1&&(t.velocity=t.velocity.multiplyScalar(1.2)),t.awake()}}class ee extends w{step({cell:e}){if(!e.isSleeping()||Math.random()<.995)return;e.getNeighbourhood().map(n=>n===void 0?1:n.empty?.5:n instanceof St?-1:n instanceof X?2:n instanceof T?1:0).reduce((n,a)=>n+a)>0&&e.die()}}class st extends C{constructor(t,s){super(t,s);r(this,"name","flea");r(this,"_r",Math.random()*20);r(this,"color",[0,this._r,0,255]);r(this,"brushFillRate",.005);const n=7;this.addBehaviors(new te,new Yt(()=>new st(t),2,n,.1),new Mt,new Kt(.95),new Qt,new Jt)}die(){this.grid.setAtIndex(this.index,new se(this,this.grid))}}class se extends C{constructor(t,s,n){super(s,n);r(this,"name","dead flea");r(this,"_r",Math.random()*20+10);r(this,"color");this.color=[...t.color.slice(0,3).map(a=>a+this._r),255],this.addBehaviors(new V(.05),new $t(10,.995))}}class bt extends Y{constructor(){super(...arguments);r(this,"name","leaf");r(this,"_r",Math.random()*20);r(this,"color",[100-this._r,180-this._r,100-this._r,255-this._r]);r(this,"brushFillRate",.4)}}function re(i){const[e,t,s]=i,n=t*Math.min(s,1-s),a=u=>{const c=(u+e/30)%12;return s-n*Math.max(Math.min(c-3,9-c,1),-1)};return[Math.round(a(0)*255),Math.round(a(8)*255),Math.round(a(4)*255)]}var j,z;class Ct extends w{constructor(t){super();r(this,"isGlittering",!1);r(this,"glitterChance");r(this,"glitterMaxTime");r(this,"glitterColor");p(this,j,void 0);p(this,z,0);const{glitterChance:s,glitterMaxTime:n,glitterColor:a}={glitterChance:2e-4,glitterMaxTime:.1,glitterColor:[255,255,255,255],...t};this.glitterChance=s,this.glitterMaxTime=n,this.glitterColor=a}step({cell:t,deltaTime:s}){this.isGlittering?(g(this,z,h(this,z)+s),h(this,z)>this.glitterMaxTime&&(h(this,j)&&(t.color=h(this,j),g(this,j,void 0)),this.isGlittering=!1)):Math.random()<this.glitterChance&&(g(this,j,t.color),t.color=this.glitterColor,this.isGlittering=!0)}}j=new WeakMap,z=new WeakMap;class ie extends C{constructor(t,s){super(t,s);r(this,"name","magic dust");r(this,"color",[...re([Date.now()/20%360,.6,.5]),255]);this.addBehaviors(new V,new Ct)}}class ne extends C{constructor(t,s){super(t,s);r(this,"name","sand");r(this,"_r",Math.random()*20);r(this,"color",[191-this._r,155-this._r,123-this._r,255]);this.addBehaviors(new V)}}class kt extends xt{constructor(e,t){super(e,{dispersionRate:8,gravity:new m(0,-.25),erosionFactor:0,shouldTryAwakeNeighbours:!1,...t}),this.addBehaviors(new Mt(.2)),this.velocity=this.velocity.add(m.random().multiplyScalar(2).add(m.one().multiplyScalar(-1)).multiplyScalar(.025).multiply(m.right()))}}class ae extends kt{constructor(){super(...arguments);r(this,"name","smoke");r(this,"color",[90,90,90,Math.round(Math.random()*185)+70])}}class St extends C{constructor(t,s){super(t,s);r(this,"name","snow");r(this,"_r",Math.random()*20);r(this,"color",[220-this._r,220-this._r,255,255]);this.addBehaviors(new ee,new V(.05))}getRGBA(){return this.isSleeping()?this.color:[220,220,255,255]}die(){this.grid.set(this.position,Math.random()<.25?new rt(this.grid):new P(this.grid))}}class Ft extends kt{constructor(){super(...arguments);r(this,"name","steam");r(this,"_r",Math.round(Math.random()*80)+100);r(this,"color",[255,255,255,this._r])}die(){this.grid.set(this.position,Math.random()<.05?new rt(this.grid):new P(this.grid))}}class oe extends Y{constructor(){super(...arguments);r(this,"name","stone");r(this,"color",[100,100,100,255])}}class rt extends T{constructor(t,s){super(t,{...s,dispersionRate:3});r(this,"name","water");r(this,"_r",Math.round(Math.random()*100)+155);r(this,"color",[46,137,255,this._r]);this.addBehaviors(new Ct({glitterColor:[86,177,255,255]}))}die(){this.grid.set(this.position,Math.random()<.25?new Ft(this.grid):new P(this.grid))}}class he extends Y{constructor(){super(...arguments);r(this,"name","wood");r(this,"_r",Math.random()*20);r(this,"color",[180-this._r,100-this._r,100-this._r,255-this._r])}}var b,D,q,Rt;class ue{constructor(e){p(this,q);p(this,b,void 0);p(this,D,!0);r(this,"materialPalette");g(this,b,new Xt({...e,createEmpty:t=>new P(t)})),this.materialPalette=ft(this,q,Rt).call(this,h(this,b))}isRunning(){return h(this,D)}start(){g(this,D,!0)}stop(){g(this,D,!1)}restart(){this.stop(),h(this,b).clear(),this.start()}getGrid(){return h(this,b)}step(e){if(!h(this,D))return;h(this,b).forEach(s=>{s.empty||s.step(e)},{alternateRowDirections:!0})}}b=new WeakMap,D=new WeakMap,q=new WeakSet,Rt=function(e){return{empty:()=>new P(e),flea:()=>new st(e),leaf:()=>new bt(e),magicDust:()=>new ie(e),sand:()=>new ne(e),smoke:()=>new ae(e),snow:()=>new St(e),steam:()=>new Ft(e),stone:()=>new oe(e),water:()=>new rt(e),wood:()=>new he(e)}};function me(){var ut;const t=M.useRef(),s=M.useRef(),n=M.useRef(),a=M.useRef(),u=M.useRef(void 0),[c,f]=E(!0),[d,v]=E(!1),[J,U]=E([0,0]),[K,At]=E("sand"),[it,jt]=M.useState([0]),[nt,Dt]=E(!1),[_t,Wt]=M.useState(void 0),[Gt,Nt]=M.useState([]);M.useEffect(()=>(t.current=new ue({width:320,height:180}),s.current=t.current.getGrid(),Nt(gt.keys(t.current.materialPalette)),ht(),n.current=requestAnimationFrame(at),()=>{n.current!==void 0&&cancelAnimationFrame(n.current)}),[]),M.useEffect(()=>{const o=t.current;o&&(c.current?o.start():o.stop())},[c.current]);function Pt(o){o.preventDefault()}function Tt(o){const y=o.target,{x:k,y:S,width:F,height:ct}=y.getBoundingClientRect(),R=[(o.clientX-k)/F,(o.clientY-S)/ct];U(R);const A=t.current;if(!A)return;const _=A.getGrid(),dt=new m(Math.floor(R[0]*_.width),Math.floor(R[1]*_.height)),B=_.getAtPosition(dt);B&&Wt(B.name)}function at(o){if(a.current===void 0)a.current=o;else{const y=(o-a.current)/1e3;{const k=t.current;if(!k)return;const S=k.getGrid();Et(S),k.step(y),a.current=o,jt(F=>[...F.slice(F.length-100),1/y])}}n.current=requestAnimationFrame(at)}function Bt(){v(!0)}function ot(){v(!1),u.current=void 0}function Et(o){if(!d.current||!K.current)return;const[y,k]=J.current,S=new m(Math.floor(y*o.width),Math.floor(k*o.height)),F=t.current;if(!F)return;const R=F.materialPalette[K.current];if(!R)return;const A=R(),_=Math.floor(A.brushSize);(u.current?o.getPositionsInLine(u.current,S):[S]).every(B=>{for(let Q=-_;Q<A.brushSize;Q++)for(let Z=-_;Z<A.brushSize;Z++){if(Math.random()>A.brushFillRate)continue;const lt=B.x+Z;if(lt<0)continue;const mt=B.y+Q;mt<0||o.setAtPosition(new m(lt,mt),R())}return!0}),u.current=S}function ht(){const o=t.current;o&&o.restart()}return l.jsxs("div",{className:"route sand",children:[l.jsxs("div",{className:"materials",children:[l.jsxs("div",{children:[l.jsx("button",{onClick:()=>f(o=>!o),children:c.current?l.jsxs(l.Fragment,{children:[l.jsx(zt,{}),"stop"]}):l.jsxs(l.Fragment,{children:[l.jsx(Lt,{}),"start"]})}),l.jsxs("button",{onClick:()=>ht(),children:[l.jsx(Ot,{}),"reset"]})]}),l.jsx("div",{className:"separator"}),gt.map(Gt,o=>l.jsx("div",{className:"material",children:o,onClick:()=>At(o),style:K.current===o?{border:"1px solid white"}:void 0},o)),l.jsx("div",{className:"separator"}),l.jsxs("div",{children:[l.jsx("input",{id:"debugDraw",type:"checkbox",checked:nt.current,onChange:o=>Dt(o.target.checked)}),l.jsx("label",{htmlFor:"debugDraw",children:"debugDraw"})]}),l.jsx("div",{className:"separator"}),l.jsxs("div",{style:{width:"60px",whiteSpace:"nowrap"},children:["fps: ",Math.round(it.reduce((o,y)=>o+y)/it.length||1)]})]}),l.jsx(qt,{grid:(ut=t.current)==null?void 0:ut.getGrid(),onMouseDown:Bt,onMouseUp:ot,onMouseLeave:ot,onMouseMove:Tt,onContextMenu:Pt,pickColor:o=>nt.current&&!o.isSleeping()?[255,255,255,255]:o.getRGBA(),children:l.jsx("div",{style:{position:"absolute",top:0,right:0,padding:"0.25em",fontSize:"0.8em"},children:_t})})]})}export{me as default};

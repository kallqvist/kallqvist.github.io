var Et=Object.defineProperty;var Rt=(r,t,e)=>t in r?Et(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var y=(r,t,e)=>(Rt(r,typeof t!="symbol"?t+"":t,e),e),lt=(r,t,e)=>{if(!t.has(r))throw TypeError("Cannot "+e)};var s=(r,t,e)=>(lt(r,t,"read from private field"),e?e.call(r):t.get(r)),g=(r,t,e)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,e)},f=(r,t,e,i)=>(lt(r,t,"write to private field"),i?i.call(r,e):t.set(r,e),e);var xt=(r,t,e,i)=>({set _(n){f(r,t,n,e)},get _(){return s(r,t,i)}}),J=(r,t,e)=>(lt(r,t,"access private method"),e);import{r as w,j as dt,_ as zt}from"./index-NepP2luA.js";import"./react-spring_web.modern-nqxZiJqR.js";function vt(r){const[t,e]=w.useState(r),i=w.useRef(t);return[i,o=>{o instanceof Function?(i.current=o(i.current),e(o)):(i.current=o,e(o))}]}class Ct{constructor(t){y(this,"grid");y(this,"index");y(this,"position");y(this,"dir",{NW:()=>this.getNeighbourInDirection(I.NW),N:()=>this.getNeighbourInDirection(I.N),NE:()=>this.getNeighbourInDirection(I.NE),E:()=>this.getNeighbourInDirection(I.E),SE:()=>this.getNeighbourInDirection(I.SE),S:()=>this.getNeighbourInDirection(I.S),SW:()=>this.getNeighbourInDirection(I.SW),W:()=>this.getNeighbourInDirection(I.W)});this.grid=t,this.index=-1,this.position=h.create(0,0)}getNeighbourInDirection(t){if(this.position)return this.grid.getAtXY(this.position.x+t.x,this.position.y+t.y)}getNeighbourhood(){const t=[];return Nt.forEach(e=>{const i=this.getNeighbourInDirection(e);t.push(i)}),t}getLineTo(t,e){return this.grid.getCellsInLine(this.position,t,e)}swapWith(t){this.grid.swap(this,t)}getRGBA(){return[0,0,0,0]}}var At=function(){function r(t){this._value=NaN,typeof t=="string"?this._seed=this.hashCode(t):typeof t=="number"?this._seed=this.getSafeSeed(t):this._seed=this.getSafeSeed(r.MIN+Math.floor((r.MAX-r.MIN)*Math.random())),this.reset()}return r.prototype.next=function(t,e){return t===void 0&&(t=0),e===void 0&&(e=1),this.recalculate(),this.map(this._value,r.MIN,r.MAX,t,e)},r.prototype.nextInt=function(t,e){return t===void 0&&(t=10),e===void 0&&(e=100),this.recalculate(),Math.floor(this.map(this._value,r.MIN,r.MAX,t,e+1))},r.prototype.nextString=function(t,e){t===void 0&&(t=16),e===void 0&&(e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789");for(var i="";i.length<t;)i+=this.nextChar(e);return i},r.prototype.nextChar=function(t){return t===void 0&&(t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"),t.substr(this.nextInt(0,t.length-1),1)},r.prototype.nextArrayItem=function(t){return t[this.nextInt(0,t.length-1)]},r.prototype.nextBoolean=function(){return this.recalculate(),this._value>.5},r.prototype.skip=function(t){for(t===void 0&&(t=1);t-- >0;)this.recalculate()},r.prototype.reset=function(){this._value=this._seed},r.prototype.recalculate=function(){this._value=this.xorshift(this._value)},r.prototype.xorshift=function(t){return t^=t<<13,t^=t>>17,t^=t<<5,t},r.prototype.map=function(t,e,i,n,o){return(t-e)/(i-e)*(o-n)+n},r.prototype.hashCode=function(t){var e=0;if(t)for(var i=t.length,n=0;n<i;n++)e=(e<<5)-e+t.charCodeAt(n),e|=0,e=this.xorshift(e);return this.getSafeSeed(e)},r.prototype.getSafeSeed=function(t){return t===0?1:t},r.MIN=-2147483648,r.MAX=2147483647,r}();const Mt=new At,yt=()=>Mt.next();var L,W;class kt{constructor(t,e){g(this,L,void 0);g(this,W,void 0);f(this,L,t),f(this,W,e)}set(t,e){t&&f(this,L,t),e&&f(this,W,e)}get position(){return s(this,L)}get size(){return s(this,W)}get area(){return s(this,W).x*s(this,W).y}toArray(){return[...s(this,L).toArray(),...s(this,W).toArray()]}}L=new WeakMap,W=new WeakMap;const a=class a{constructor(t=0,e=0){y(this,"x");y(this,"y");this.x=t,this.y=e}clone(){return new a(this.x,this.y)}setXY(t,e){this.x=t,this.y=e}set(t){this.x=t.x,this.y=t.y}add(t){return this.x=this.x+t.x,this.y=this.y+t.y,this}addScalar(t){return this.x=this.x+t,this.y=this.y+t,this}subtract(t=a.zero){return this.x=this.x-t.x,this.y=this.y-t.y,this}subtractScalar(t){return this.x=this.x-t,this.y=this.y-t,this}multiply(t){return this.x=this.x*t.x,this.y=this.y*t.y,this}multiplyScalar(t){return this.x=this.x*t,this.y=this.y*t,this}divide(t){return this.x=this.x/t.x,this.y=this.y/t.y,this}divideScalar(t){return this.x=this.x/t,this.y=this.y/t,this}mod(t){return this.x=this.x%t.x,this.y=this.y%t.y,this}modScalar(t){return this.x=this.x%t,this.y=this.y%t,this}abs(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}frac(){return this.subtract(this.clone().floor())}normalize(){const t=this.length();return t===0?this:this.multiplyScalar(1/t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}dot(t){const e=a.multiply(this,t);return e.x+e.y}isEqual(t){return this.x===t.x&&this.y===t.y}isNear(t,e=.001){const i=a.subtract(this,t).abs();return i.x<=e&&i.y<=e}isLessThan(t){return a.isLessThan(this,t)}isGreaterThan(t){return a.isGreaterThan(this,t)}toArray(){return[this.x,this.y]}join(t){return this.toArray().join(t)}static create(t=0,e=0){return new a(t,e)}static add(t,e){return new a(t.x+e.x,t.y+e.y)}static addScalar(t,e){return new a(t.x+e,t.y+e)}static subtract(t,e=a.zero){return new a(t.x-e.x,t.y-e.y)}static subtractScalar(t,e){return new a(t.x-e,t.y-e)}static multiply(t,e){return new a(t.x*e.x,t.y*e.y)}static multiplyScalar(t,e){return new a(t.x*e,t.y*e)}static divide(t,e){return new a(t.x/e.x,t.y/e.y)}static divideScalar(t,e){return new a(t.x/e,t.y/e)}static mod(t,e){return new a(t.x%e.x,t.y%e.y)}static modScalar(t,e){return new a(t.x%e,t.y%e)}static abs(t){return new a(Math.abs(t.x),Math.abs(t.y))}static round(t){return new a(Math.round(t.x),Math.round(t.y))}static floor(t){return new a(Math.floor(t.x),Math.floor(t.y))}static ceil(t){return new a(Math.ceil(t.x),Math.ceil(t.y))}static frac(t){return a.subtract(t,a.floor(t))}static isLessThan(t,e){return t.x<e.x||t.y<e.y}static isGreaterThan(t,e){return t.x>e.x||t.y>e.y}static length(t){return Math.sqrt(t.x*t.x+t.y*t.y)}static normalize(t){const e=t.length();return e===0?t:a.multiplyScalar(t,1/e)}static dot(t,e){const i=a.multiply(t,e);return i.x+i.y}static isEqual(t,e){return t.x===e.x&&t.y===e.y}static isNear(t,e,i=.001){const n=a.subtract(t,e).abs();return n.x<=i&&n.y<=i}static min(...t){return new a(Math.min(...t.map(e=>e.x)),Math.min(...t.map(e=>e.y)))}static max(...t){return new a(Math.max(...t.map(e=>e.x)),Math.max(...t.map(e=>e.y)))}static from(t){return new a(t.x,t.y)}static fromArray([t,e]){return new a(t,e)}static random(){return new a(yt(),yt())}};y(a,"zero",Object.freeze(new a)),y(a,"one",Object.freeze(new a(1,1))),y(a,"up",Object.freeze(new a(0,-1))),y(a,"down",Object.freeze(new a(0,1))),y(a,"left",Object.freeze(new a(-1,0))),y(a,"right",Object.freeze(new a(1,0))),y(a,"negativeInfinity",Object.freeze(new a(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY))),y(a,"positiveInfinity",Object.freeze(new a(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY)));let h=a;const I=Object.freeze({NW:h.create(-1,-1),N:h.up,NE:h.create(1,-1),E:h.right,SE:h.one,S:h.down,SW:h.create(-1,1),W:h.left}),Nt=[I.NW,I.N,I.NE,I.W,I.E,I.SW,I.S,I.SE];var X,Y;class wt extends kt{constructor(){super(h.positiveInfinity.clone(),h.negativeInfinity.clone());g(this,X,!1);g(this,Y,void 0);f(this,Y,h.negativeInfinity.clone())}get area(){return s(this,X)?super.area:0}haveChanges(){return s(this,X)}reset(){this.position.set(h.positiveInfinity),this.size.set(h.negativeInfinity),s(this,Y).set(h.negativeInfinity),f(this,X,!1)}registerPoint(e){this.position.min(e),s(this,Y).max(e),this.size.set(h.subtract(s(this,Y),this.position).addScalar(1)),f(this,X,!0)}}X=new WeakMap,Y=new WeakMap;var N,et,it,gt;class pt{constructor(t){g(this,it);y(this,"size");y(this,"alternateRows");y(this,"createEmpty");y(this,"grid");g(this,N,void 0);g(this,et,0);const{size:e,alternateRows:i,createEmpty:n}={alternateRows:!1,...t};if(!h.frac(e).isEqual(h.zero))throw new Error(`Grid size must be integers (${e.toArray().join(", ")})`);this.grid=[],f(this,N,new wt),this.size=e,this.alternateRows=i,this.createEmpty=n?()=>n(this):()=>new Ct(this),J(this,it,gt).call(this)}clear(){J(this,it,gt).call(this),this.resetChanges()}indexOf(t){return t?t.index:-1}positionOf(t){if(t)return t.position}forEach(t,e){const{alternateRowDirections:i,evenRows:n,oddRows:o,evenCols:c,oddCols:l,startRow:d,endRow:k,startCol:E,endCol:m}={evenRows:!0,oddRows:!0,evenCols:!0,oddCols:!0,...e},v=new Set,O=(S,R)=>{const x=this.xy2index(S,R),u=this.grid[x];u&&(v.has(u)||(t(u,x),v.add(u)))};for(let S=d||0;S<(k||this.size.y);S++){const R=S%2;if(!(R===0&&!n)&&!(R===1&&!o)){if(i&&S%2===0){for(let x=(m||this.size.x)-1;x>=(E||0);x--){const u=x%2;u===0&&!c||u===1&&!l||O(x,S)}continue}for(let x=E||0;x<(m||this.size.x);x++){const u=x%2;u===0&&!c||u===1&&!l||O(x,S)}}}}map(t){return this.grid.map(t)}mapChanged(t){return this.getAllChanges().map(t)}getAllChanges(t=!1){const e=[];return this.forEachChanged(i=>e.push(i),t),e}countChanges(){return s(this,N).area}forEachChanged(t,e=!1){if(!s(this,N).haveChanges())return;const i=s(this,N).position.clone(),n=s(this,N).position.clone().add(s(this,N).size);this.forEach(t,{startRow:i.y,endRow:n.y,startCol:i.x,endCol:n.x}),e&&this.resetChanges()}registerChanged(t){t&&s(this,N).registerPoint(t.position)}resetChanges(){s(this,N).reset()}xy2index(t,e){return t<0||t>=this.size.x||e<0||e>=this.size.y?-1:t+e*this.size.x}position2index(t){const{x:e,y:i}=t;return this.xy2index(e,i)}index2position(t){const e=Math.floor(t/this.size.x),i=t-e*this.size.x;return h.create(i,e)}get(t){return this.getAtPosition(t)}set(t,e){this.setAtPosition(t,e)}getCellsInLine(t,e,i){const{excludeStart:n,excludeEnd:o,maxSteps:c}={maxSteps:s(this,et),...i},l=e.x-t.x,d=e.y-t.y;if(l===0&&d===0){const C=this.getAtPosition(t);return C?[C]:[]}const k=l<0?-1:1,E=d<0?-1:1,m=Math.abs(l),v=Math.abs(d),O=m>=v,S=Math.min(m,v),R=Math.max(m,v),x=S/R,u=[],$=n?1:0,P=o?R:R+1,T=P-$,ft=c!==void 0&&T>c?Math.floor(T/c):1;for(let C=$;C<P;C+=ft){const V=Math.round(C*x);if(O){const p=this.getAtXY(t.x+C*k,t.y+V*E);p&&u.push(p)}else{const p=this.getAtXY(t.x+V*k,t.y+C*E);p&&u.push(p)}}return u}getAtXY(t,e){const i=this.xy2index(t,e);if(i!==-1)return this.getAtIndex(i)}getAtPosition(t){const e=this.position2index(t);if(e!==-1)return this.getAtIndex(e)}setAtPosition(t,e){if(t.x<0||t.x>=this.size.x||t.y<0||t.y>=this.size.y)return;const i=this.position2index(t);this.setAtIndex(i,e)}getAtIndex(t){if(t%1!==0)throw new Error(`not int: ${t}`);return this.grid[t]}swap(t,e){const i=this.indexOf(t),n=this.indexOf(e);if(i===-1||n===-1)throw new Error("Can't swap unless both cells exists in the grid");const o=this.grid[i];this.setAtIndex(i,this.grid[n]),this.setAtIndex(n,o)}setAtIndex(t,e){if(t<0)throw new Error(`invalid index: ${t}`);e.index=t,e.position=this.index2position(t),this.grid[t]=e,this.registerChanged(e)}}N=new WeakMap,et=new WeakMap,it=new WeakSet,gt=function(){const t=this.size.x*this.size.y;this.grid.length=t;for(let e=0;e<t;e++)this.setAtIndex(e,this.createEmpty());f(this,et,this.size.length())};var b;class Dt extends Ct{constructor(e,i){super(e);y(this,"parent");g(this,b,void 0);this.parent=i,f(this,b,new wt)}get dirtyRect(){return s(this,b)}forEachDirty(e,i){if(!s(this,b).haveChanges())return;const{resetChanges:n,...o}={resetChanges:!1,...i},c=s(this,b).position.clone(),l=s(this,b).position.clone().add(s(this,b).size);n&&this.resetChanges(),this.parent.forEach(e,{startRow:c.y,endRow:l.y,startCol:c.x,endCol:l.x,...o})}forEach(e,i){const n=this.parent.chunkSize,o=h.multiply(this.position,n),c=h.multiply(this.position,n).add(n);this.parent.forEach(e,{startRow:o.y,endRow:c.y,startCol:o.x,endCol:c.x,...i})}haveChanges(){return s(this,b).haveChanges()}countChanges(){return s(this,b).haveChanges()?s(this,b).area:0}registerChange(e){s(this,b).registerPoint(e.position)}resetChanges(){s(this,b).reset()}}b=new WeakMap;function Ot(r){return new Worker("/assets/worker-G1OrwRg-.js",{name:r==null?void 0:r.name})}var A,K,B,st,at,St,ht,It,ot,bt;class Pt extends pt{constructor(e){const{chunkSize:i,workerize:n,...o}=e;super(o);g(this,at);g(this,ht);g(this,ot);y(this,"chunkSize",h.create(64,64));g(this,A,void 0);g(this,K,void 0);g(this,B,void 0);g(this,st,[]);this.chunkSize=i||h.create(64,64);try{f(this,A,new pt({size:h.divide(this.size,this.chunkSize),createEmpty:c=>new Dt(c,this)}))}catch{throw new Error(`Grid must be evenly divisible by chunk size: ${h.divide(this.size,this.chunkSize).toArray().join(", ")}`)}f(this,K,n||!1),s(this,K)&&(f(this,B,new Ot),s(this,B).onmessage=this.handleWorkerResponse),J(this,at,St).call(this)}registerChanged(e){if(!e||e.index<0||e.index>=this.grid.length)return;const i=this.chunkOf(e);i&&i.registerChange(e)}resetChanges(){super.resetChanges(),this.forEachChunk(e=>e.resetChanges())}countChanges(){return this.mapChunks(e=>e.countChanges()).reduce((e,i)=>e+i)}getAllChanges(){const e=[];return this.forEachChanged(i=>e.push(i)),e}forEachChanged(e,i){this.forEachChunk(n=>{n.haveChanges()&&n.forEachDirty(e,{resetChanges:i})})}chunkOf(e){if(!e||!this.chunkSize)return;const i=h.divide(e.position,this.chunkSize).floor();return s(this,A).get(i)}getChunk(e){return s(this,A).get(e)}forEachChunk(e,i){s(this,A).forEach(e,i)}mapChunks(e){return s(this,A).map(e)}forEachChangedChunkPass(e,i=!0){this.forEachChunkPass(n=>{const o=n.filter(c=>c.haveChanges());o.length!==0&&(e(o),i&&o.forEach(c=>c.resetChanges()))})}forEachChunkPass(e){s(this,st).forEach((i,n)=>{s(this,K)?J(this,ot,bt).call(this,()=>e(i,n)):e(i,n)})}handleWorkerResponse(e){console.log("worker says:",this,e.data)}}A=new WeakMap,K=new WeakMap,B=new WeakMap,st=new WeakMap,at=new WeakSet,St=function(){for(let e=0;e<s(this,A).size.x*s(this,A).size.y;e++)s(this,A).setAtIndex(e,s(this,A).createEmpty());J(this,ht,It).call(this)},ht=new WeakSet,It=function(){const e=[[!1,!1],[!1,!0],[!0,!1],[!0,!0]],i=[];e.forEach(([n,o])=>{const c=[];this.forEachChunk(l=>{c.push(l)},{evenRows:!n,oddRows:n,evenCols:!o,oddCols:o}),i.push(c)}),f(this,st,i)},ot=new WeakSet,bt=function(e){s(this,B)&&s(this,B).postMessage({f:e})};class Yt{constructor(t){y(this,"grid");const{gridOptions:e}=t;this.grid=this.createGrid(e)}clear(){this.grid.clear()}}class Wt{}var Q,ut;const ct=class ct extends Wt{constructor(e){super();g(this,Q,0);g(this,ut,100);y(this,"gravity");y(this,"sideStep");y(this,"bounce");const{gravity:i,sideStep:n,bounce:o}={gravity:ct.defaultGravity,sideStep:!0,bounce:!0,...e};this.gravity=i,this.sideStep=n,this.bounce=o}step({cell:e,deltaTime:i}){let n=!1;const o=[-1,1];yt()>=.5&&o.reverse();const c=e.getNeighbourInDirection(this.gravity.y<0?h.up:h.down);e.isSleeping()?c!=null&&c.empty&&(e.acceleration.add(h.multiplyScalar(this.gravity,i)),n=!0):this.sideStep&&(c!=null&&c.empty?(e.acceleration.add(h.multiplyScalar(this.gravity,i)),n=!0):o.every(l=>{const d=e.getNeighbourInDirection(h.create(l,this.gravity.y<0?-1:1));return d!=null&&d.empty?(e.acceleration.add(h.subtract(d.position,e.position)),n=!0,!1):!0})),n?(f(this,Q,0),o.forEach(l=>{const d=e.getNeighbourInDirection(h.create(l,0));d!=null&&d.empty||d==null||d.awake()})):(xt(this,Q)._++,s(this,Q)>=s(this,ut)&&e.sleep())}};Q=new WeakMap,ut=new WeakMap,y(ct,"defaultGravity",h.create(0,9.81));let mt=ct;function jt(r,t){const{children:e,grid:i,renderOptions:n,pickColor:o,...c}=r,l=w.useRef(null),d=w.useRef(null),k=w.useRef(),[E,m]=vt(!0);w.useImperativeHandle(t,()=>({clear:S,render:R})),w.useEffect(()=>{i&&(S(),R(i,n))},[i]);function v(){return d.current||(d.current=l.current?l.current.getContext("2d"):null,d.current&&(d.current.imageSmoothingEnabled=!1,d.current.translate(.5,.5))),d.current}function O(){if(k.current)return k.current;if(!i)return;const u=v();if(u)return k.current=u.createImageData(...i.size.toArray()),k.current}function S(){const u=O();u&&(u.data.fill(0),m(!0))}function R(u,$){const P={debugDraw:!1,resetChanges:!1,pixelScale:1,...$},{debugDraw:T,resetChanges:ft,pixelScale:C,onDebugDraw:V}=P;if(!u)return;if(l.current){const z=u.size.x,F=u.size.y;(l.current.width!==z||l.current.height!==F)&&(l.current.width=z*C,l.current.height=F*C,d.current=null)}const p=v();if(!p)return;const _=O();if(_){if(E.current===!0?u.forEach(z=>x({grid:u,imageData:_,cell:z})):u.forEachChanged(z=>x({grid:u,imageData:_,cell:z}),ft),C!==1){const z=document.createElement("canvas");z.width=u.size.x,z.height=u.size.y;const F=z.getContext("2d");F==null||F.putImageData(_,0,0),p.drawImage(z,0,0,u.size.x*C,u.size.y*C)}else p.putImageData(_,0,0);T&&(u instanceof Pt&&u.forEachChunkPass((z,F)=>{z.forEach(q=>{p.strokeStyle=q.haveChanges()?"rgba(255, 255, 255, 0.8)":"rgba(0, 0, 0, 0.2)",p.fillStyle=p.strokeStyle,p.lineWidth=1;const tt=h.multiply(q.position,u.chunkSize),nt=h.multiplyScalar(u.chunkSize,C);C!==1&&tt.multiplyScalar(C),p.strokeRect(...tt.toArray(),...nt.toArray()),p.textAlign="right",p.fillText(q.position.toArray().toString(),...h.add(tt,nt).subtractScalar(2).toArray()),p.textAlign="left",p.fillText(F.toString(),...h.add(tt,h.multiply(nt,h.down).add(h.fromArray([2,-2]))).toArray(),nt.x),q.dirtyRect.haveChanges()&&(p.strokeStyle="red",p.fillStyle="red",p.textAlign="left",p.fillText(q.countChanges().toString(),...h.add(tt,h.create(2,10)).toArray()),p.strokeRect(...h.multiplyScalar(q.dirtyRect.position,C).toArray(),...h.multiplyScalar(q.dirtyRect.size,C).toArray()))})}),V&&V(p)),m(!1)}}function x(u){const{imageData:$,cell:P}=u;if(P.index===-1)return;const T=o?o({cell:P}):P.getRGBA();T&&$.data.set(T,P.index*4)}if(i)return dt.jsxs("div",{className:"grid canvas",style:n!=null&&n.debugDraw?{backgroundColor:"rgb(80, 80, 80)"}:void 0,children:[dt.jsx("canvas",{ref:l,...c}),e]})}const Ft=w.forwardRef(jt);var G,U,M,rt,Z,D,H,j;class Gt{constructor(t){g(this,G,void 0);g(this,U,void 0);g(this,M,void 0);y(this,"limitFps");g(this,rt,void 0);g(this,Z,void 0);g(this,D,!0);g(this,H,void 0);g(this,j,void 0);const{gridRenderer:e,renderOptions:i,simulation:n,limitFps:o,resetChanges:c,onStep:l}={resetChanges:!0,...t};f(this,G,e),f(this,U,i),f(this,M,n),this.limitFps=o,f(this,rt,c),f(this,Z,l),this._stepInternal=this._stepInternal.bind(this),f(this,H,requestAnimationFrame(this._stepInternal))}_stepInternal(t){if(s(this,D)&&s(this,j)===void 0)f(this,j,t);else{const e=s(this,j)===void 0?0:(t-s(this,j))/1e3;if((this.limitFps===void 0||e>1/this.limitFps)&&s(this,M)){const i=s(this,M).grid;if(!i)throw new Error("simulation or grid must be provided");s(this,D)&&this.step(e),s(this,Z)&&s(this,Z).call(this,{grid:i,deltaTime:e}),s(this,G)&&s(this,G).render(i,{resetChanges:!1,...s(this,U)}),s(this,D)&&s(this,rt)&&i.resetChanges()}}s(this,D)&&f(this,j,t),f(this,H,requestAnimationFrame(this._stepInternal))}get simulation(){return s(this,M)}destroy(){this.stop(),this.clear(),s(this,H)!==void 0&&cancelAnimationFrame(s(this,H))}start(){s(this,D)||(f(this,D,!0),this._stepInternal(Date.now()))}stop(){f(this,D,!1),f(this,j,void 0)}clear(){var t,e;(t=s(this,M))==null||t.clear(),(e=s(this,G))==null||e.clear()}isRunning(){return s(this,D)}registerSimulation(t){s(this,M)&&(console.error("already have one"),this.destroy()),f(this,M,t)}registerGridRenderer(t,e){f(this,G,t),e&&f(this,U,e)}step(t){s(this,M)&&s(this,M).step(t)}}G=new WeakMap,U=new WeakMap,M=new WeakMap,rt=new WeakMap,Z=new WeakMap,D=new WeakMap,H=new WeakMap,j=new WeakMap;function Tt(r,t){const{isRunning:e,limitFps:i,resetChanges:n,renderOptions:o,children:c,initSimulation:l,onStep:d,...k}={isRunning:!0,resetChanges:!0,...r},E=w.useRef(null),m=w.useRef(null),v=w.useRef(),[O,S]=w.useState(void 0);w.useImperativeHandle(t,()=>m.current),w.useEffect(()=>{var x;if(E.current&&!m.current)return m.current=new Gt({gridRenderer:E.current,simulation:l(),limitFps:i,resetChanges:n,renderOptions:o,onStep:d}),S((x=m.current.simulation)==null?void 0:x.grid),()=>{var u;(u=m.current)==null||u.destroy(),m.current=null,S(void 0)}},[]),w.useEffect(()=>{m.current&&(e?m.current.start():m.current.stop())},[e]),w.useEffect(()=>{var x;E.current&&(zt.isEqual(o,v.current)||(v.current=o,(x=m.current)==null||x.registerGridRenderer(E.current,o)))},[o]);function R(x){x.preventDefault()}return dt.jsx(Ft,{ref:E,renderOptions:o,grid:O,children:c,onContextMenu:R,...k})}const Bt=w.forwardRef(Tt);export{Wt as B,Pt as C,Ct as G,Yt as S,h as V,mt as a,Bt as b,pt as c,Nt as n,yt as r,vt as u};

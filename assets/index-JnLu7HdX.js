var ct=Object.defineProperty;var ft=(n,t,e)=>t in n?ct(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var u=(n,t,e)=>(ft(n,typeof t!="symbol"?t+"":t,e),e),et=(n,t,e)=>{if(!t.has(n))throw TypeError("Cannot "+e)};var r=(n,t,e)=>(et(n,t,"read from private field"),e?e.call(n):t.get(n)),g=(n,t,e)=>{if(t.has(n))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(n):t.set(n,e)},c=(n,t,e,i)=>(et(n,t,"write to private field"),i?i.call(n,e):t.set(n,e),e);var B=(n,t,e)=>(et(n,t,"access private method"),e);import{r as w,j as it,_ as dt}from"./index-YTe7kLxD.js";import"./react-spring_web.modern-HMHinTmJ.js";function lt(n){const[t,e]=w.useState(n),i=w.useRef(t);return[i,a=>{a instanceof Function?(i.current=a(i.current),e(a)):(i.current=a,e(a))}]}class st{constructor(t){u(this,"grid");u(this,"index");u(this,"position");u(this,"dir",{NW:()=>this.getNeighbourInDirection(m.NW),N:()=>this.getNeighbourInDirection(m.N),NE:()=>this.getNeighbourInDirection(m.NE),E:()=>this.getNeighbourInDirection(m.E),SE:()=>this.getNeighbourInDirection(m.SE),S:()=>this.getNeighbourInDirection(m.S),SW:()=>this.getNeighbourInDirection(m.SW),W:()=>this.getNeighbourInDirection(m.W)});this.grid=t,this.index=-1,this.position=new f(0,0)}getNeighbourInDirection(t){if(this.position)return this.grid.getAtPosition(this.position.add(t))}getNeighbourhood(){const t=[];return Ct.forEach(e=>{const i=this.getNeighbourInDirection(e);t.push(i)}),t}getLineTo(t,e){return this.grid.getPositionsInLine(this.position,t,e)}swapWith(t){this.grid.swap(this,t)}getRGBA(){return[0,0,0,0]}}var M,U,nt;class rt{constructor(t){g(this,U);u(this,"size");u(this,"alternateRows");u(this,"createEmpty");u(this,"grid");g(this,M,void 0);const{size:e,alternateRows:i,createEmpty:s}={alternateRows:!1,...t};this.grid=[],c(this,M,new Set([])),this.size=e,this.alternateRows=i,this.createEmpty=s?()=>s(this):()=>new st(this),B(this,U,nt).call(this)}clear(){B(this,U,nt).call(this),this.resetChanges()}indexOf(t){return t?t.index:-1}positionOf(t){if(t)return t.position}forEach(t,e){const{alternateRowDirections:i,evenRows:s,oddRows:a,evenCols:d,oddCols:C,startRow:p,endRow:y,startCol:b,endCol:R}={evenRows:!0,oddRows:!0,evenCols:!0,oddCols:!0,...e},E=new Set,N=(l,v)=>{const S=this.position2index(new f(l,v)),h=this.grid[S];if(!h||E.has(h))return;if(t(h,S)===!1)return!1;E.add(h)};for(let l=p||0;l<=(y||this.size.y-1);l++){const v=l%2;if(v===0&&!s)continue;if(v===1&&!a)continue;let S;if(i&&l%2===0&&Math.random()<.5){for(let h=R||this.size.x-1;h>=(b||0);h--){const I=h%2;if(!(I===0&&!d)&&!(I===1&&!C)&&(S=N(h,l),S===!1))break}if(S===!1)break;continue}for(let h=b||0;h<=(R||this.size.x-1);h++){const I=h%2;if(!(I===0&&!d)&&!(I===1&&!C)&&(S=N(h,l),S===!1))break}if(S===!1)break}}map(t){return this.grid.map(t)}mapChanged(t){return this.getAllChanges().map(t)}getAllChanges(){return[...r(this,M).values()]}countChanges(){return r(this,M).size}forEachChanged(t,e=!1){r(this,M).forEach(t),e&&this.resetChanges()}registerChanged(t){t.index<0||t.index>=this.grid.length||r(this,M).has(t)||r(this,M).add(t)}resetChanges(){r(this,M).clear()}position2index(t){const{x:e,y:i}=t;return e<0||e>=this.size.x||i<0||i>=this.size.y?-1:e+i*this.size.x}index2position(t){const e=Math.floor(t/this.size.x),i=t-e*this.size.x;return new f(i,e)}get(t){return this.getAtPosition(t)}set(t,e){this.setAtPosition(t,e)}getPositionsInLine(t,e,i){const{excludeStart:s,excludeEnd:a,maxSteps:d}={maxSteps:500,...i},C=e.x-t.x,p=e.y-t.y;if(C===0&&p===0)return[t];const y=C<0?-1:1,b=p<0?-1:1,R=Math.abs(C),E=Math.abs(p),N=R>=E,l=Math.min(R,E),v=Math.max(R,E),S=l/v,h=[],I=s?1:0,P=a?v:v+1,T=P-I,x=T>d?Math.round(T/d):1;for(let k=I;k<P;k+=x){const W=Math.round(k*S);N?h.push(new f(t.x+k*y,t.y+W*b)):h.push(new f(t.x+W*y,t.y+k*b))}return h}getAtPosition(t){const e=this.position2index(t);if(e!==-1)return this.getAtIndex(e)}setAtPosition(t,e){if(t.x<0||t.x>=this.size.x||t.y<0||t.y>=this.size.y)return;const i=this.position2index(t);this.setAtIndex(i,e)}getAtIndex(t){return this.grid[t]}swap(t,e){const i=this.indexOf(t),s=this.indexOf(e);if(i===-1||s===-1)throw new Error("Can't swap unless both cells exists in the grid");const a=this.grid[i];this.setAtIndex(i,this.grid[s]),this.setAtIndex(s,a)}setAtIndex(t,e){if(t<0)throw new Error(`invalid index: ${t}`);e.index=t,e.position=this.index2position(t),this.grid[t]=e,this.registerChanged(e)}}M=new WeakMap,U=new WeakSet,nt=function(){const t=this.size.x*this.size.y;this.grid.length=t;for(let e=0;e<t;e++)this.setAtIndex(e,this.createEmpty())};var D,F,q,H;class gt extends st{constructor(e,i){super(e);u(this,"parent");g(this,D,new Set);g(this,F,void 0);g(this,q,void 0);g(this,H,void 0);this.parent=i}get dirtyRect(){return r(this,H)}forEach(e,i){const s=this.parent.chunkSize,a=this.position.multiply(s),d=this.position.multiply(s).add(s).subtractScalar(1);this.parent.forEach(e,{startRow:a.y,endRow:d.y,startCol:a.x,endCol:d.x,...i})}haveChanges(){return r(this,D).size>0}countChanges(){return r(this,D).size}registerChange(e){r(this,D).has(e)||(r(this,D).add(e),c(this,F,f.min(r(this,F)||f.positiveInfinity,e.position)),c(this,q,f.max(r(this,q)||f.negativeInfinity,e.position)),c(this,H,new wt(r(this,F),r(this,q).subtract(r(this,F)))))}resetChanges(){r(this,D).clear(),c(this,F,void 0),c(this,q,void 0),c(this,H,void 0)}forEachChangedCell(e,i=!1){r(this,D).forEach(e),i&&this.resetChanges()}}D=new WeakMap,F=new WeakMap,q=new WeakMap,H=new WeakMap;function pt(n){return new Worker("/assets/worker-G1OrwRg-.js",{name:n==null?void 0:n.name})}var z,J,L,Z,V,ot,_,ht,tt,at;class xt extends rt{constructor(e){const{chunkSize:i,workerize:s,...a}=e;super(a);g(this,V);g(this,_);g(this,tt);u(this,"chunkSize",new f(64,64));g(this,z,void 0);g(this,J,void 0);g(this,L,void 0);g(this,Z,[]);this.chunkSize=i||new f(64,64),c(this,z,new rt({size:this.size.divide(this.chunkSize),createEmpty:d=>new gt(d,this)})),c(this,J,s||!1),r(this,J)&&(c(this,L,new pt),r(this,L).onmessage=this.handleWorkerResponse),B(this,V,ot).call(this)}clear(){super.clear(),this.resetChanges()}registerChanged(e){if(e.index<0||e.index>=this.grid.length)return;const i=this.chunkOf(e);i&&i.registerChange(e)}resetChanges(){super.resetChanges(),this.forEachChunk(e=>e.resetChanges())}countChanges(){return this.mapChunks(e=>e.countChanges()).reduce((e,i)=>e+i)}forEachChanged(e,i){this.forEachChunk(s=>{s.haveChanges()&&s.forEachChangedCell(e,i)})}chunkOf(e){if(!e||!this.chunkSize)return;const i=e.position.divide(this.chunkSize).floor();return r(this,z).get(i)}forEachChunk(e,i){r(this,z).forEach(e,i)}mapChunks(e){return r(this,z).map(e)}forEachChangedChunkPass(e,i=!1){this.forEachChunkPass(s=>{const a=s.filter(d=>d.haveChanges());a.length!==0&&(e(a),i&&a.forEach(d=>d.resetChanges()))})}forEachChunkPass(e){r(this,Z).forEach((i,s)=>{r(this,J)?B(this,tt,at).call(this,()=>e(i,s)):e(i,s)})}handleWorkerResponse(e){console.log("worker says:",this,e.data)}}z=new WeakMap,J=new WeakMap,L=new WeakMap,Z=new WeakMap,V=new WeakSet,ot=function(){for(let e=0;e<r(this,z).size.x*r(this,z).size.y;e++)r(this,z).setAtIndex(e,r(this,z).createEmpty());B(this,_,ht).call(this)},_=new WeakSet,ht=function(){const e=[[!1,!1],[!1,!0],[!0,!1],[!0,!0]],i=[];e.forEach(([s,a])=>{const d=[];this.forEachChunk(C=>{d.push(C)},{evenRows:!s,oddRows:s,evenCols:!a,oddCols:a}),i.push(d)}),c(this,Z,i)},tt=new WeakSet,at=function(e){r(this,L)&&r(this,L).postMessage({f:e})};var yt=function(){function n(t){this._value=NaN,typeof t=="string"?this._seed=this.hashCode(t):typeof t=="number"?this._seed=this.getSafeSeed(t):this._seed=this.getSafeSeed(n.MIN+Math.floor((n.MAX-n.MIN)*Math.random())),this.reset()}return n.prototype.next=function(t,e){return t===void 0&&(t=0),e===void 0&&(e=1),this.recalculate(),this.map(this._value,n.MIN,n.MAX,t,e)},n.prototype.nextInt=function(t,e){return t===void 0&&(t=10),e===void 0&&(e=100),this.recalculate(),Math.floor(this.map(this._value,n.MIN,n.MAX,t,e+1))},n.prototype.nextString=function(t,e){t===void 0&&(t=16),e===void 0&&(e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789");for(var i="";i.length<t;)i+=this.nextChar(e);return i},n.prototype.nextChar=function(t){return t===void 0&&(t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"),t.substr(this.nextInt(0,t.length-1),1)},n.prototype.nextArrayItem=function(t){return t[this.nextInt(0,t.length-1)]},n.prototype.nextBoolean=function(){return this.recalculate(),this._value>.5},n.prototype.skip=function(t){for(t===void 0&&(t=1);t-- >0;)this.recalculate()},n.prototype.reset=function(){this._value=this._seed},n.prototype.recalculate=function(){this._value=this.xorshift(this._value)},n.prototype.xorshift=function(t){return t^=t<<13,t^=t>>17,t^=t<<5,t},n.prototype.map=function(t,e,i,s,a){return(t-e)/(i-e)*(a-s)+s},n.prototype.hashCode=function(t){var e=0;if(t)for(var i=t.length,s=0;s<i;s++)e=(e<<5)-e+t.charCodeAt(s),e|=0,e=this.xorshift(e);return this.getSafeSeed(e)},n.prototype.getSafeSeed=function(t){return t===0?1:t},n.MIN=-2147483648,n.MAX=2147483647,n}();const mt=new yt,bt=()=>mt.next();class wt{constructor(t,e){u(this,"position");u(this,"size");this.position=t,this.size=e}toArray(){return[...this.position.toArray(),...this.size.toArray()]}}const o=class o{constructor(t=0,e=0){u(this,"x");u(this,"y");this.x=t,this.y=e}clone(){return new o(this.x,this.y)}add(t){return new o(this.x+t.x,this.y+t.y)}addScalar(t){return new o(this.x+t,this.y+t)}subtract(t=o.zero){return new o(this.x-t.x,this.y-t.y)}subtractScalar(t){return new o(this.x-t,this.y-t)}multiply(t){return new o(this.x*t.x,this.y*t.y)}multiplyScalar(t){return new o(this.x*t,this.y*t)}divide(t){return new o(this.x/t.x,this.y/t.y)}divideScalar(t){return new o(this.x/t,this.y/t)}mod(t){return new o(this.x%t.x,this.y%t.y)}modScalar(t){return new o(this.x%t,this.y%t)}abs(){return new o(Math.abs(this.x),Math.abs(this.y))}round(){return new o(Math.round(this.x),Math.round(this.y))}floor(){return new o(Math.floor(this.x),Math.floor(this.y))}ceil(){return new o(Math.ceil(this.x),Math.ceil(this.y))}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){const t=this.length();return t===0?o.zero:this.multiplyScalar(1/t)}dot(t){const e=this.multiply(t);return e.x+e.y}isEqual(t){return this.x===t.x&&this.y===t.y}isNear(t,e=.001){const i=this.subtract(t).abs();return i.x<=e&&i.y<=e}toArray(){return[this.x,this.y]}join(t){return this.toArray().join(t)}static min(...t){return new o(Math.min(...t.map(e=>e.x)),Math.min(...t.map(e=>e.y)))}static max(...t){return new o(Math.max(...t.map(e=>e.x)),Math.max(...t.map(e=>e.y)))}static fromArray([t,e]){return new o(t,e)}static random(){return new o(Math.random(),Math.random())}};u(o,"zero",new o),u(o,"one",new o(1,1)),u(o,"up",new o(0,-1)),u(o,"down",new o(0,1)),u(o,"left",new o(-1,0)),u(o,"right",new o(1,0)),u(o,"negativeInfinity",new o(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)),u(o,"positiveInfinity",new o(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY));let f=o;const m={NW:new f(-1,-1),N:new f(0,-1),NE:new f(1,-1),E:new f(1,0),SE:new f(1,1),S:new f(0,1),SW:new f(-1,1),W:new f(-1,0)},Ct=[m.NW,m.N,m.NE,m.W,m.E,m.SW,m.S,m.SE];class Nt{constructor(t){u(this,"grid");const{gridOptions:e}=t;this.grid=this.createGrid(e)}clear(){this.grid.clear()}}function St(n,t){const{children:e,grid:i,debugDraw:s,pickColor:a,...d}={debugDraw:!1,...n},C=w.useRef(null),p=w.useRef(null),y=w.useRef(),[b,R]=lt(!0);w.useImperativeHandle(t,()=>({clear:l,render:v})),w.useEffect(()=>{i&&(l(),v(i))},[i]);function E(){return p.current||(p.current=C.current?C.current.getContext("2d"):null,p.current&&(p.current.imageSmoothingEnabled=!1,p.current.translate(.5,.5))),p.current}function N(){if(y.current)return y.current;if(!i)return;const h=E();if(h)return y.current=h.createImageData(...i.size.toArray()),y.current}function l(){const h=N();h&&(h.data.fill(0),R(!0))}function v(h,I={debugDraw:s}){const{debugDraw:P,resetChanges:T}={debugDraw:!1,resetChanges:!1,...I};if(!h)return;const x=E();if(!x)return;const k=N();k&&(b.current===!0?h.forEach(W=>S({imageData:k,cell:W})):h.forEachChanged(W=>S({imageData:k,cell:W}),T),x.putImageData(k,0,0),P&&h instanceof xt&&h.forEachChunkPass((W,ut)=>{W.forEach(j=>{x.strokeStyle=j.haveChanges()?"rgba(255, 255, 255, 0.8)":"rgba(0, 0, 0, 0.2)",x.fillStyle=x.strokeStyle,x.lineWidth=1;const $=j.position.multiply(h.chunkSize);x.strokeRect(...$.toArray(),...h.chunkSize.toArray()),x.textAlign="right",x.fillText(j.position.toArray().toString(),...$.add(h.chunkSize).subtractScalar(2).toArray()),x.textAlign="left",x.fillText(ut.toString(),...$.add(h.chunkSize.multiply(f.down).add(f.fromArray([2,-2]))).toArray(),h.chunkSize.x),j.dirtyRect&&(x.strokeStyle="red",x.fillStyle="red",x.textAlign="left",x.fillText(j.countChanges().toString(),...$.add(f.fromArray([2,10])).toArray()),x.strokeRect(...j.dirtyRect.position.toArray(),...j.dirtyRect.size.toArray()))})}),R(!1))}function S(h){const{imageData:I,cell:P}=h;if(P.index===-1)return;const T=a?a({cell:P}):P.getRGBA();T&&I.data.set(T,P.index*4)}if(i)return it.jsxs("div",{className:"grid canvas",children:[it.jsx("canvas",{ref:C,width:i.size.x||1,height:i.size.y||1,...d}),e]})}const It=w.forwardRef(St);var G,K,A,Q,O,X,Y;class Et{constructor(t){g(this,G,void 0);g(this,K,void 0);g(this,A,void 0);u(this,"limitFps");g(this,Q,void 0);g(this,O,!0);g(this,X,void 0);g(this,Y,void 0);const{gridRenderer:e,renderOptions:i,simulation:s,limitFps:a,onStep:d}=t;c(this,G,e),c(this,K,i),c(this,A,s),this.limitFps=a,c(this,Q,d),this._stepInternal=this._stepInternal.bind(this),c(this,X,requestAnimationFrame(this._stepInternal))}_stepInternal(t){this.step(t),c(this,X,requestAnimationFrame(this._stepInternal))}get simulation(){return r(this,A)}destroy(){var t,e;this.stop(),(t=r(this,A))==null||t.clear(),(e=r(this,G))==null||e.clear(),r(this,X)!==void 0&&cancelAnimationFrame(r(this,X))}start(){r(this,O)||(c(this,O,!0),this._stepInternal(Date.now()))}stop(){c(this,O,!1)}restart(){this.destroy(),this.start()}isRunning(){return r(this,O)}registerSimulation(t){r(this,A)&&(console.error("already have one"),this.destroy()),c(this,A,t)}registerGridRenderer(t,e){c(this,G,t),e&&c(this,K,e)}step(t){if(r(this,Y)===void 0)c(this,Y,t);else{const e=(t-r(this,Y))/1e3;if(this.limitFps===void 0||e>1/this.limitFps){if(r(this,A)){const i=r(this,A).grid;if(!i)throw new Error("simulation or grid must be provided");r(this,O)&&r(this,A).step(e),r(this,Q)&&r(this,Q).call(this,{grid:i,deltaTime:e}),r(this,G)&&r(this,G).render(i,{resetChanges:!1,...r(this,K)}),i.resetChanges()}c(this,Y,t)}}}}G=new WeakMap,K=new WeakMap,A=new WeakMap,Q=new WeakMap,O=new WeakMap,X=new WeakMap,Y=new WeakMap;function Rt(n,t){var E,N;const{limitFps:e,renderOptions:i,children:s,initSimulation:a,onStep:d,...C}=n,p=w.useRef(null),y=w.useRef(null),b=w.useRef();w.useImperativeHandle(t,()=>y.current),w.useEffect(()=>{if(p.current&&!y.current)return y.current=new Et({gridRenderer:p.current,simulation:a(),limitFps:e,renderOptions:i,onStep:d}),()=>{var l;(l=y.current)==null||l.destroy()}}),w.useEffect(()=>{var l;p.current&&(dt.isEqual(i,b.current)||(b.current=i,(l=y.current)==null||l.registerGridRenderer(p.current,i)))},[i]);function R(l){l.preventDefault()}return it.jsx(It,{ref:p,grid:(N=(E=y.current)==null?void 0:E.simulation)==null?void 0:N.grid,children:s,onContextMenu:R,...C})}const kt=w.forwardRef(Rt);export{xt as C,st as G,Nt as S,f as V,kt as a,rt as b,Ct as n,bt as r,lt as u};

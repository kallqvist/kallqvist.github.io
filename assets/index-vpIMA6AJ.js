var zt=Object.defineProperty;var At=(s,t,e)=>t in s?zt(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var y=(s,t,e)=>(At(s,typeof t!="symbol"?t+"":t,e),e),gt=(s,t,e)=>{if(!t.has(s))throw TypeError("Cannot "+e)};var r=(s,t,e)=>(gt(s,t,"read from private field"),e?e.call(s):t.get(s)),p=(s,t,e)=>{if(t.has(s))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(s):t.set(s,e)},d=(s,t,e,i)=>(gt(s,t,"write to private field"),i?i.call(s,e):t.set(s,e),e);var pt=(s,t,e,i)=>({set _(n){d(s,t,n,e)},get _(){return r(s,t,i)}}),J=(s,t,e)=>(gt(s,t,"access private method"),e);import{i as wt,r as S,j as x,p as Mt,q as kt,s as Nt,t as jt,l as Dt,_ as Ft}from"./index-LFpIyl9S.js";import"./react-spring_web.modern-0VAbX3aJ.js";function te(s){return wt({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{d:"M12 22c4.636 0 8-3.468 8-8.246C20 7.522 12.882 2.4 12.579 2.185a1 1 0 0 0-1.156-.001C11.12 2.397 4 7.503 4 13.75 4 18.53 7.364 22 12 22zm-.001-17.74C13.604 5.55 18 9.474 18 13.754 18 17.432 15.532 20 12 20s-6-2.57-6-6.25c0-4.29 4.394-8.203 5.999-9.49z"},child:[]}]})(s)}function Pt(s){return wt({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{d:"M5.122 21c.378.378.88.586 1.414.586S7.572 21.378 7.95 21l4.336-4.336a7.495 7.495 0 0 0 2.217.333 7.446 7.446 0 0 0 5.302-2.195 7.484 7.484 0 0 0 1.632-8.158l-.57-1.388-4.244 4.243-2.121-2.122 4.243-4.243-1.389-.571A7.478 7.478 0 0 0 14.499 2c-2.003 0-3.886.78-5.301 2.196a7.479 7.479 0 0 0-1.862 7.518L3 16.05a2.001 2.001 0 0 0 0 2.828L5.122 21zm4.548-8.791-.254-.616a5.486 5.486 0 0 1 1.196-5.983 5.46 5.46 0 0 1 4.413-1.585l-3.353 3.353 4.949 4.95 3.355-3.355a5.49 5.49 0 0 1-1.587 4.416c-1.55 1.55-3.964 2.027-5.984 1.196l-.615-.255-5.254 5.256h.001l-.001 1v-1l-2.122-2.122 5.256-5.255z"},child:[]}]})(s)}function Ot(s){const[t,e]=S.useState(s),i=S.useRef(t);return[i,o=>{o instanceof Function?(i.current=o(i.current),e(o)):(i.current=o,e(o))}]}function Gt({id:s,label:t,checked:e,onChange:i}){function n(o){i&&i(o.target.checked)}return x.jsxs("div",{children:[x.jsx("input",{id:s,type:"checkbox",checked:e,onChange:n}),t||s?x.jsx("label",{htmlFor:s,children:t||s}):void 0]})}class St{constructor(t){y(this,"grid");y(this,"index");y(this,"position");y(this,"dir",{NW:()=>this.getNeighbourInDirection(R.NW),N:()=>this.getNeighbourInDirection(R.N),NE:()=>this.getNeighbourInDirection(R.NE),E:()=>this.getNeighbourInDirection(R.E),SE:()=>this.getNeighbourInDirection(R.SE),S:()=>this.getNeighbourInDirection(R.S),SW:()=>this.getNeighbourInDirection(R.SW),W:()=>this.getNeighbourInDirection(R.W)});this.grid=t,this.index=-1,this.position=h.create(0,0)}getNeighbourInDirection(t){if(this.position)return this.grid.getAtXY(this.position.x+t.x,this.position.y+t.y)}getNeighbourhood(){const t=[];return Lt.forEach(e=>{const i=this.getNeighbourInDirection(e);t.push(i)}),t}getLineTo(t,e){return this.grid.getCellsInLine(this.position,t,e)}swapWith(t){this.grid.swap(this,t)}getRGBA(){return[0,0,0,0]}}var Tt=function(){function s(t){this._value=NaN,typeof t=="string"?this._seed=this.hashCode(t):typeof t=="number"?this._seed=this.getSafeSeed(t):this._seed=this.getSafeSeed(s.MIN+Math.floor((s.MAX-s.MIN)*Math.random())),this.reset()}return s.prototype.next=function(t,e){return t===void 0&&(t=0),e===void 0&&(e=1),this.recalculate(),this.map(this._value,s.MIN,s.MAX,t,e)},s.prototype.nextInt=function(t,e){return t===void 0&&(t=10),e===void 0&&(e=100),this.recalculate(),Math.floor(this.map(this._value,s.MIN,s.MAX,t,e+1))},s.prototype.nextString=function(t,e){t===void 0&&(t=16),e===void 0&&(e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789");for(var i="";i.length<t;)i+=this.nextChar(e);return i},s.prototype.nextChar=function(t){return t===void 0&&(t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"),t.substr(this.nextInt(0,t.length-1),1)},s.prototype.nextArrayItem=function(t){return t[this.nextInt(0,t.length-1)]},s.prototype.nextBoolean=function(){return this.recalculate(),this._value>.5},s.prototype.skip=function(t){for(t===void 0&&(t=1);t-- >0;)this.recalculate()},s.prototype.reset=function(){this._value=this._seed},s.prototype.recalculate=function(){this._value=this.xorshift(this._value)},s.prototype.xorshift=function(t){return t^=t<<13,t^=t>>17,t^=t<<5,t},s.prototype.map=function(t,e,i,n,o){return(t-e)/(i-e)*(o-n)+n},s.prototype.hashCode=function(t){var e=0;if(t)for(var i=t.length,n=0;n<i;n++)e=(e<<5)-e+t.charCodeAt(n),e|=0,e=this.xorshift(e);return this.getSafeSeed(e)},s.prototype.getSafeSeed=function(t){return t===0?1:t},s.MIN=-2147483648,s.MAX=2147483647,s}();const Wt=new Tt,xt=()=>Wt.next();var K,W;class Bt{constructor(t,e){p(this,K,void 0);p(this,W,void 0);d(this,K,t),d(this,W,e)}set(t,e){t&&d(this,K,t),e&&d(this,W,e)}get position(){return r(this,K)}get size(){return r(this,W)}get area(){return r(this,W).x*r(this,W).y}toArray(){return[...r(this,K).toArray(),...r(this,W).toArray()]}}K=new WeakMap,W=new WeakMap;const a=class a{constructor(t=0,e=0){y(this,"x");y(this,"y");this.x=t,this.y=e}clone(){return new a(this.x,this.y)}setXY(t,e){this.x=t,this.y=e}set(t){this.x=t.x,this.y=t.y}add(t){return this.x=this.x+t.x,this.y=this.y+t.y,this}addScalar(t){return this.x=this.x+t,this.y=this.y+t,this}subtract(t=a.zero){return this.x=this.x-t.x,this.y=this.y-t.y,this}subtractScalar(t){return this.x=this.x-t,this.y=this.y-t,this}multiply(t){return this.x=this.x*t.x,this.y=this.y*t.y,this}multiplyScalar(t){return this.x=this.x*t,this.y=this.y*t,this}divide(t){return this.x=this.x/t.x,this.y=this.y/t.y,this}divideScalar(t){return this.x=this.x/t,this.y=this.y/t,this}mod(t){return this.x=this.x%t.x,this.y=this.y%t.y,this}modScalar(t){return this.x=this.x%t,this.y=this.y%t,this}abs(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}frac(){return this.subtract(this.clone().floor())}normalize(){const t=this.length();return t===0?this:this.multiplyScalar(1/t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}dot(t){const e=a.multiply(this,t);return e.x+e.y}isEqual(t){return this.x===t.x&&this.y===t.y}isNear(t,e=.001){const i=a.subtract(this,t).abs();return i.x<=e&&i.y<=e}isLessThan(t){return a.isLessThan(this,t)}isGreaterThan(t){return a.isGreaterThan(this,t)}toArray(){return[this.x,this.y]}join(t){return this.toArray().join(t)}static create(t=0,e=0){return new a(t,e)}static add(t,e){return new a(t.x+e.x,t.y+e.y)}static addScalar(t,e){return new a(t.x+e,t.y+e)}static subtract(t,e=a.zero){return new a(t.x-e.x,t.y-e.y)}static subtractScalar(t,e){return new a(t.x-e,t.y-e)}static multiply(t,e){return new a(t.x*e.x,t.y*e.y)}static multiplyScalar(t,e){return new a(t.x*e,t.y*e)}static divide(t,e){return new a(t.x/e.x,t.y/e.y)}static divideScalar(t,e){return new a(t.x/e,t.y/e)}static mod(t,e){return new a(t.x%e.x,t.y%e.y)}static modScalar(t,e){return new a(t.x%e,t.y%e)}static abs(t){return new a(Math.abs(t.x),Math.abs(t.y))}static round(t){return new a(Math.round(t.x),Math.round(t.y))}static floor(t){return new a(Math.floor(t.x),Math.floor(t.y))}static ceil(t){return new a(Math.ceil(t.x),Math.ceil(t.y))}static frac(t){return a.subtract(t,a.floor(t))}static isLessThan(t,e){return t.x<e.x||t.y<e.y}static isGreaterThan(t,e){return t.x>e.x||t.y>e.y}static length(t){return Math.sqrt(t.x*t.x+t.y*t.y)}static normalize(t){const e=t.length();return e===0?t:a.multiplyScalar(t,1/e)}static dot(t,e){const i=a.multiply(t,e);return i.x+i.y}static isEqual(t,e){return t.x===e.x&&t.y===e.y}static isNear(t,e,i=.001){const n=a.subtract(t,e).abs();return n.x<=i&&n.y<=i}static min(...t){return new a(Math.min(...t.map(e=>e.x)),Math.min(...t.map(e=>e.y)))}static max(...t){return new a(Math.max(...t.map(e=>e.x)),Math.max(...t.map(e=>e.y)))}static from(t){return new a(t.x,t.y)}static fromArray([t,e]){return new a(t,e)}static random(){return new a(xt(),xt())}};y(a,"zero",Object.freeze(new a)),y(a,"one",Object.freeze(new a(1,1))),y(a,"up",Object.freeze(new a(0,-1))),y(a,"down",Object.freeze(new a(0,1))),y(a,"left",Object.freeze(new a(-1,0))),y(a,"right",Object.freeze(new a(1,0))),y(a,"negativeInfinity",Object.freeze(new a(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY))),y(a,"positiveInfinity",Object.freeze(new a(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY)));let h=a;const R=Object.freeze({NW:h.create(-1,-1),N:h.up,NE:h.create(1,-1),E:h.right,SE:h.one,S:h.down,SW:h.create(-1,1),W:h.left}),Lt=[R.NW,R.N,R.NE,R.W,R.E,R.SW,R.S,R.SE];var Q,X;class bt extends Bt{constructor(){super(h.positiveInfinity.clone(),h.negativeInfinity.clone());p(this,Q,!1);p(this,X,void 0);d(this,X,h.negativeInfinity.clone())}get area(){return r(this,Q)?super.area:0}haveChanges(){return r(this,Q)}reset(){this.position.set(h.positiveInfinity),this.size.set(h.negativeInfinity),r(this,X).set(h.negativeInfinity),d(this,Q,!1)}registerPoint(e){this.position.min(e),r(this,X).max(e),this.size.setXY(r(this,X).x-this.position.x+1,r(this,X).y-this.position.y+1),d(this,Q,!0)}}Q=new WeakMap,X=new WeakMap;var P,st,rt,yt;class mt{constructor(t){p(this,rt);y(this,"size");y(this,"alternateRows");y(this,"createEmpty");y(this,"grid");p(this,P,void 0);p(this,st,0);const{size:e,alternateRows:i,createEmpty:n}={alternateRows:!1,...t};if(!h.frac(e).isEqual(h.zero))throw new Error(`Grid size must be integers (${e.toArray().join(", ")})`);this.grid=[],d(this,P,new bt),this.size=e,this.alternateRows=i,this.createEmpty=n?()=>n(this):()=>new St(this),J(this,rt,yt).call(this)}clear(){J(this,rt,yt).call(this),this.resetChanges()}indexOf(t){return t?t.index:-1}positionOf(t){if(t)return t.position}forEach(t,e){const{alternateRowDirections:i,evenRows:n,oddRows:o,evenCols:c,oddCols:l,startRow:f,endRow:k,startCol:b,endCol:N}={evenRows:!0,oddRows:!0,evenCols:!0,oddCols:!0,...e},z=new Set,I=(E,v)=>{const w=this.xy2index(E,v),u=this.grid[w];u&&(z.has(u)||(t(u,w),z.add(u)))};for(let E=f||0;E<(k||this.size.y);E++){const v=E%2;if(!(v===0&&!n)&&!(v===1&&!o)){if(i&&E%2===0){for(let w=(N||this.size.x)-1;w>=(b||0);w--){const u=w%2;u===0&&!c||u===1&&!l||I(w,E)}continue}for(let w=b||0;w<(N||this.size.x);w++){const u=w%2;u===0&&!c||u===1&&!l||I(w,E)}}}}map(t){return this.grid.map(t)}mapChanged(t){return this.getAllChanges().map(t)}getAllChanges(t=!1){const e=[];return this.forEachChanged(i=>e.push(i),t),e}countChanges(){return r(this,P).area}forEachChanged(t,e=!1){if(!r(this,P).haveChanges())return;const i=r(this,P).position.clone(),n=r(this,P).position.clone().add(r(this,P).size);this.forEach(t,{startRow:i.y,endRow:n.y,startCol:i.x,endCol:n.x}),e&&this.resetChanges()}registerChanged(t){t&&r(this,P).registerPoint(t.position)}resetChanges(){r(this,P).reset()}xy2index(t,e){return t<0||t>=this.size.x||e<0||e>=this.size.y?-1:t+e*this.size.x}position2index(t){const{x:e,y:i}=t;return this.xy2index(e,i)}index2position(t){const e=Math.floor(t/this.size.x),i=t-e*this.size.x;return h.create(i,e)}get(t){return this.getAtPosition(t)}set(t,e){this.setAtPosition(t,e)}getCellsInLine(t,e,i){const{excludeStart:n,excludeEnd:o,maxSteps:c}={maxSteps:r(this,st),...i},l=e.x-t.x,f=e.y-t.y;if(l===0&&f===0){const g=this.getAtPosition(t);return g?[g]:[]}const k=l<0?-1:1,b=f<0?-1:1,N=Math.abs(l),z=Math.abs(f),I=N>=z,E=Math.min(N,z),v=Math.max(N,z),w=E/v,u=[],L=n?1:0,F=o?v:v+1,G=F-L,V=c!==void 0&&G>c?Math.floor(G/c):1;for(let g=L;g<F;g+=V){const q=Math.round(g*w);if(I){const m=this.getAtXY(t.x+g*k,t.y+q*b);m&&u.push(m)}else{const m=this.getAtXY(t.x+q*k,t.y+g*b);m&&u.push(m)}}return u}getAtXY(t,e){const i=this.xy2index(t,e);if(i!==-1)return this.getAtIndex(i)}getAtPosition(t){const e=this.position2index(t);if(e!==-1)return this.getAtIndex(e)}setAtPosition(t,e){if(t.x<0||t.x>=this.size.x||t.y<0||t.y>=this.size.y)return;const i=this.position2index(t);this.setAtIndex(i,e)}getAtIndex(t){if(t%1!==0)throw new Error(`not int: ${t}`);return this.grid[t]}swap(t,e){const i=this.indexOf(t),n=this.indexOf(e);if(i===-1||n===-1)throw new Error("Can't swap unless both cells exists in the grid");const o=this.grid[i];this.setAtIndex(i,this.grid[n]),this.setAtIndex(n,o)}setAtIndex(t,e){if(t<0)throw new Error(`invalid index: ${t}`);e.index=t,e.position=this.index2position(t),this.grid[t]=e,this.registerChanged(e)}}P=new WeakMap,st=new WeakMap,rt=new WeakSet,yt=function(){const t=this.size.x*this.size.y;this.grid.length=t;for(let e=0;e<t;e++)this.setAtIndex(e,this.createEmpty());d(this,st,this.size.length())};var M;class Xt extends St{constructor(e,i){super(e);y(this,"parent");p(this,M,void 0);this.parent=i,d(this,M,new bt)}get dirtyRect(){return r(this,M)}forEachChanged(e,i){if(!r(this,M).haveChanges())return;const{resetChanges:n,...o}={resetChanges:!1,...i},c=r(this,M).position.clone(),l=r(this,M).position.clone().add(r(this,M).size);n&&this.resetChanges(),this.parent.forEach(e,{startRow:c.y,endRow:l.y,startCol:c.x,endCol:l.x,...o})}forEach(e,i){const n=this.parent.chunkSize,o=h.multiply(this.position,n),c=h.multiply(this.position,n).add(n);this.parent.forEach(e,{startRow:o.y,endRow:c.y,startCol:o.x,endCol:c.x,...i})}haveChanges(){return r(this,M).haveChanges()}countChanges(){return r(this,M).haveChanges()?r(this,M).area:0}registerChange(e){r(this,M).registerPoint(e.position)}getAllChanges(e){const i=[];return this.forEachChanged(n=>i.push(n),e),i}resetChanges(){r(this,M).reset()}}M=new WeakMap;function Yt(s){return new Worker("/assets/worker-G1OrwRg-.js",{name:s==null?void 0:s.name})}var j,_,U,nt,ot,It,ut,vt,ct,Et,lt,Rt;class qt extends mt{constructor(e){const{chunkSize:i,workerize:n,...o}=e;super(o);p(this,ot);p(this,ut);p(this,ct);p(this,lt);y(this,"chunkSize",h.create(64,64));p(this,j,void 0);p(this,_,void 0);p(this,U,void 0);p(this,nt,[]);this.chunkSize=i||h.create(64,64);try{d(this,j,new mt({size:h.divide(this.size,this.chunkSize),createEmpty:c=>new Xt(c,this)}))}catch{throw new Error(`Grid must be evenly divisible by chunk size: ${h.divide(this.size,this.chunkSize).toArray().join(", ")}`)}d(this,_,n||!1),r(this,_)&&(d(this,U,new Yt),r(this,U).onmessage=J(this,lt,Rt)),J(this,ot,It).call(this)}registerChanged(e){if(!e||e.index<0||e.index>=this.grid.length)return;const i=this.chunkOf(e);i&&i.registerChange(e)}resetChanges(){super.resetChanges(),this.forEachChunk(e=>e.resetChanges())}countChanges(){return this.mapChunks(e=>e.countChanges()).reduce((e,i)=>e+i)}getAllChanges(){const e=[];return this.forEachChanged(i=>e.push(i)),e}forEachChanged(e,i){this.forEachChunk(n=>{n.haveChanges()&&n.forEachChanged(e,{resetChanges:i})})}chunkOf(e){if(e&&this.chunkSize)return r(this,j).getAtXY(Math.floor(e.position.x/this.chunkSize.x),Math.floor(e.position.y/this.chunkSize.y))}getChunk(e){return r(this,j).get(e)}forEachChunk(e,i){r(this,j).forEach(e,i)}mapChunks(e){return r(this,j).map(e)}forEachChangedChunkPass(e,i=!0){this.forEachChunkPass(n=>{const o=n.filter(c=>c.haveChanges());o.length!==0&&(e(o),i&&o.forEach(c=>c.resetChanges()))})}forEachChunkPass(e){r(this,nt).forEach((i,n)=>{r(this,_)?J(this,ct,Et).call(this,()=>e(i,n)):e(i,n)})}}j=new WeakMap,_=new WeakMap,U=new WeakMap,nt=new WeakMap,ot=new WeakSet,It=function(){for(let e=0;e<r(this,j).size.x*r(this,j).size.y;e++)r(this,j).setAtIndex(e,r(this,j).createEmpty());J(this,ut,vt).call(this)},ut=new WeakSet,vt=function(){const e=[[!1,!1],[!1,!0],[!0,!1],[!0,!0]],i=[];e.forEach(([n,o])=>{const c=[];this.forEachChunk(l=>{c.push(l)},{evenRows:!n,oddRows:n,evenCols:!o,oddCols:o}),i.push(c)}),d(this,nt,i)},ct=new WeakSet,Et=function(e){r(this,U)&&r(this,U).postMessage({f:e})},lt=new WeakSet,Rt=function(e){console.log("worker says:",this,e.data)};class ee{constructor(t){y(this,"grid");const{gridOptions:e}=t;this.grid=this.createGrid(e)}clear(){this.grid.clear()}}class Ht{}var tt,dt;const ft=class ft extends Ht{constructor(e){super();p(this,tt,0);p(this,dt,100);y(this,"gravity");y(this,"sideStep");y(this,"bounce");const{gravity:i,sideStep:n,bounce:o}={gravity:ft.defaultGravity,sideStep:!0,bounce:!0,...e};this.gravity=i,this.sideStep=n,this.bounce=o}step({cell:e,deltaTime:i}){let n=!1;const o=[-1,1];xt()>=.5&&o.reverse();const c=e.getNeighbourInDirection(this.gravity.y<0?h.up:h.down);e.isSleeping?c!=null&&c.empty&&(e.acceleration.add(h.multiplyScalar(this.gravity,i)),n=!0):this.sideStep&&(c!=null&&c.empty?(e.acceleration.add(h.multiplyScalar(this.gravity,i)),n=!0):o.every(l=>{const f=e.getNeighbourInDirection(h.create(l,this.gravity.y<0?-1:1));return f!=null&&f.empty?(e.acceleration.add(h.subtract(f.position,e.position)),n=!0,!1):!0})),n?(d(this,tt,0),o.forEach(l=>{const f=e.getNeighbourInDirection(h.create(l,0));f!=null&&f.empty||f==null||f.awake()})):(pt(this,tt)._++,r(this,tt)>=r(this,dt)&&e.sleep())}};tt=new WeakMap,dt=new WeakMap,y(ft,"defaultGravity",h.create(0,9.81));let Ct=ft;function $t(s,t){const{children:e,grid:i,renderOptions:n,pickColor:o,...c}=s,l=S.useRef(null),f=S.useRef(null),k=S.useRef(),[b,N]=Ot(!0);S.useImperativeHandle(t,()=>({clear:E,render:v})),S.useEffect(()=>{i&&(E(),v(i,n))},[i]);function z(){return f.current||(f.current=l.current?l.current.getContext("2d"):null,f.current&&(f.current.imageSmoothingEnabled=!1,f.current.translate(.5,.5))),f.current}function I(){if(k.current)return k.current;if(!i)return;const u=z();if(u)return k.current=u.createImageData(...i.size.toArray()),k.current}function E(){const u=I();u&&(u.data.fill(0),N(!0))}function v(u,L){const F={debugDraw:!1,resetChanges:!1,pixelScale:1,...L},{debugDraw:G,resetChanges:V,pixelScale:g,onDebugDraw:q}=F;if(!u)return;if(l.current){const C=u.size.x,A=u.size.y;(l.current.width!==C||l.current.height!==A)&&(l.current.width=C*g,l.current.height=A*g,f.current=null)}const m=z();if(!m)return;const H=I();if(H){if(b.current===!0?u.forEach(C=>w({grid:u,imageData:H,cell:C})):u.forEachChanged(C=>w({grid:u,imageData:H,cell:C}),V),g!==1){const C=document.createElement("canvas");C.width=u.size.x,C.height=u.size.y;const A=C.getContext("2d");A==null||A.putImageData(H,0,0),m.drawImage(C,0,0,u.size.x*g,u.size.y*g)}else m.putImageData(H,0,0);G&&(u instanceof qt&&u.forEachChunkPass((C,A)=>{C.forEach(T=>{m.strokeStyle=T.haveChanges()?"rgba(255, 255, 255, 0.8)":"rgba(0, 0, 0, 0.2)",m.fillStyle=m.strokeStyle,m.lineWidth=1;const $=h.multiply(T.position,u.chunkSize),ht=h.multiplyScalar(u.chunkSize,g);g!==1&&$.multiplyScalar(g),m.strokeRect(...$.toArray(),...ht.toArray()),m.textAlign="right",m.fillText(T.position.toArray().toString(),...h.add($,ht).subtractScalar(2).toArray()),m.textAlign="left",m.fillText(A.toString(),...h.add($,h.multiply(ht,h.down).add(h.fromArray([2,-2]))).toArray(),ht.x),T.dirtyRect.haveChanges()&&(m.strokeStyle="red",m.fillStyle="red",m.textAlign="left",m.fillText(T.countChanges().toString(),...h.add($,h.create(2,10)).toArray()),m.strokeRect(...h.multiplyScalar(T.dirtyRect.position,g).toArray(),...h.multiplyScalar(T.dirtyRect.size,g).toArray()))})}),q&&q(m)),N(!1)}}function w(u){const{imageData:L,cell:F}=u;if(F.index===-1)return;const G=o?o({cell:F,renderOptions:n}):F.getRGBA();G&&L.data.set(G,F.index*4)}if(i)return x.jsxs("div",{className:"grid canvas",style:n!=null&&n.debugDraw?{backgroundColor:"rgb(80, 80, 80)"}:void 0,children:[x.jsx("canvas",{ref:l,...c}),e]})}const Jt=S.forwardRef($t);var Y,et,D,at,it,O,Z,B;class Kt{constructor(t){p(this,Y,void 0);p(this,et,void 0);p(this,D,void 0);y(this,"limitFps");p(this,at,void 0);p(this,it,void 0);p(this,O,!0);p(this,Z,void 0);p(this,B,void 0);const{gridRenderer:e,renderOptions:i,simulation:n,limitFps:o,resetChanges:c,onStep:l}={resetChanges:!0,...t};d(this,Y,e),d(this,et,i),d(this,D,n),this.limitFps=o,d(this,at,c),d(this,it,l),this._stepInternal=this._stepInternal.bind(this),d(this,Z,requestAnimationFrame(this._stepInternal))}_stepInternal(t){if(r(this,O)&&r(this,B)===void 0)d(this,B,t);else{const e=r(this,B)===void 0?0:(t-r(this,B))/1e3;if((this.limitFps===void 0||e>1/this.limitFps)&&r(this,D)){const i=r(this,D).grid;if(!i)throw new Error("simulation or grid must be provided");r(this,O)&&this.step(e),r(this,it)&&r(this,it).call(this,{grid:i,deltaTime:e}),r(this,Y)&&r(this,Y).render(i,{resetChanges:!1,...r(this,et)}),r(this,O)&&r(this,at)&&i.resetChanges()}}r(this,O)&&d(this,B,t),d(this,Z,requestAnimationFrame(this._stepInternal))}get simulation(){return r(this,D)}destroy(){this.stop(),this.clear(),r(this,Z)!==void 0&&cancelAnimationFrame(r(this,Z))}start(){r(this,O)||(d(this,O,!0),this._stepInternal(Date.now()))}stop(){d(this,O,!1),d(this,B,void 0)}clear(){var t,e;(t=r(this,D))==null||t.clear(),(e=r(this,Y))==null||e.clear()}isRunning(){return r(this,O)}registerSimulation(t){r(this,D)&&(console.error("already have one"),this.destroy()),d(this,D,t)}registerGridRenderer(t,e){d(this,Y,t),e&&d(this,et,e)}step(t){r(this,D)&&r(this,D).step(t)}}Y=new WeakMap,et=new WeakMap,D=new WeakMap,at=new WeakMap,it=new WeakMap,O=new WeakMap,Z=new WeakMap,B=new WeakMap;function Qt(s){const{simulationRunnerRef:t,fps:e,children:i,configExtra:n,isPlaying:o,setIsPlaying:c,renderOptions:l,setRenderOptions:f}=s;function k(){var b;(b=t.current)==null||b.clear()}return x.jsxs("div",{className:"controls",children:[x.jsxs("div",{className:"panel controls",children:[x.jsx("button",{onClick:()=>c(b=>!b),children:o?x.jsxs(x.Fragment,{children:[x.jsx(Mt,{}),"stop"]}):x.jsxs(x.Fragment,{children:[x.jsx(kt,{}),"start"]})}),x.jsxs("button",{onClick:()=>{var b;(b=t.current)==null||b.step(.1)},children:[x.jsx(Nt,{}),"step"]}),x.jsxs("button",{onClick:()=>k(),children:[x.jsx(jt,{}),"reset"]})]}),i,x.jsxs("div",{className:"panel config",children:[x.jsxs(Dt,{trigger:x.jsxs("div",{className:"item trigger",children:[x.jsx(Pt,{}),"config"]}),children:[x.jsx(Gt,{id:"debugDraw",checked:(l==null?void 0:l.debugDraw)||!1,onChange:b=>f(N=>({...N,debugDraw:b}))}),n]}),x.jsx("div",{className:"separator"}),x.jsxs("div",{style:{width:"60px",whiteSpace:"nowrap",display:"flex",justifyContent:"center",alignItems:"center",lineHeight:"1em"},children:["fps: ",e]})]})]})}function Ut(s,t){const{limitFps:e,resetChanges:i,background:n,children:o,defaultRenderOptions:c,toolBarPanel:l,toolBarConfigExtra:f,initSimulation:k,onStep:b,...N}={resetChanges:!0,...s},z=S.useRef(null),I=S.useRef(null),E=S.useRef(c||null),v=S.useRef([0]),[w,u]=S.useState(!0),[L,F]=S.useState(-1),[G,V]=S.useState(void 0),[g,q]=S.useState({...c});S.useImperativeHandle(t,()=>I.current),S.useEffect(()=>{var C;if(z.current&&!I.current)return I.current=new Kt({gridRenderer:z.current,simulation:k(),limitFps:e,resetChanges:i,renderOptions:g,onStep:m}),V((C=I.current.simulation)==null?void 0:C.grid),()=>{var A;(A=I.current)==null||A.destroy(),I.current=null,V(void 0)}},[]),S.useEffect(()=>{I.current&&(w?I.current.start():I.current.stop())},[w]),S.useEffect(()=>{var C;z.current&&(Ft.isEqual(g,E.current)||(E.current=g,(C=I.current)==null||C.registerGridRenderer(z.current,g)))},[g]);function m(C){const{deltaTime:A}=C;v.current=[...v.current.slice(v.current.length-100),A===0?-1:1/A],F(Math.round(v.current.reduce((T,$)=>T+$)/v.current.length||1)),b&&b(C)}function H(C){C.preventDefault()}return x.jsxs("div",{className:"simulation-runner",children:[x.jsx(Qt,{simulationRunnerRef:I,fps:L,children:l,configExtra:f,isPlaying:w,setIsPlaying:u,renderOptions:g,setRenderOptions:q}),g.debugDraw?void 0:n,x.jsx(Jt,{ref:z,renderOptions:g,grid:G,children:o,onContextMenu:H,...N})]})}const ie=S.forwardRef(Ut);export{Ht as B,qt as C,St as G,ee as S,h as V,Ct as a,ie as b,Gt as c,te as d,mt as e,Lt as n,xt as r,Ot as u};

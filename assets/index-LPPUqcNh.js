var Se=Object.defineProperty;var be=(s,t,e)=>t in s?Se(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var i=(s,t,e)=>(be(s,typeof t!="symbol"?t+"":t,e),e),q=(s,t,e)=>{if(!t.has(s))throw TypeError("Cannot "+e)};var m=(s,t,e)=>(q(s,t,"read from private field"),e?e.call(s):t.get(s)),g=(s,t,e)=>{if(t.has(s))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(s):t.set(s,e)},v=(s,t,e,r)=>(q(s,t,"write to private field"),r?r.call(s,e):t.set(s,e),e);var H=(s,t,e,r)=>({set _(l){v(s,t,l,e)},get _(){return m(s,t,r)}}),oe=(s,t,e)=>(q(s,t,"access private method"),e);import{r as w,_ as ae,j as f}from"./index-VB6cm0Bi.js";import{G as Re,V as h,a as Fe,u as G,b as De}from"./index-0xSaKzvX.js";var F;class O extends Re{constructor(e,r){super(e);i(this,"empty");i(this,"shouldTryAwakeNeighbours");i(this,"color");i(this,"behaviors");g(this,F,!1);i(this,"index",-1);i(this,"position",new h(0,0));i(this,"brushSize",4);i(this,"brushFillRate",.05);i(this,"velocity",new h(0,0));const{empty:l,shouldTryAwakeNeighbours:o,behaviors:d}={empty:!1,shouldTryAwakeNeighbours:!0,behaviors:[],...r};this.empty=l,this.shouldTryAwakeNeighbours=o,this.color=this.getRGBA(),this.behaviors=d}isSleeping(){return m(this,F)}sleep(){v(this,F,!0),this.grid.registerChanged(this)}awake(){v(this,F,!1),this.grid.registerChanged(this)}die(){this.grid.set(this.position,new k(this.grid))}getRGBA(){return this.color}addBehaviors(...e){this.behaviors.push(...e)}step(e){this.behaviors.forEach(r=>{r.step({deltaTime:e,cell:this,grid:this.grid})})}}F=new WeakMap;class k extends O{constructor(e){super(e,{empty:!0});i(this,"brushSize",2);i(this,"brushFillRate",1);i(this,"color",[50,50,50,255]);this.sleep()}awake(){}step(){}}class C extends O{}class T{}class V extends C{constructor(e,r){super(e,{shouldTryAwakeNeighbours:!1,...r});i(this,"brushSize",2);i(this,"brushFillRate",1);this.sleep()}awake(){}step(){}}var D,W;class ue extends T{constructor(e=new h(0,9)){super();g(this,D,0);g(this,W,100);i(this,"isFalling",!1);i(this,"gravity");this.gravity=e}step({cell:e,grid:r,deltaTime:l}){let o=!1;const d=[-1,1];if(Math.random()>=.5&&d.reverse(),e.isSleeping()){const u=e.getNeighbourInDirection(this.gravity.y<0?h.up():h.down());u!=null&&u.empty&&(e.swapWith(u),o=!0,this.isFalling=!0)}else{e.velocity=e.velocity.add(this.gravity.multiplyScalar(l));let u=e;e.getLineTo(e.position.add(e.velocity),{excludeStart:!0}).every(c=>{const a=r.get(c);if(!(a!=null&&a.empty)){if(this.isFalling&&(a instanceof V||a instanceof z)){const p=e.velocity.subtract((a==null?void 0:a.velocity)||h.zero()).abs(),B=Math.random()*.2,A=Math.random()*.05;p.length()>0&&(e.velocity=new h(e.velocity.x+(Math.random()<.5?-1:1)*p.y*B,-p.y*A),u=e,this.isFalling=!1)}return!1}return u=a,!0}),u!==e?(e.swapWith(u),o=!0):d.every(c=>{const a=e.getNeighbourInDirection(new h(c,1));return a!=null&&a.empty?(e.swapWith(a),o=!0,!1):!0})}o?(d.every(u=>{const c=e.getNeighbourInDirection(new h(u,0));return c!=null&&c.empty||c==null||c.awake(),!0}),v(this,D,0)):(this.isFalling=!1,H(this,D)._++,m(this,D)>=m(this,W)&&e.sleep())}}D=new WeakMap,W=new WeakMap;var _,N;class ke extends T{constructor(e=50){super();g(this,_,0);g(this,N,100+Math.random()*25);i(this,"dispersionRate");this.dispersionRate=e}step({cell:e,grid:r}){var d,u;let l=!1;const o=[-1,1];Math.random()>=.5&&o.reverse(),e.isSleeping()&&o.every(c=>{const a=e.getNeighbourInDirection(new h(c,0));return a!=null&&a.empty?(e.swapWith(a),!1):!0}),m(this,_)<=m(this,N)?o.every(c=>(r.getPositionsInLine(e.position,e.position.add(new h(c*this.dispersionRate,0)),{excludeStart:!0}).every(a=>{const p=r.getAtPosition(a);return p!=null&&p.empty?(e.swapWith(p),l=!0,H(this,_)._++,!1):!(p instanceof C)}),!l)):((d=e.dir.W())!=null&&d.empty||(u=e.dir.E())!=null&&u.empty)&&e.die()}}_=new WeakMap,N=new WeakMap;class Ae extends T{constructor(e=.005){super();i(this,"erosionFactor");this.erosionFactor=e}step({cell:e}){if(this.erosionFactor>0){const r=e.dir.S();r instanceof z&&Math.random()<this.erosionFactor&&e.swapWith(r)}}}class he extends O{constructor(t,e){super(t,e);const{gravity:r,dispersionRate:l,erosionFactor:o}=e||{};this.addBehaviors(new ue(r),new ke(l),new Ae(o))}}class X extends he{}class _e extends T{step({cell:t}){const e=t.dir.S();if(e instanceof X){t.swapWith(e);return}}}class z extends C{constructor(t,e){super(t,e),this.addBehaviors(new _e,new ue)}}class je extends z{constructor(){super(...arguments);i(this,"_r",Math.random()*20);i(this,"color",[191-this._r,155-this._r,123-this._r,255])}}class ce extends he{constructor(t,e){super(t,{dispersionRate:8,gravity:new h(0,-.25),erosionFactor:0,shouldTryAwakeNeighbours:!1,...e}),this.velocity=this.velocity.add(h.random().multiplyScalar(2).add(h.one().multiplyScalar(-1)).multiplyScalar(.025).multiply(h.right()))}}class Ge extends ce{constructor(){super(...arguments);i(this,"color",[90,90,90,Math.round(Math.random()*185)+70])}}class Y extends z{constructor(){super(...arguments);i(this,"_r",Math.random()*20);i(this,"color",[220-this._r,220-this._r,255,255])}step(e){if(!this.isSleeping()||Math.random()<.995){super.step(e);return}this.getNeighbourhood().map(o=>o===void 0?.25:o.empty?.5:o instanceof Y?-1:o instanceof C?2:o instanceof X?1:0).reduce((o,d)=>o+d)>0&&this.die()}getRGBA(){return this.isSleeping()?this.color:[220,220,255,255]}die(){this.grid.set(this.position,Math.random()<.25?new U(this.grid):new k(this.grid))}}class de extends ce{constructor(){super(...arguments);i(this,"_r",Math.round(Math.random()*80)+100);i(this,"color",[255,255,255,this._r])}die(){this.grid.set(this.position,Math.random()<.05?new U(this.grid):new k(this.grid))}}class We extends V{constructor(){super(...arguments);i(this,"color",[100,100,100,255])}}class U extends X{constructor(e,r){super(e,{...r,dispersionRate:3});i(this,"_r",Math.round(Math.random()*100)+155);i(this,"color",[46,137,255,this._r])}die(){this.grid.set(this.position,Math.random()<.25?new de(this.grid):new k(this.grid))}}class Ne extends V{constructor(){super(...arguments);i(this,"_r",Math.random()*20);i(this,"color",[180-this._r,100-this._r,100-this._r,255-this._r])}}var x,R,P,le;class Pe{constructor(t){g(this,P);g(this,x,void 0);g(this,R,!0);i(this,"materialPalette");v(this,x,new Fe({...t,createEmpty:e=>new k(e)})),this.materialPalette=oe(this,P,le).call(this,m(this,x))}isRunning(){return m(this,R)}start(){v(this,R,!0)}stop(){v(this,R,!1)}restart(){this.stop(),m(this,x).clear(),this.start()}getGrid(){return m(this,x)}step(t){if(!m(this,R))return;m(this,x).forEach(r=>{r.empty||r.step(t)},{alternateRows:!0})}}x=new WeakMap,R=new WeakMap,P=new WeakSet,le=function(t){return{empty:()=>new k(t),sand:()=>new je(t),smoke:()=>new Ge(t),snow:()=>new Y(t),steam:()=>new de(t),stone:()=>new We(t),water:()=>new U(t),wood:()=>new Ne(t)}};function Ee(){var ee;const e=w.useRef(null),r=w.useRef(),l=w.useRef(),o=w.useRef(),d=w.useRef(),u=w.useRef(void 0),[c,a]=G(!1),[p,B]=G([0,0]),[A,me]=G("sand"),[J,fe]=w.useState([0]),[K,pe]=G(!1),[ge,we]=w.useState([]);w.useEffect(()=>(r.current=new Pe({width:320,height:180}),l.current=r.current.getGrid(),we(ae.keys(r.current.materialPalette)),$(),o.current=requestAnimationFrame(Q),()=>{o.current!==void 0&&cancelAnimationFrame(o.current)}),[]);function ye(n){n.preventDefault()}function ve(n){const y=n.target,{x:M,y:S,width:b,height:te}=y.getBoundingClientRect();B([(n.clientX-M)/b,(n.clientY-S)/te])}function Q(n){if(d.current===void 0)d.current=n;else{const y=(n-d.current)/1e3;{const M=r.current;if(!M)return;const S=M.getGrid();Me(S),M.step(y),d.current=n,fe(b=>[...b.slice(b.length-100),1/y])}}o.current=requestAnimationFrame(Q)}function xe(){a(!0)}function Z(){a(!1),u.current=void 0}function Me(n){if(!c.current||!A.current)return;const[y,M]=p.current,S=new h(Math.floor(y*n.width),Math.floor(M*n.height)),b=r.current;if(!b)return;const E=b.materialPalette[A.current];if(!E)return;const j=E(),se=Math.floor(j.brushSize);(u.current?n.getPositionsInLine(u.current,S):[S]).every(re=>{for(let I=-se;I<j.brushSize;I++)for(let L=-se;L<j.brushSize;L++){if(Math.random()>j.brushFillRate)continue;const ie=re.x+L;if(ie<0)continue;const ne=re.y+I;ne<0||n.setAtPosition(new h(ie,ne),E())}return!0}),u.current=S}function $(){const n=r.current;n&&n.restart()}return f.jsxs("div",{className:"route sand",ref:e,children:[f.jsxs("div",{className:"materials",children:[f.jsx("div",{className:"material",children:"reset",onClick:$}),f.jsx("div",{className:"separator"}),ae.map(ge,n=>f.jsx("div",{className:"material",children:n,onClick:()=>me(n),style:A.current===n?{border:"1px solid white"}:void 0},n)),f.jsx("div",{className:"separator"}),f.jsxs("div",{children:[f.jsx("input",{id:"debugDraw",type:"checkbox",checked:K.current,onChange:n=>pe(n.target.checked)}),f.jsx("label",{htmlFor:"debugDraw",children:"debugDraw"})]}),f.jsx("div",{className:"separator"}),f.jsxs("div",{style:{width:"60px",whiteSpace:"nowrap"},children:["fps: ",Math.round(J.reduce((n,y)=>n+y)/J.length||1)]})]}),f.jsx(De,{grid:(ee=r.current)==null?void 0:ee.getGrid(),onMouseDown:xe,onMouseUp:Z,onMouseLeave:Z,onMouseMove:ve,onContextMenu:ye,pickColor:n=>K.current&&!n.isSleeping()?[255,255,255,255]:n.getRGBA()})]})}export{Ee as default};

var ht=Object.defineProperty;var ut=(i,t,e)=>t in i?ht(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var u=(i,t,e)=>(ut(i,typeof t!="symbol"?t+"":t,e),e),G=(i,t,e)=>{if(!t.has(i))throw TypeError("Cannot "+e)};var a=(i,t,e)=>(G(i,t,"read from private field"),e?e.call(i):t.get(i)),b=(i,t,e)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,e)},M=(i,t,e,s)=>(G(i,t,"write to private field"),s?s.call(i,e):t.set(i,e),e);var Z=(i,t,e,s)=>({set _(n){M(i,t,n,e)},get _(){return a(i,t,s)}}),_=(i,t,e)=>(G(i,t,"access private method"),e);import{r as g,j as p,_ as q}from"./index-20D_SEaN.js";function E(i){const[t,e]=g.useState(i),s=g.useRef(t);return[s,o=>{o instanceof Function?(s.current=o(s.current),e(o)):(s.current=o,e(o))}]}class c{constructor(t,e){u(this,"x");u(this,"y");this.x=t,this.y=e}add(t){return new c(this.x+t.x,this.y+t.y)}}const N={NW:new c(-1,-1),N:new c(0,-1),NE:new c(1,-1),E:new c(1,0),SE:new c(1,1),S:new c(0,1),SW:new c(-1,1),W:new c(-1,0)};function lt(i,t){const[e,s,n]=i;if(t===void 0)return`hsl(${e}, ${s}%, ${n}%)`;const[o,r,l]=W(i,t);return`hsl(${o}, ${r}%, ${l}%)`}function W(i,t=[Math.round(Math.random()*10),Math.round(Math.random()*10),Math.round(Math.random()*10)]){const[e,s,n]=i,[o=0,r=0,l=0]=t||[];return[Math.min(Math.max(e+Math.round(Math.random()*(o*2))-o,0),360),Math.min(Math.max(s+Math.round(Math.random()*(r*2))-r,0),100),Math.min(Math.max(n+Math.round(Math.random()*(l*2))-l,0),100)]}var O;class X{constructor(t,e){u(this,"empty",!1);u(this,"color");u(this,"grid");u(this,"shouldTryAwakeNeighbours");b(this,O,!0);u(this,"maxSpeed",8);u(this,"acceleration",.4);u(this,"velocity",0);u(this,"dir",{NW:()=>this.getNeighbourInDirection(N.NW),N:()=>this.getNeighbourInDirection(N.N),NE:()=>this.getNeighbourInDirection(N.NE),E:()=>this.getNeighbourInDirection(N.E),SE:()=>this.getNeighbourInDirection(N.SE),S:()=>this.getNeighbourInDirection(N.S),SW:()=>this.getNeighbourInDirection(N.SW),W:()=>this.getNeighbourInDirection(N.W)});const{isEmpty:s,shouldTryAwakeNeighbours:n}={shouldTryAwakeNeighbours:!0,...e};this.grid=t,this.shouldTryAwakeNeighbours=n,this.empty=s||!1,this.maxSpeed=8,this.acceleration=.4,this.velocity=0,this.color=lt(this.getHSL())}isSleeping(){return a(this,O)}sleep(){M(this,O,!0),this.grid.registerChanged(this)}awake(){M(this,O,!1),this.grid.registerChanged(this)}getPosition(){return this.grid.positionOf(this)}getNeighbourInDirection(t){const e=this.grid,s=e.positionOf(this).add(t);return e.getAtPosition(s)}swap(t){this.grid.swap(this,t)}}O=new WeakMap;class tt extends X{constructor(t){super(t,{isEmpty:!0})}awake(){}getHSL(){return[50,0,20]}step(){}}class Y extends X{}class P extends X{constructor(e,s){super(e,s);u(this,"numFramesOfHorizontalMovement",0);u(this,"maxFramesOfHorizontalMovement",100);u(this,"dispersionRate");u(this,"fallDirection");u(this,"erosionFactor");const{dispersionRate:n,fallDirection:o,erosionFactor:r}=s||{};this.dispersionRate=n||5,this.fallDirection=o||1,this.erosionFactor=r||.01}step(){let e=!1;const s=[-this.dispersionRate,this.dispersionRate];Math.random()>=.5&&s.reverse(),this.shouldTryAwakeNeighbours&&!this.isSleeping()&&s.every(o=>{const r=this.getNeighbourInDirection(new c(o,0));r!=null&&r.empty||r==null||r.awake(),this.erosionFactor>0&&r instanceof et&&Math.random()<this.erosionFactor&&this.swap(r)});const n=this.getNeighbourInDirection(new c(0,this.fallDirection));n!=null&&n.empty?(this.swap(n),e=!0,this.numFramesOfHorizontalMovement=0):this.numFramesOfHorizontalMovement<=this.maxFramesOfHorizontalMovement&&s.every(o=>{const r=this.grid,l=r.positionOf(this);return r.getPositionsInLine(l,l.add(new c(o,0)),{excludeStart:!0}).every(w=>{const d=r.getAtPosition(w);return d!=null&&d.empty?(this.swap(d),e=!0,this.numFramesOfHorizontalMovement++,!1):!(d instanceof Y)}),!e}),e||this.sleep()}}var C;class et extends Y{constructor(){super(...arguments);b(this,C,0)}step(){let e=!1;const s=[-1,1];Math.random()>=.5&&s.reverse();const n=this.dir.S();n!=null&&n.empty||n instanceof P?(this.swap(n),e=!0):this.isSleeping()||s.every(o=>{const r=this.getNeighbourInDirection(new c(o,1));return r!=null&&r.empty||r instanceof P?(this.swap(r),e=!0,!1):!0}),e?(s.every(o=>{const r=this.getNeighbourInDirection(new c(o,0));return r!=null&&r.empty||r==null||r.awake(),!0}),M(this,C,0)):(Z(this,C)._++,a(this,C)>10&&this.sleep())}}C=new WeakMap;class dt extends et{getHSL(){return W([27.8,31.8,58.6])}}class ft extends P{constructor(t,e){super(t,{...e,dispersionRate:3})}getHSL(){return W([216,100,60],[5,5,3])}}class mt extends Y{constructor(t,e){super(t,{shouldTryAwakeNeighbours:!1,...e})}awake(){}step(){}}class gt extends mt{getHSL(){return W([150,5,58.6],[5,0,5])}}class B extends P{constructor(t,e){super(t,{fallDirection:-1,dispersionRate:3,erosionFactor:0,shouldTryAwakeNeighbours:!1,...e})}step(){super.step();let t=!1;if(Math.random()<.98){const e=this.dir.N();e instanceof P&&!(e instanceof B)&&(this.swap(e),t=!0)}else if(this.numFramesOfHorizontalMovement<=this.maxFramesOfHorizontalMovement){const e=[-this.dispersionRate,this.dispersionRate];Math.random()>=.5&&e.reverse(),e.every(s=>{const n=this.getNeighbourInDirection(new c(s,0));return n!=null&&n.empty||n instanceof P?(this.swap(n),t=!0,this.numFramesOfHorizontalMovement++,!1):!!(n!=null&&n.empty)})}t||this.sleep()}}class pt extends B{getHSL(){return W([200,10,38.6],[5,10,5])}}var x,k;class xt{constructor(t,e){u(this,"width");u(this,"height");b(this,x,void 0);b(this,k,void 0);this.width=t,this.height=e,M(this,x,[]),M(this,k,new Set([])),this.clear()}clear(){for(let t=0;t<this.width*this.height;t++)this.setAtIndex(t,new tt(this))}indexOf(t,e){return t?a(this,x).indexOf(t,e):-1}positionOf(t,e){const s=this.indexOf(t,e);return this.index2position(s)}forEach(t){const e=[];for(let s=0;s<a(this,x).length;s++){const n=a(this,x)[s];if(e.indexOf(n)!==-1)continue;if(t(n,s)===!1)break;e.push(n)}}forEachChanged(t,e=!0){a(this,k).forEach(s=>t(s)),e&&a(this,k).clear()}position2index(t){const{x:e,y:s}=t;return e<0||e>=this.width||s<0||s>=this.height?-1:e+s*this.width}index2position(t){let e=Math.floor(t/this.width),s=t-e*this.width;return new c(s,e)}get(t){return this.getAtPosition(t)}set(t,e){this.setAtPosition(t,e)}getPositionsInLine(t,e,s){const{excludeStart:n,excludeEnd:o}=s||{},r=e.x-t.x,l=e.y-t.y;if(r===0&&l===0)return[t];const v=r<0?-1:1,w=l<0?-1:1,d=Math.abs(r),S=Math.abs(l),R=d>=S,m=Math.min(d,S),f=Math.max(d,S),j=m/f,y=[];for(let A=n?1:0;A<(o?f:f+1);A++){const z=Math.round(A*j);R?y.push(new c(t.x+A*v,t.y+z*w)):y.push(new c(t.x+z*v,t.y+A*w))}return y}getAtPosition(t){const e=this.position2index(t);if(e!==-1)return this.getAtIndex(e)}setAtPosition(t,e){const s=this.position2index(t);this.setAtIndex(s,e)}getAtIndex(t){return a(this,x)[t]}registerChanged(t){a(this,k).add(t)}setAtIndex(t,e){a(this,x)[t]=e,this.registerChanged(e)}swap(t,e){const s=this.indexOf(t),n=this.indexOf(e),o=a(this,x)[s];this.setAtIndex(s,a(this,x)[n]),this.setAtIndex(n,o),t.awake(),e.awake()}}x=new WeakMap,k=new WeakMap;var I,H,T,st;class wt{constructor(t){b(this,T);b(this,I,void 0);b(this,H,!0);u(this,"materialPalette");const{width:e,height:s}=t;M(this,I,new xt(e,s)),this.materialPalette=_(this,T,st).call(this,a(this,I))}isRunning(){return a(this,H)}start(){M(this,H,!0)}stop(){M(this,H,!1)}restart(){this.stop(),a(this,I).clear(),this.start()}getGrid(){return a(this,I)}step(){if(!a(this,H))return;a(this,I).forEach(e=>{e.empty||e.step(-1)})}}I=new WeakMap,H=new WeakMap,T=new WeakSet,st=function(t){return{empty:()=>new tt(t),sand:()=>new dt(t),water:()=>new ft(t),stone:()=>new gt(t),smoke:()=>new pt(t)}};const Mt=g.forwardRef((i,t)=>{const{grid:e,pixelRatio:s,debugDraw:n,...o}={pixelRatio:4,...i},r=g.useRef(null),[l,v]=E(!0);g.useImperativeHandle(t,()=>({clear:d,render:S})),g.useEffect(()=>{v(!0),d(),e&&S()},[e]);function w(){return r.current?r.current.getContext("2d"):null}function d(){const m=w();m&&(m.reset(),v(!0))}function S(){if(!e)return;const m=w();m&&(l.current===!0?e.forEach(f=>R(m,f)):e.forEachChanged(f=>R(m,f)),v(!1))}function R(m,f){const{x:j,y}=f.getPosition();m.fillStyle=n&&!f.isSleeping()?"white":f.color,m.fillRect(j*s,y*s,s,s)}return e?p.jsx("canvas",{className:"grid",ref:r,width:`${e.width*s}px`,height:`${e.height*s}px`,...o}):null});function St(){var J;const s=g.useRef(null),n=g.useRef(null),o=g.useRef(),r=g.useRef(),l=g.useRef(),[v,w]=E(!1),[d,S]=E([0,0]),[R,m]=E(void 0),[f,j]=E(!1),[y,A]=E("sand"),[z,it]=g.useState([]);g.useEffect(()=>(o.current=new wt({width:128,height:128}),r.current=o.current.getGrid(),it(q.keys(o.current.materialPalette)),V(),l.current=requestAnimationFrame(U),()=>{l.current!==void 0&&cancelAnimationFrame(l.current)}),[]);function nt(h){h.preventDefault()}function rt(h){const F=h.target,{x:L,y:D,width:K,height:$}=F.getBoundingClientRect();S([(h.clientX-L)/K,(h.clientY-D)/$])}function U(h){var D;const F=o.current;if(!F)return;const L=F.getGrid();ct(L),F.step(),(D=s.current)==null||D.render(),l.current=requestAnimationFrame(U)}function ot(){w(!0)}function at(){w(!1),m(void 0)}function ct(h){if(!v.current||!y.current)return;const[F,L]=d.current,D=new c(Math.floor(F*128),Math.floor(L*128));(R.current?h.getPositionsInLine(R.current,D):[D]).every($=>{var Q;return h.setAtPosition($,q.invoke((Q=o.current)==null?void 0:Q.materialPalette,y.current)),!0}),R.current=D}function V(){const h=o.current;h&&h.restart()}return p.jsxs("div",{className:"route sand",ref:n,children:[p.jsxs("div",{className:"materials",children:[p.jsx("div",{className:"material",children:"reset",onClick:V}),p.jsx("div",{className:"separator"}),q.map(z,h=>p.jsx("div",{className:"material",children:h,onClick:()=>A(h),style:y.current===h?{border:"1px solid white"}:void 0},h)),p.jsx("div",{className:"separator"}),p.jsxs("div",{children:[p.jsx("input",{id:"debugDraw",type:"checkbox",checked:f.current,onChange:h=>j(h.target.checked)}),p.jsx("label",{htmlFor:"debugDraw",children:"debugDraw"})]})]}),p.jsx(Mt,{ref:s,grid:(J=o.current)==null?void 0:J.getGrid(),pixelRatio:4,debugDraw:f.current,onMouseDown:ot,onMouseUp:at,onMouseMove:rt,onContextMenu:nt})]})}export{St as default};

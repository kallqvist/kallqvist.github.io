var xt=Object.defineProperty;var yt=(s,t,e)=>t in s?xt(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var a=(s,t,e)=>(yt(s,typeof t!="symbol"?t+"":t,e),e),K=(s,t,e)=>{if(!t.has(s))throw TypeError("Cannot "+e)};var l=(s,t,e)=>(K(s,t,"read from private field"),e?e.call(s):t.get(s)),S=(s,t,e)=>{if(t.has(s))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(s):t.set(s,e)},M=(s,t,e,i)=>(K(s,t,"write to private field"),i?i.call(s,e):t.set(s,e),e);var ut=(s,t,e,i)=>({set _(n){M(s,t,n,e)},get _(){return l(s,t,i)}}),ct=(s,t,e)=>(K(s,t,"access private method"),e);import{r as p,j as y,_ as dt}from"./index-ZTnS-oeh.js";function z(s){const[t,e]=p.useState(s),i=p.useRef(t);return[i,o=>{o instanceof Function?(i.current=o(i.current),e(o)):(i.current=o,e(o))}]}class u{constructor(t,e){a(this,"x");a(this,"y");this.x=t,this.y=e}add(t){return new u(this.x+t.x,this.y+t.y)}}const g={NW:new u(-1,-1),N:new u(0,-1),NE:new u(1,-1),E:new u(1,0),SE:new u(1,1),S:new u(0,1),SW:new u(-1,1),W:new u(-1,0)},Rt=[g.NW,g.N,g.NE,g.W,g.E,g.SW,g.S,g.SE];var k;class Q{constructor(t,e){a(this,"empty",!1);a(this,"color");a(this,"grid");a(this,"shouldTryAwakeNeighbours");a(this,"index",-1);a(this,"position",new u(0,0));S(this,k,!0);a(this,"brushSize",4);a(this,"brushFillRate",.05);a(this,"maxSpeed",8);a(this,"acceleration",.4);a(this,"velocity",0);a(this,"dir",{NW:()=>this.getNeighbourInDirection(g.NW),N:()=>this.getNeighbourInDirection(g.N),NE:()=>this.getNeighbourInDirection(g.NE),E:()=>this.getNeighbourInDirection(g.E),SE:()=>this.getNeighbourInDirection(g.SE),S:()=>this.getNeighbourInDirection(g.S),SW:()=>this.getNeighbourInDirection(g.SW),W:()=>this.getNeighbourInDirection(g.W)});const{isEmpty:i,shouldTryAwakeNeighbours:n}={shouldTryAwakeNeighbours:!0,...e};this.grid=t,this.shouldTryAwakeNeighbours=n,this.empty=i||!1,this.maxSpeed=8,this.acceleration=.4,this.velocity=0,this.color=this.getRGBA()}isSleeping(){return l(this,k)}sleep(){M(this,k,!0),this.grid.registerChanged(this)}awake(){M(this,k,!1),this.grid.registerChanged(this)}die(){this.grid.set(this.position,new B(this.grid))}getPosition(){return this.grid.positionOf(this)}getNeighbourInDirection(t){return this.grid.getAtPosition(this.position.add(t))}getNeighbourhood(){const t=[];return Rt.forEach(e=>{const i=this.getNeighbourInDirection(e);i&&t.push(i)}),t}swapWith(t){this.grid.swap(this,t)}}k=new WeakMap;class B extends Q{constructor(e){super(e,{isEmpty:!0});a(this,"brushSize",2);a(this,"brushFillRate",1)}getRGBA(){return[50,50,50,255]}awake(){}step(){}}class X extends Q{}class T extends Q{constructor(e,i){super(e,i);a(this,"numFramesOfHorizontalMovement",0);a(this,"maxFramesOfHorizontalMovement",100);a(this,"dispersionRate");a(this,"fallDirection");a(this,"erosionFactor");const{dispersionRate:n,fallDirection:o,erosionFactor:r}=i||{};this.dispersionRate=n||5,this.fallDirection=o||1,this.erosionFactor=r||.03}step(){var o,r;let e=!1;const i=[-this.dispersionRate,this.dispersionRate];Math.random()>.5&&i.reverse(),this.shouldTryAwakeNeighbours&&!this.isSleeping()&&i.every(c=>{const h=this.getNeighbourInDirection(new u(c,0));h!=null&&h.empty||h==null||h.awake(),this.erosionFactor>0&&h instanceof V&&Math.random()<this.erosionFactor&&this.swapWith(h)});const n=this.getNeighbourInDirection(new u(0,this.fallDirection));n!=null&&n.empty?(this.swapWith(n),e=!0,this.numFramesOfHorizontalMovement=0):this.numFramesOfHorizontalMovement<=this.maxFramesOfHorizontalMovement&&i.every(c=>{const h=this.grid;return h.getPositionsInLine(this.position,this.position.add(new u(c,0)),{excludeStart:!0}).every(R=>{const w=h.getAtPosition(R);return w!=null&&w.empty?(this.swapWith(w),e=!0,this.numFramesOfHorizontalMovement++,!1):!(w instanceof X)}),!e}),e||((o=this.dir.W())!=null&&o.empty||(r=this.dir.E())!=null&&r.empty?this.die():this.sleep())}}var P,L;class V extends X{constructor(){super(...arguments);S(this,P,0);S(this,L,100)}step(){let e=!1;const i=[-1,1];Math.random()>=.5&&i.reverse();const n=this.dir.S();n!=null&&n.empty||n instanceof T?(this.swapWith(n),e=!0):this.isSleeping()||i.every(o=>{const r=this.getNeighbourInDirection(new u(o,1));return r!=null&&r.empty||r instanceof T?(this.swapWith(r),e=!0,!1):!0}),e?(i.every(o=>{const r=this.getNeighbourInDirection(new u(o,0));return r!=null&&r.empty||r==null||r.awake(),!0}),M(this,P,0)):(ut(this,P)._++,l(this,P)>=l(this,L)&&this.sleep())}}P=new WeakMap,L=new WeakMap;class Mt extends V{getRGBA(){const t=Math.random()*20;return[191-t,155-t,123-t,255]}}class Z extends T{}class _ extends Z{constructor(t,e){super(t,{...e,dispersionRate:3})}getRGBA(){return[46,137,255,Math.round(Math.random()*100)+155]}die(){this.grid.set(this.position,new ft(this.grid))}}class bt extends X{constructor(e,i){super(e,{shouldTryAwakeNeighbours:!1,...i});a(this,"brushSize",2);a(this,"brushFillRate",1)}awake(){}step(){}}class St extends bt{getRGBA(){return[100,100,100,255]}}class lt extends T{constructor(t,e){super(t,{fallDirection:-1,dispersionRate:3,erosionFactor:0,shouldTryAwakeNeighbours:!1,...e})}step(){const t=this.dir.N();if(t instanceof Z){this.swapWith(t),this.numFramesOfHorizontalMovement=0;return}super.step()}}class vt extends lt{getRGBA(){return[90,90,90,Math.round(Math.random()*185)+70]}}class ft extends lt{getRGBA(){return[255,255,255,Math.round(Math.random()*100)+55]}die(){this.grid.set(this.position,Math.random()<.05?new _(this.grid):new B(this.grid))}}class $ extends V{step(){let e=this.getNeighbourhood().map(i=>i instanceof $?-1:i instanceof X||i instanceof Z?1:0).reduce((i,n)=>i+n);(!e||e>0)&&Math.random()<.01?this.grid.set(this.position,new _(this.grid)):super.step()}getRGBA(){const t=Math.random()*20;return[220-t,220-t,255,255]}}var v,I;class Dt{constructor(t){a(this,"width");a(this,"height");a(this,"alternateRows");a(this,"createEmpty");a(this,"onCellsChanged");S(this,v,void 0);S(this,I,void 0);const{width:e,height:i,alternateRows:n,onCellsChanged:o,createEmpty:r}=t;M(this,v,[]),M(this,I,new Set([])),this.width=e,this.height=i,this.alternateRows=n||!1,this.createEmpty=r,this.onCellsChanged=o,this.clear()}clear(){for(let t=0;t<this.width*this.height;t++)this.setAtIndex(t,this.createEmpty(this))}indexOf(t){return t?t.index:-1}positionOf(t){if(t)return t.position}forEach(t,e){const{alternateRows:i}=e||{},n=new Set;let o=(r,c)=>{const h=this.position2index(new u(r,c)),m=l(this,v)[h];return!m||n.has(m)?!0:t(m,h)===!1?!1:(n.add(m),!0)};for(let r=0;r<this.height;r++){if(i&&r%2===0){for(let h=this.width-1;h>=0;h--)if(o(h,r)===!1)return!1;continue}for(let c=0;c<this.width;c++)o(c,r)}}forEachChanged(t,e=!0){l(this,I).forEach(i=>t(i)),e&&l(this,I).clear()}position2index(t){const{x:e,y:i}=t;return e<0||e>=this.width||i<0||i>=this.height?-1:e+i*this.width}index2position(t){let e=Math.floor(t/this.width),i=t-e*this.width;return new u(i,e)}get(t){return this.getAtPosition(t)}set(t,e){this.setAtPosition(t,e)}getPositionsInLine(t,e,i){const{excludeStart:n,excludeEnd:o}=i||{},r=e.x-t.x,c=e.y-t.y;if(r===0&&c===0)return[t];const h=r<0?-1:1,m=c<0?-1:1,R=Math.abs(r),w=Math.abs(c),F=R>=w,W=Math.min(R,w),f=Math.max(R,w),x=W/f,b=[];for(let E=n?1:0;E<(o?f:f+1);E++){const G=Math.round(E*x);F?b.push(new u(t.x+E*h,t.y+G*m)):b.push(new u(t.x+G*h,t.y+E*m))}return b}getAtPosition(t){const e=this.position2index(t);if(e!==-1)return this.getAtIndex(e)}setAtPosition(t,e){const i=this.position2index(t);this.setAtIndex(i,e)}getAtIndex(t){return l(this,v)[t]}registerChanged(t){l(this,I).add(t)}swap(t,e){const i=this.indexOf(t),n=this.indexOf(e),o=l(this,v)[i];this.setAtIndex(i,l(this,v)[n]),this.setAtIndex(n,o),this.onCellsChanged&&this.onCellsChanged([t,e])}setAtIndex(t,e){e.index=t,e.position=this.index2position(t),l(this,v)[t]=e,this.registerChanged(e)}}v=new WeakMap,I=new WeakMap;var N,C,q,gt;class Nt{constructor(t){S(this,q);S(this,N,void 0);S(this,C,!0);a(this,"materialPalette");const{width:e,height:i}=t;M(this,N,new Dt({width:e,height:i,createEmpty:n=>new B(n),onCellsChanged:n=>n.forEach(o=>o.awake())})),this.materialPalette=ct(this,q,gt).call(this,l(this,N))}isRunning(){return l(this,C)}start(){M(this,C,!0)}stop(){M(this,C,!1)}restart(){this.stop(),l(this,N).clear(),this.start()}getGrid(){return l(this,N)}step(){if(!l(this,C))return;l(this,N).forEach(e=>{e.empty||e.step(-1)},{alternateRows:!0})}}N=new WeakMap,C=new WeakMap,q=new WeakSet,gt=function(t){return{empty:()=>new B(t),sand:()=>new Mt(t),water:()=>new _(t),stone:()=>new St(t),smoke:()=>new vt(t),steam:()=>new ft(t),snow:()=>new $(t)}};const Et=p.forwardRef((s,t)=>{const{grid:e,debugDraw:i,...n}=s,o=p.useRef(null),r=p.useRef(),[c,h]=z(!0);p.useImperativeHandle(t,()=>({clear:w,render:F})),p.useEffect(()=>{h(!0),w()},[e]);function m(){return o.current?o.current.getContext("2d"):null}function R(){if(r.current)return r.current;if(!e)return;const f=m();if(f)return r.current=f.createImageData(e.width,e.height),r.current}function w(){const f=R();f&&(f.data.fill(255),h(!0))}function F(){if(!e)return;const f=m();if(!f)return;const x=R();x&&(c.current===!0?e.forEach(b=>W(x,b)):e.forEachChanged(b=>W(x,b)),f.putImageData(x,0,0),h(!1))}function W(f,x){x.index!==-1&&e&&f.data.set(i&&!x.isSleeping()?[255,255,255,255]:x.color,x.index*4)}return e?y.jsx("div",{className:"grid canvas",children:y.jsx("canvas",{ref:o,width:e.width,height:e.height,...n})}):null});function Ft(){var st;const e=p.useRef(null),i=p.useRef(null),n=p.useRef(),o=p.useRef(),r=p.useRef(),c=p.useRef(void 0),[h,m]=z(!1),[R,w]=z([0,0]),[F,W]=z(!1),[f,x]=z("sand"),[b,E]=p.useState([]);p.useEffect(()=>(n.current=new Nt({width:320,height:180}),o.current=n.current.getGrid(),E(dt.keys(n.current.materialPalette)),it(),r.current=requestAnimationFrame(tt),()=>{r.current!==void 0&&cancelAnimationFrame(r.current)}),[]);function G(d){d.preventDefault()}function mt(d){const A=d.target,{x:j,y:D,width:O,height:nt}=A.getBoundingClientRect();w([(d.clientX-j)/O,(d.clientY-D)/nt])}function tt(d){var D;const A=n.current;if(!A)return;const j=A.getGrid();wt(j),A.step(),(D=e.current)==null||D.render(),r.current=requestAnimationFrame(tt)}function pt(){m(!0)}function et(){m(!1),c.current=void 0}function wt(d){if(!h.current||!f.current)return;const[A,j]=R.current,D=new u(Math.floor(A*320),Math.floor(j*180)),O=n.current;if(!O)return;const Y=O.materialPalette[f.current];if(!Y)return;const H=Y(),rt=Math.floor(H.brushSize);(c.current?d.getPositionsInLine(c.current,D):[D]).every(ot=>{for(let U=-rt;U<H.brushSize;U++)for(let J=-rt;J<H.brushSize;J++){if(Math.random()>H.brushFillRate)continue;const at=ot.x+J;if(at<0)continue;const ht=ot.y+U;ht<0||d.setAtPosition(new u(at,ht),Y())}return!0}),c.current=D}function it(){const d=n.current;d&&d.restart()}return y.jsxs("div",{className:"route sand",ref:i,children:[y.jsxs("div",{className:"materials",children:[y.jsx("div",{className:"material",children:"reset",onClick:it}),y.jsx("div",{className:"separator"}),dt.map(b,d=>y.jsx("div",{className:"material",children:d,onClick:()=>x(d),style:f.current===d?{border:"1px solid white"}:void 0},d)),y.jsx("div",{className:"separator"}),y.jsxs("div",{children:[y.jsx("input",{id:"debugDraw",type:"checkbox",checked:F.current,onChange:d=>W(d.target.checked)}),y.jsx("label",{htmlFor:"debugDraw",children:"debugDraw"})]})]}),y.jsx(Et,{ref:e,grid:(st=n.current)==null?void 0:st.getGrid(),debugDraw:F.current,onMouseDown:pt,onMouseUp:et,onMouseLeave:et,onMouseMove:mt,onContextMenu:G})]})}export{Ft as default};

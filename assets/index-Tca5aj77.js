var rt=Object.defineProperty;var ot=(n,t,e)=>t in n?rt(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var l=(n,t,e)=>(ot(n,typeof t!="symbol"?t+"":t,e),e),$=(n,t,e)=>{if(!t.has(n))throw TypeError("Cannot "+e)};var s=(n,t,e)=>($(n,t,"read from private field"),e?e.call(n):t.get(n)),d=(n,t,e)=>{if(t.has(n))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(n):t.set(n,e)},f=(n,t,e,i)=>($(n,t,"write to private field"),i?i.call(n,e):t.set(n,e),e);var K=(n,t,e)=>($(n,t,"access private method"),e);import{r as E,j as V}from"./index-COOtj4om.js";import"./react-spring_web.modern-77sU6bKG.js";function ht(n){const[t,e]=E.useState(n),i=E.useRef(t);return[i,h=>{h instanceof Function?(i.current=h(i.current),e(h)):(i.current=h,e(h))}]}class tt{constructor(t){l(this,"grid");l(this,"index");l(this,"position");l(this,"dir",{NW:()=>this.getNeighbourInDirection(m.NW),N:()=>this.getNeighbourInDirection(m.N),NE:()=>this.getNeighbourInDirection(m.NE),E:()=>this.getNeighbourInDirection(m.E),SE:()=>this.getNeighbourInDirection(m.SE),S:()=>this.getNeighbourInDirection(m.S),SW:()=>this.getNeighbourInDirection(m.SW),W:()=>this.getNeighbourInDirection(m.W)});this.grid=t,this.index=-1,this.position=new w(0,0)}getNeighbourInDirection(t){if(this.position)return this.grid.getAtPosition(this.position.add(t))}getNeighbourhood(){const t=[];return lt.forEach(e=>{const i=this.getNeighbourInDirection(e);t.push(i)}),t}getLineTo(t,e){return this.grid.getPositionsInLine(this.position,t,e)}swapWith(t){this.grid.swap(this,t)}getRGBA(){return[0,0,0,0]}}var I,N;class _{constructor(t){l(this,"size");l(this,"alternateRows");l(this,"createEmpty");d(this,I,void 0);d(this,N,void 0);const{size:e,alternateRows:i,createEmpty:o}={alternateRows:!1,...t};f(this,I,[]),f(this,N,new Set([])),this.size=e,this.alternateRows=i,this.createEmpty=o?()=>o(this):()=>new tt(this),this.clear()}clear(){this.resetChanges();for(let t=0;t<this.size.x*this.size.y;t++)this.setAtIndex(t,this.createEmpty())}indexOf(t){return t?t.index:-1}positionOf(t){if(t)return t.position}forEach(t,e){const{alternateRowDirections:i,evenRows:o,oddRows:h,evenCols:u,oddCols:p}={evenRows:!0,oddRows:!0,evenCols:!0,oddCols:!0,...e},y=new Set,S=(g,C)=>{const x=this.position2index(new w(g,C)),a=s(this,I)[x];if(!a||y.has(a))return;if(t(a,x)===!1)return!1;y.add(a)};for(let g=0;g<this.size.y;g++){const C=g%2;if(C===0&&!o)continue;if(C===1&&!h)continue;let x;if(i&&g%2===0&&Math.random()<.5){for(let a=this.size.x-1;a>=0;a--){const R=a%2;if(!(R===0&&!u)&&!(R===1&&!p)&&(x=S(a,g),x===!1))break}if(x===!1)break;continue}for(let a=0;a<this.size.x;a++){const R=a%2;if(!(R===0&&!u)&&!(R===1&&!p)&&(x=S(a,g),x===!1))break}if(x===!1)break}}map(t){return s(this,I).map(t)}forEachChanged(t,e=!1){s(this,N).forEach(i=>t(i)),e&&this.resetChanges()}registerChanged(t){s(this,N).has(t)||s(this,N).add(t)}resetChanges(){s(this,N).clear()}position2index(t){const{x:e,y:i}=t;return e<0||e>=this.size.x||i<0||i>=this.size.y?-1:e+i*this.size.x}index2position(t){const e=Math.floor(t/this.size.x),i=t-e*this.size.x;return new w(i,e)}get(t){return this.getAtPosition(t)}set(t,e){this.setAtPosition(t,e)}getPositionsInLine(t,e,i){const{excludeStart:o,excludeEnd:h}=i||{},u=e.x-t.x,p=e.y-t.y;if(u===0&&p===0)return[t];const y=u<0?-1:1,S=p<0?-1:1,g=Math.abs(u),C=Math.abs(p),x=g>=C,a=Math.min(g,C),R=Math.max(g,C),H=a/R,c=[];for(let v=o?1:0;v<(h?R:R+1);v++){const A=Math.round(v*H);x?c.push(new w(t.x+v*y,t.y+A*S)):c.push(new w(t.x+A*y,t.y+v*S))}return c}getAtPosition(t){const e=this.position2index(t);if(e!==-1)return this.getAtIndex(e)}setAtPosition(t,e){const i=this.position2index(t);this.setAtIndex(i,e)}getAtIndex(t){return s(this,I)[t]}swap(t,e){const i=this.indexOf(t),o=this.indexOf(e);if(i===-1||o===-1)throw new Error("Can't swap unless both cells exists in the grid");const h=s(this,I)[i];this.setAtIndex(i,s(this,I)[o]),this.setAtIndex(o,h)}setAtIndex(t,e){e.index=t,e.position=this.index2position(t),s(this,I)[t]=e,this.registerChanged(e)}}I=new WeakMap,N=new WeakMap;var M;class at extends tt{constructor(){super(...arguments);d(this,M,new Set)}haveChanges(){return s(this,M).size>0}registerChange(e){s(this,M).has(e)||s(this,M).add(e)}resetChanges(){s(this,M).clear()}forEachChangedCell(e,i=!1){s(this,M).forEach(o=>e(o)),i&&this.resetChanges()}}M=new WeakMap;function ut(n){return new Worker("/assets/worker-G1OrwRg-.js",{name:n==null?void 0:n.name})}var k,G,P,q,Q,et,U,it,X,st;class ct extends _{constructor(e){const{chunkSize:i,workerize:o,...h}=e;super(h);d(this,Q);d(this,U);d(this,X);l(this,"chunkSize",new w(64,64));d(this,k,void 0);d(this,G,void 0);d(this,P,void 0);d(this,q,[]);this.chunkSize=i||new w(64,64),f(this,k,new _({size:this.size.divide(this.chunkSize),createEmpty:u=>new at(u)})),f(this,G,o||!1),s(this,G)&&(f(this,P,new ut),s(this,P).onmessage=this.handleWorkerResponse),K(this,Q,et).call(this)}chunkOf(e){if(!e||!this.chunkSize)return;const i=e.position.divide(this.chunkSize).floor();return s(this,k).get(i)}forEachChunk(e,i){s(this,k).forEach(e,i)}mapChunks(e){return s(this,k).map(e)}forEachChangedChunkPass(e,i=!1){this.forEachChunkPass(o=>{const h=o.filter(u=>u.haveChanges());h.length!==0&&(e(h),i&&h.forEach(u=>u.resetChanges()))})}forEachChunkPass(e){s(this,q).forEach((i,o)=>{s(this,G)?K(this,X,st).call(this,()=>e(i,o)):e(i,o)})}handleWorkerResponse(e){console.log("worker says:",this,e.data)}}k=new WeakMap,G=new WeakMap,P=new WeakMap,q=new WeakMap,Q=new WeakSet,et=function(){for(let e=0;e<s(this,k).size.x*s(this,k).size.y;e++)s(this,k).setAtIndex(e,s(this,k).createEmpty());K(this,U,it).call(this)},U=new WeakSet,it=function(){const e=[[!1,!1],[!1,!0],[!0,!1],[!0,!0]],i=[];e.forEach(([o,h])=>{const u=[];this.forEachChunk(p=>{u.push(p)},{evenRows:!o,oddRows:o,evenCols:!h,oddCols:h}),i.push(u)}),f(this,q,i)},X=new WeakSet,st=function(e){s(this,P)&&s(this,P).postMessage({f:e})};const r=class r{constructor(t=0,e=0){l(this,"x");l(this,"y");this.x=t,this.y=e}clone(){return new r(this.x,this.y)}add(t){return new r(this.x+t.x,this.y+t.y)}addScalar(t){return new r(this.x+t,this.y+t)}subtract(t=r.zero){return new r(this.x-t.x,this.y-t.y)}subtractScalar(t){return new r(this.x-t,this.y-t)}multiply(t){return new r(this.x*t.x,this.y*t.y)}multiplyScalar(t){return new r(this.x*t,this.y*t)}divide(t){return new r(this.x/t.x,this.y/t.y)}divideScalar(t){return new r(this.x/t,this.y/t)}mod(t){return new r(this.x%t.x,this.y%t.y)}modScalar(t){return new r(this.x%t,this.y%t)}abs(){return new r(Math.abs(this.x),Math.abs(this.y))}round(){return new r(Math.round(this.x),Math.round(this.y))}floor(){return new r(Math.floor(this.x),Math.floor(this.y))}ceil(){return new r(Math.ceil(this.x),Math.ceil(this.y))}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){const t=this.length();return t===0?r.zero:this.multiplyScalar(1/t)}dot(t){const e=this.multiply(t);return e.x+e.y}isEqual(t){return this.x===t.x&&this.y===t.y}isNear(t,e=.001){const i=this.subtract(t).abs();return i.x<=e&&i.y<=e}toArray(){return[this.x,this.y]}join(t){return this.toArray().join(t)}static fromArray([t,e]){return new r(t,e)}static random(){return new r(Math.random(),Math.random())}};l(r,"zero",new r),l(r,"one",new r(1,1)),l(r,"up",new r(0,-1)),l(r,"down",new r(0,1)),l(r,"left",new r(-1,0)),l(r,"right",new r(1,0));let w=r;const m={NW:new w(-1,-1),N:new w(0,-1),NE:new w(1,-1),E:new w(1,0),SE:new w(1,1),S:new w(0,1),SW:new w(-1,1),W:new w(-1,0)},lt=[m.NW,m.N,m.NE,m.W,m.E,m.SW,m.S,m.SE];class yt{constructor(t){l(this,"grid");const{gridOptions:e}=t;this.grid=this.createGrid(e)}clear(){this.grid.clear()}}function ft(n,t){const{children:e,grid:i,debugDraw:o,pickColor:h,...u}={debugDraw:!1,...n},p=E.useRef(null),y=E.useRef(),[S,g]=ht(!0);E.useImperativeHandle(t,()=>({clear:a,render:R})),E.useEffect(()=>{i&&(a(),R(i))},[i]);function C(){return p.current?p.current.getContext("2d"):null}function x(){if(y.current)return y.current;const c=C();if(c)return y.current=c.createImageData(...i.size.toArray()),y.current}function a(){const c=x();c&&(c.data.fill(0),g(!0))}function R(c,v={debugDraw:o}){const{debugDraw:A,resetChanges:B}={debugDraw:!1,resetChanges:!1,...v};if(!c)return;const b=C();if(!b)return;const J=x();J&&(S.current===!0?c.forEach(T=>H({imageData:J,cell:T})):c.forEachChanged(T=>H({imageData:J,cell:T}),B),b.putImageData(J,0,0),A&&c instanceof ct&&(b.lineWidth=.25,b.textAlign="right",c.forEachChunkPass((T,nt)=>{T.forEach(Y=>{b.strokeStyle=Y.haveChanges()?"white":"black",b.fillStyle=b.strokeStyle;const Z=Y.position.multiply(c.chunkSize);b.strokeRect(...Z.toArray(),...c.chunkSize.toArray()),b.fillText(Y.position.toArray().toString(),...Z.add(c.chunkSize).subtractScalar(2).toArray()),b.fillText(nt.toString(),...Z.add(c.chunkSize.divideScalar(2)).toArray())})})),g(!1))}function H(c){const{imageData:v,cell:A}=c;if(A.index===-1)return;const B=h?h({cell:A}):A.getRGBA();B&&v.data.set(B,A.index*4)}if(i)return V.jsxs("div",{className:"grid canvas",children:[V.jsx("canvas",{ref:p,width:i.size.x||1,height:i.size.y||1,...u}),e]})}const dt=E.forwardRef(ft);var D,O,z,j,W,L,F;class gt{constructor(t){d(this,D,void 0);d(this,O,void 0);d(this,z,void 0);l(this,"limitFps");d(this,j,void 0);d(this,W,!0);d(this,L,void 0);d(this,F,void 0);const{gridRenderer:e,renderOptions:i,simulation:o,limitFps:h,onStep:u}=t;f(this,D,e),f(this,O,i),f(this,z,o),this.limitFps=h,f(this,j,u),this._stepInternal=this._stepInternal.bind(this),this.start()}_stepInternal(t){s(this,W)!==!1&&(this.step(t),f(this,L,requestAnimationFrame(this._stepInternal)))}get simulation(){return s(this,z)}destroy(){var t,e;this.stop(),(t=s(this,z))==null||t.clear(),(e=s(this,D))==null||e.clear()}start(){s(this,W)||(f(this,W,!0),this._stepInternal(Date.now()))}stop(){f(this,W,!1),s(this,L)!==void 0&&cancelAnimationFrame(s(this,L))}restart(){this.destroy(),this.start()}isRunning(){return s(this,W)}registerSimulation(t){s(this,z)&&this.destroy(),f(this,z,t)}registerGridRenderer(t,e){f(this,D,t),e&&f(this,O,e)}step(t){if(s(this,F)===void 0)f(this,F,t);else{const e=(t-s(this,F))/1e3;if(this.limitFps===void 0||e>1/this.limitFps){if(s(this,z)){const i=s(this,z).grid;if(!i)throw new Error("simulation or grid must be provided");s(this,z).step(e),s(this,j)&&s(this,j).call(this,{grid:i,deltaTime:e}),s(this,D)&&s(this,D).render(i,{resetChanges:!1,...s(this,O)}),i.resetChanges()}f(this,F,t)}}}}D=new WeakMap,O=new WeakMap,z=new WeakMap,j=new WeakMap,W=new WeakMap,L=new WeakMap,F=new WeakMap;function xt(n,t){var C,x;const{limitFps:e,renderOptions:i,children:o,initSimulation:h,onStep:u,...p}=n,y=E.useRef(null),S=E.useRef(null);E.useImperativeHandle(t,()=>S.current),E.useEffect(()=>{if(y.current&&!S.current)return S.current=new gt({gridRenderer:y.current,simulation:h(),limitFps:e,renderOptions:i,onStep:u}),()=>{var a;(a=S.current)==null||a.destroy()}},[]);function g(a){a.preventDefault()}return V.jsx(dt,{ref:y,grid:(x=(C=S.current)==null?void 0:C.simulation)==null?void 0:x.grid,children:o,onContextMenu:g,...p})}const Ct=E.forwardRef(xt);export{ct as C,tt as G,yt as S,w as V,Ct as a,_ as b,lt as n,ht as u};

var it=Object.defineProperty;var st=(i,t,e)=>t in i?it(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var l=(i,t,e)=>(st(i,typeof t!="symbol"?t+"":t,e),e),G=(i,t,e)=>{if(!t.has(i))throw TypeError("Cannot "+e)};var h=(i,t,e)=>(G(i,t,"read from private field"),e?e.call(i):t.get(i)),I=(i,t,e)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,e)},S=(i,t,e,n)=>(G(i,t,"write to private field"),n?n.call(i,e):t.set(i,e),e);var T=(i,t,e)=>(G(i,t,"access private method"),e);import{r as m,_ as X,j as x}from"./index-e-pD5Thr.js";function J(i){const[t,e]=m.useState(i),n=m.useRef(t);return[n,s=>{s instanceof Function?(n.current=s(n.current),e(s)):(n.current=s,e(s))}]}class c{constructor(t,e){l(this,"x");l(this,"y");this.x=t,this.y=e}add(t){return new c(this.x+t.x,this.y+t.y)}}const y={NW:new c(-1,-1),N:new c(0,-1),NE:new c(1,-1),E:new c(1,0),SE:new c(1,1),S:new c(0,1),SW:new c(-1,1),W:new c(-1,0)};function rt(i,t){const[e,n,r]=i;if(t===void 0)return`hsl(${e}, ${n}%, ${r}%)`;const[s,o,u]=F(i,t);return`hsl(${s}, ${o}%, ${u}%)`}function F(i,t=[Math.round(Math.random()*10),Math.round(Math.random()*10),Math.round(Math.random()*10)]){const[e,n,r]=i,[s=0,o=0,u=0]=t||[];return[Math.min(Math.max(e+Math.round(Math.random()*(s*2))-s,0),360),Math.min(Math.max(n+Math.round(Math.random()*(o*2))-o,0),100),Math.min(Math.max(r+Math.round(Math.random()*(u*2))-u,0),100)]}var A;class z{constructor(t,e){l(this,"empty",!1);l(this,"color");l(this,"grid");I(this,A,!0);l(this,"dir",{NW:()=>this.neighbourInDirection(y.NW),N:()=>this.neighbourInDirection(y.N),NE:()=>this.neighbourInDirection(y.NE),E:()=>this.neighbourInDirection(y.E),SE:()=>this.neighbourInDirection(y.SE),S:()=>this.neighbourInDirection(y.S),SW:()=>this.neighbourInDirection(y.SW),W:()=>this.neighbourInDirection(y.W)});const{isEmpty:n}=e||{};this.grid=t,this.empty=n||!1,this.color=rt(this.getHSL())}isSleeping(){return h(this,A)}sleep(){S(this,A,!0)}awake(){S(this,A,!1)}neighbourInDirection(t){const e=this.grid,n=e.positionOf(this).add(t);return e.getAtPosition(n)}swap(t){this.getHSL(),this.grid.swap(this,t)}}A=new WeakMap;class Q extends z{constructor(t){super(t,{isEmpty:!0})}awake(){}getHSL(){return[50,0,20]}step(){}}class E extends z{constructor(e,n){super(e,n);l(this,"dispersionRate");l(this,"fallDirection");l(this,"erosionFactor");const{dispersionRate:r,fallDirection:s,erosionFactor:o}=n||{};this.dispersionRate=r||5,this.fallDirection=s||1,this.erosionFactor=o||.01}step(){let e=!1;const n=[-this.dispersionRate,this.dispersionRate];Math.random()>=.5&&n.reverse(),this.isSleeping()||n.every(s=>{const o=this.neighbourInDirection(new c(s,0));o!=null&&o.empty||o==null||o.awake(),this.erosionFactor>0&&o instanceof _&&Math.random()<this.erosionFactor&&this.swap(o)});const r=this.neighbourInDirection(new c(0,this.fallDirection));r!=null&&r.empty?(this.swap(r),e=!0):n.every(s=>{const o=this.grid,u=o.positionOf(this);return o.getLine(u,u.add(new c(s,0)),{excludeStart:!0}).every(v=>{const p=o.getAtPosition(v);return p!=null&&p.empty?(this.swap(p),e=!0,!1):!0}),!e}),e||this.sleep()}}class Z extends z{}class _ extends Z{step(){let t=!1;const e=[-1,1];Math.random()>=.5&&e.reverse();const n=this.dir.S();n!=null&&n.empty||n instanceof E?(this.swap(n),t=!0):this.isSleeping()||e.every(r=>{const s=this.neighbourInDirection(new c(r,1));return s!=null&&s.empty||s instanceof E?(this.swap(s),t=!0,!1):!0}),t?e.every(r=>{const s=this.neighbourInDirection(new c(r,-1));return s!=null&&s.empty||s==null||s.awake(),!0}):this.sleep()}}class ot extends _{getHSL(){return F([27.8,31.8,58.6])}}class at extends E{constructor(t,e){super(t,{...e,dispersionRate:3})}getHSL(){return F([216,100,60],[5,5,3])}}class ct extends Z{awake(){}step(){}}class ht extends ct{getHSL(){return F([150,5,58.6],[5,0,5])}}class B extends E{constructor(t,e){super(t,{fallDirection:-1,dispersionRate:2,erosionFactor:0,...e})}step(){if(super.step(),Math.random()<.98){const t=this.dir.N();t instanceof E&&!(t instanceof B)&&this.swap(t)}else{const t=[-1,1];Math.random()>=.5&&t.reverse(),t.every(e=>{const n=this.neighbourInDirection(new c(e,0));return n!=null&&n.empty||n instanceof E?(this.swap(n),!1):!0})}}}class ut extends B{getHSL(){return F([200,10,38.6],[5,0,5])}}var d;class K{constructor(t,e){l(this,"width");l(this,"height");I(this,d,void 0);this.width=t,this.height=e,S(this,d,[]),this.clear()}clear(){for(let t=0;t<this.width*this.height;t++)h(this,d)[t]=new Q(this)}indexOf(t,e){return t?h(this,d).indexOf(t,e):-1}positionOf(t,e){const n=this.indexOf(t,e);return this.index2position(n)}forEach(t){const e=[];for(let n=0;n<h(this,d).length;n++){const r=h(this,d)[n];if(e.indexOf(r)!==-1)continue;if(t(r,n)===!1)break;e.push(r)}}position2index(t){const{x:e,y:n}=t;return e<0||e>=this.width||n<0||n>=this.height?-1:e+n*this.width}index2position(t){let e=Math.floor(t/this.width),n=t-e*this.width;return new c(n,e)}get(t){return this.getAtPosition(t)}set(t,e){this.setAtPosition(t,e)}getLine(t,e,n){const{excludeStart:r,excludeEnd:s}=n||{},o=e.x-t.x,u=e.y-t.y;if(o===0&&u===0)return[t];const b=o<0?-1:1,v=u<0?-1:1,p=Math.abs(o),k=Math.abs(u),C=p>=k,L=Math.min(p,k),j=Math.max(p,k),$=L/j,H=[];for(let M=r?1:0;M<(s?j:j+1);M++){const W=Math.round(M*$);C?H.push(new c(t.x+M*b,t.y+W*v)):H.push(new c(t.x+W*b,t.y+M*v))}return H}getAtPosition(t){const e=this.position2index(t);if(e!==-1)return this.getAtIndex(e)}setAtPosition(t,e){const n=this.position2index(t);this.setAtIndex(n,e)}getAtIndex(t){return h(this,d)[t]}setAtIndex(t,e){h(this,d)[t]=e}swap(t,e){const n=this.indexOf(t),r=this.indexOf(e),s=h(this,d)[n];this.setAtIndex(n,h(this,d)[r]),this.setAtIndex(r,s),t.awake(),e.awake()}}d=new WeakMap;var g,R,P,Y;class lt{constructor(t){I(this,P);I(this,g,void 0);I(this,R,!0);l(this,"materialPalette");const{width:e,height:n}=t;S(this,g,new K(e,n)),this.materialPalette=T(this,P,Y).call(this,h(this,g))}isRunning(){return h(this,R)}start(){S(this,R,!0)}stop(){S(this,R,!1)}restart(){stop();const{width:t,height:e}=h(this,g);S(this,g,new K(t,e));const n=T(this,P,Y).call(this,h(this,g));for(const r in n)this.materialPalette[r]=n[r];this.start()}getGrid(){return h(this,g)}step(){if(!h(this,R))return;h(this,g).forEach(e=>{e.step(-1)})}}g=new WeakMap,R=new WeakMap,P=new WeakSet,Y=function(t){return{empty:()=>new Q(t),sand:()=>new ot(t),water:()=>new at(t),stone:()=>new ht(t),smoke:()=>new ut(t)}};function mt(){const n=m.useRef(null),r=m.useRef(null),s=m.useRef(),o=m.useRef(),u=m.useRef(!1),b=m.useRef([0,0]),[v,p]=J(!1),[k,C]=m.useState([]),[L,j]=J("sand");m.useEffect(()=>(s.current=new lt({width:75,height:75}),C(X.keys(s.current.materialPalette)),o.current=requestAnimationFrame(M),()=>{o.current!==void 0&&cancelAnimationFrame(o.current)}),[]);function $(a){a.preventDefault()}function H(a){if(!r.current)return;const{x:f,y:w,width:D,height:O}=r.current.getBoundingClientRect();b.current=[(a.clientX-f)/D,(a.clientY-w)/O]}function M(a){const f=s.current;if(!f)return;const w=f.getGrid();et(w),f.step(),W(w),o.current=requestAnimationFrame(M)}function W(a){const f=r.current?r.current.getContext("2d"):null;f&&a.forEach((w,D)=>{const{x:O,y:q}=a.index2position(D);f.fillStyle=v.current&&!w.isSleeping()?"white":w.color,f.fillRect(O*8,q*8,8,8)})}const N=m.useRef();function tt(){u.current=!0}function U(){u.current=!1,N.current=void 0}function et(a){if(!u.current||!L.current)return;const[f,w]=b.current,D=new c(Math.floor(f*75),Math.floor(w*75));(N.current?a.getLine(N.current,D):[D]).every(q=>{var V;return a.setAtPosition(q,X.invoke((V=s.current)==null?void 0:V.materialPalette,L.current)),!0}),N.current=D}function nt(){const a=s.current;a&&a.restart()}return x.jsxs("div",{className:"route sand",ref:n,children:[x.jsxs("div",{className:"materials",children:[x.jsx("div",{className:"material",children:"reset",onClick:nt}),x.jsx("div",{className:"separator"}),X.map(k,a=>x.jsx("div",{className:"material",children:a,onClick:()=>j(a),style:L.current===a?{border:"1px solid white"}:void 0},a)),x.jsx("div",{className:"separator"}),x.jsxs("div",{children:[x.jsx("input",{id:"debugDraw",type:"checkbox",checked:v.current,onChange:a=>p(a.target.checked)}),x.jsx("label",{htmlFor:"debugDraw",children:"debugDraw"})]})]}),x.jsx("canvas",{ref:r,width:`${75*8}px`,height:`${75*8}px`,onMouseDown:tt,onMouseUp:U,onMouseLeave:U,onMouseMove:H,onContextMenu:$})]})}export{mt as default};

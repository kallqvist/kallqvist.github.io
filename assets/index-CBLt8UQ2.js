var Ce=Object.defineProperty;var De=(r,t,e)=>t in r?Ce(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var i=(r,t,e)=>(De(r,typeof t!="symbol"?t+"":t,e),e),q=(r,t,e)=>{if(!t.has(r))throw TypeError("Cannot "+e)};var m=(r,t,e)=>(q(r,t,"read from private field"),e?e.call(r):t.get(r)),w=(r,t,e)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,e)},x=(r,t,e,s)=>(q(r,t,"write to private field"),s?s.call(r,e):t.set(r,e),e);var O=(r,t,e,s)=>({set _(n){x(r,t,n,e)},get _(){return m(r,t,s)}}),oe=(r,t,e)=>(q(r,t,"access private method"),e);import{r as v,_ as he,j as f}from"./index-7oyLkAmy.js";import{G as ke,V as c,a as je,u as W,b as _e}from"./index-BRCHQMSm.js";var A;class V extends ke{constructor(e,s){super(e);i(this,"empty");i(this,"shouldTryAwakeNeighbours");i(this,"color");i(this,"behaviors");w(this,A,!1);i(this,"index",-1);i(this,"position",new c(0,0));i(this,"age",0);i(this,"brushSize",4);i(this,"brushFillRate",.05);i(this,"velocity",new c(0,0));const{empty:n,shouldTryAwakeNeighbours:a,behaviors:d}={empty:!1,shouldTryAwakeNeighbours:!0,behaviors:[],...s};this.empty=n,this.shouldTryAwakeNeighbours=a,this.color=this.getRGBA(),this.behaviors=d}isSleeping(){return m(this,A)}sleep(){x(this,A,!0),this.grid.registerChanged(this)}awake(){x(this,A,!1),this.grid.registerChanged(this)}die(){this.grid.set(this.position,new D(this.grid))}getRGBA(){return this.color}addBehaviors(...e){this.behaviors.push(...e)}step(e){this.age+=e,this.behaviors.forEach(s=>{s.step({deltaTime:e,cell:this,grid:this.grid})})}}A=new WeakMap;class D extends V{constructor(e){super(e,{empty:!0});i(this,"brushSize",2);i(this,"brushFillRate",1);i(this,"color",[50,50,50,255]);this.sleep()}awake(){}step(){}}class g{}class ue extends V{constructor(t,e){super(t,e);const{gravity:s,dispersionRate:n,erosionFactor:a}=e||{};this.addBehaviors(new de(s),new Ne(n),new Be(a))}}class k extends ue{}class X extends g{constructor(e=1){super();i(this,"sinkChance");this.sinkChance=e}step({cell:e}){if(Math.random()>this.sinkChance)return;const s=e.dir.S();if(s instanceof k){e.swapWith(s);return}const n=[-1,1];Math.random()>=.5&&n.reverse(),n.every(a=>{const d=e.getNeighbourInDirection(new c(a,1));return d instanceof k?(e.swapWith(d),!1):!0})}}class ce extends g{constructor(e=1){super();i(this,"floatChance");this.floatChance=e}step({cell:e}){if(Math.random()>this.floatChance)return;const s=e.dir.N();if(s instanceof k){e.swapWith(s);return}}}class z extends V{}var N,G;class Ne extends g{constructor(e=50){super();w(this,N,0);w(this,G,100+Math.random()*25);i(this,"dispersionRate");this.dispersionRate=e}step({cell:e,grid:s}){var d,u;let n=!1;const a=[-1,1];Math.random()>=.5&&a.reverse(),e.isSleeping()&&a.every(l=>{const h=e.getNeighbourInDirection(new c(l,0));return h!=null&&h.empty?(e.swapWith(h),!1):!0}),m(this,N)<=m(this,G)?a.every(l=>(s.getPositionsInLine(e.position,e.position.add(new c(l*this.dispersionRate,0)),{excludeStart:!0}).every(h=>{const p=s.getAtPosition(h);return p!=null&&p.empty?(e.swapWith(p),n=!0,O(this,N)._++,!1):!(p instanceof z)}),!n)):((d=e.dir.W())!=null&&d.empty||(u=e.dir.E())!=null&&u.empty)&&e.die()}}N=new WeakMap,G=new WeakMap;class j extends z{constructor(t,e){super(t,e),this.addBehaviors(new de)}}class Be extends g{constructor(e=.005){super();i(this,"erosionFactor");this.erosionFactor=e}step({cell:e}){if(this.erosionFactor>0){const s=e.dir.S();s instanceof j&&Math.random()<this.erosionFactor&&e.swapWith(s)}}}class Y extends z{constructor(e,s){super(e,{shouldTryAwakeNeighbours:!1,...s});i(this,"brushSize",2);i(this,"brushFillRate",1);this.sleep()}awake(){}step(){}}var C,P;class de extends g{constructor(e=new c(0,9)){super();w(this,C,0);w(this,P,100);i(this,"isFalling",!1);i(this,"gravity");this.gravity=e}step({cell:e,grid:s,deltaTime:n}){let a=!1;const d=[-1,1];if(Math.random()>=.5&&d.reverse(),e.isSleeping()){const u=e.getNeighbourInDirection(this.gravity.y<0?c.up():c.down());u!=null&&u.empty&&(e.swapWith(u),a=!0,this.isFalling=!0)}else{e.velocity=e.velocity.add(this.gravity.multiplyScalar(n));let u=e;e.getLineTo(e.position.add(e.velocity),{excludeStart:!0}).every(l=>{const h=s.get(l);if(!(h!=null&&h.empty)){if(this.isFalling&&(h instanceof Y||h instanceof j)){const p=e.velocity.subtract((h==null?void 0:h.velocity)||c.zero()).abs(),E=Math.random()*.2,_=Math.random()*.05;p.length()>0&&(e.velocity=new c(e.velocity.x+(Math.random()<.5?-1:1)*p.y*E,-p.y*_),u=e,this.isFalling=!1)}return!1}return u=h,!0}),u!==e?(e.swapWith(u),a=!0):d.every(l=>{const h=e.getNeighbourInDirection(new c(l,1));return h!=null&&h.empty?(e.swapWith(h),a=!0,!1):!0})}a?(d.every(u=>{const l=e.getNeighbourInDirection(new c(u,0));return l!=null&&l.empty||l==null||l.awake(),!0}),x(this,C,0)):(this.isFalling=!1,O(this,C)._++,m(this,C)>=m(this,P)&&e.sleep())}}C=new WeakMap,P=new WeakMap;class We extends g{constructor(e=.05,s=1,n=2){super();i(this,"jumpChance");i(this,"jumpHeight");i(this,"jumpLength");this.jumpChance=e,this.jumpHeight=s,this.jumpLength=n}step({cell:e}){if(e.velocity&&Math.random()<this.jumpChance){const s=(Math.random()*2-1)*this.jumpLength,n=-Math.random()*this.jumpHeight;e.velocity=new c(s,n),Math.random()<.1&&(e.velocity=e.velocity.multiplyScalar(1.2)),e.awake()}}}class le extends g{constructor(e,s=1){super();i(this,"maxAge");i(this,"survivalChance");this.maxAge=e,this.survivalChance=s}step({cell:e}){Math.random()<this.survivalChance||e.age>this.maxAge&&e.die()}}class Ge extends g{constructor(e=.05){super();i(this,"survivalChance");this.survivalChance=e}step({cell:e}){if(Math.random()<this.survivalChance)return;e.getNeighbourhood().map(a=>a instanceof k?1:0).reduce((a,d)=>a+d)>2&&e.die()}}class Pe extends g{constructor(e,s=3,n=5,a=.005){super();i(this,"spawn");i(this,"breedMinAge");i(this,"breedMaxAge");i(this,"breedChance");this.spawn=e,this.breedMinAge=s,this.breedMaxAge=n,this.breedChance=a}step({cell:e,grid:s}){if(e.isSleeping()||e.age<this.breedMinAge||e.age>this.breedMaxAge||Math.random()>this.breedChance)return;const n=e.dir.S();n&&n.constructor.prototype===e.constructor.prototype&&(n.age<this.breedMinAge||n.age>this.breedMaxAge||e.getNeighbourhood().every(a=>a!=null&&a.empty?(s.setAtIndex(a.index,this.spawn()),!1):!0))}}class Ie extends g{step({cell:t}){if(!t.isSleeping()||Math.random()<.995)return;t.getNeighbourhood().map(n=>n===void 0?1:n.empty?.5:n instanceof pe?-1:n instanceof z?2:n instanceof k?1:0).reduce((n,a)=>n+a)>0&&t.die()}}class J extends j{constructor(e,s){super(e,s);i(this,"_r",Math.random()*20);i(this,"color",[this._r,100+this._r,this._r,255]);i(this,"brushFillRate",.005);const n=5;this.addBehaviors(new We,new ce,new Pe(()=>new J(e),3,n,.05),new Ge(.95),new le(n,.995))}die(){this.grid.setAtIndex(this.index,new ze(this,this.grid))}}class ze extends j{constructor(e,s,n){super(s,n);i(this,"_r",Math.random()*20);i(this,"color");this.color=[...e.color.slice(0,3),200],this.addBehaviors(new X(.05),new le(10,.995))}die(){this.grid.setAtIndex(this.index,new me(this.grid))}}class me extends j{constructor(e,s){super(e,s);i(this,"_r",Math.random()*20);i(this,"color",[191-this._r,155-this._r,123-this._r,255]);this.addBehaviors(new X)}}class fe extends ue{constructor(t,e){super(t,{dispersionRate:8,gravity:new c(0,-.25),erosionFactor:0,shouldTryAwakeNeighbours:!1,...e}),this.addBehaviors(new ce(.2)),this.velocity=this.velocity.add(c.random().multiplyScalar(2).add(c.one().multiplyScalar(-1)).multiplyScalar(.025).multiply(c.right()))}}class Ee extends fe{constructor(){super(...arguments);i(this,"color",[90,90,90,Math.round(Math.random()*185)+70])}}class pe extends j{constructor(e,s){super(e,s);i(this,"_r",Math.random()*20);i(this,"color",[220-this._r,220-this._r,255,255]);this.addBehaviors(new Ie,new X(.05))}getRGBA(){return this.isSleeping()?this.color:[220,220,255,255]}die(){this.grid.set(this.position,Math.random()<.25?new U(this.grid):new D(this.grid))}}class ge extends fe{constructor(){super(...arguments);i(this,"_r",Math.round(Math.random()*80)+100);i(this,"color",[255,255,255,this._r])}die(){this.grid.set(this.position,Math.random()<.05?new U(this.grid):new D(this.grid))}}class Te extends Y{constructor(){super(...arguments);i(this,"color",[100,100,100,255])}}class U extends k{constructor(e,s){super(e,{...s,dispersionRate:3});i(this,"_r",Math.round(Math.random()*100)+155);i(this,"color",[46,137,255,this._r])}die(){this.grid.set(this.position,Math.random()<.25?new ge(this.grid):new D(this.grid))}}class Le extends Y{constructor(){super(...arguments);i(this,"_r",Math.random()*20);i(this,"color",[180-this._r,100-this._r,100-this._r,255-this._r])}}var M,F,I,we;class He{constructor(t){w(this,I);w(this,M,void 0);w(this,F,!0);i(this,"materialPalette");x(this,M,new je({...t,createEmpty:e=>new D(e)})),this.materialPalette=oe(this,I,we).call(this,m(this,M))}isRunning(){return m(this,F)}start(){x(this,F,!0)}stop(){x(this,F,!1)}restart(){this.stop(),m(this,M).clear(),this.start()}getGrid(){return m(this,M)}step(t){if(!m(this,F))return;m(this,M).forEach(s=>{s.empty||s.step(t)},{alternateRows:!0})}}M=new WeakMap,F=new WeakMap,I=new WeakSet,we=function(t){return{empty:()=>new D(t),flea:()=>new J(t),sand:()=>new me(t),smoke:()=>new Ee(t),snow:()=>new pe(t),steam:()=>new ge(t),stone:()=>new Te(t),water:()=>new U(t),wood:()=>new Le(t)}};function Ye(){var te;const e=v.useRef(null),s=v.useRef(),n=v.useRef(),a=v.useRef(),d=v.useRef(),u=v.useRef(void 0),[l,h]=W(!1),[p,E]=W([0,0]),[_,ve]=W("sand"),[K,ye]=v.useState([0]),[Q,xe]=W(!1),[Me,be]=v.useState([]);v.useEffect(()=>(s.current=new He({width:320,height:180}),n.current=s.current.getGrid(),be(he.keys(s.current.materialPalette)),ee(),a.current=requestAnimationFrame(Z),()=>{a.current!==void 0&&cancelAnimationFrame(a.current)}),[]);function Se(o){o.preventDefault()}function Re(o){const y=o.target,{x:b,y:S,width:R,height:se}=y.getBoundingClientRect();E([(o.clientX-b)/R,(o.clientY-S)/se])}function Z(o){if(d.current===void 0)d.current=o;else{const y=(o-d.current)/1e3;{const b=s.current;if(!b)return;const S=b.getGrid();Ae(S),b.step(y),d.current=o,ye(R=>[...R.slice(R.length-100),1/y])}}a.current=requestAnimationFrame(Z)}function Fe(){h(!0)}function $(){h(!1),u.current=void 0}function Ae(o){if(!l.current||!_.current)return;const[y,b]=p.current,S=new c(Math.floor(y*o.width),Math.floor(b*o.height)),R=s.current;if(!R)return;const T=R.materialPalette[_.current];if(!T)return;const B=T(),re=Math.floor(B.brushSize);(u.current?o.getPositionsInLine(u.current,S):[S]).every(ie=>{for(let L=-re;L<B.brushSize;L++)for(let H=-re;H<B.brushSize;H++){if(Math.random()>B.brushFillRate)continue;const ne=ie.x+H;if(ne<0)continue;const ae=ie.y+L;ae<0||o.setAtPosition(new c(ne,ae),T())}return!0}),u.current=S}function ee(){const o=s.current;o&&o.restart()}return f.jsxs("div",{className:"route sand",ref:e,children:[f.jsxs("div",{className:"materials",children:[f.jsx("div",{className:"material",children:"reset",onClick:ee}),f.jsx("div",{className:"separator"}),he.map(Me,o=>f.jsx("div",{className:"material",children:o,onClick:()=>ve(o),style:_.current===o?{border:"1px solid white"}:void 0},o)),f.jsx("div",{className:"separator"}),f.jsxs("div",{children:[f.jsx("input",{id:"debugDraw",type:"checkbox",checked:Q.current,onChange:o=>xe(o.target.checked)}),f.jsx("label",{htmlFor:"debugDraw",children:"debugDraw"})]}),f.jsx("div",{className:"separator"}),f.jsxs("div",{style:{width:"60px",whiteSpace:"nowrap"},children:["fps: ",Math.round(K.reduce((o,y)=>o+y)/K.length||1)]})]}),f.jsx(_e,{grid:(te=s.current)==null?void 0:te.getGrid(),onMouseDown:Fe,onMouseUp:$,onMouseLeave:$,onMouseMove:Re,onContextMenu:Se,pickColor:o=>Q.current&&!o.isSleeping()?[255,255,255,255]:o.getRGBA()})]})}export{Ye as default};

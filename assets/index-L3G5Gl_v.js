var ct=Object.defineProperty;var dt=(r,t,e)=>t in r?ct(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var u=(r,t,e)=>(dt(r,typeof t!="symbol"?t+"":t,e),e),et=(r,t,e)=>{if(!t.has(r))throw TypeError("Cannot "+e)};var s=(r,t,e)=>(et(r,t,"read from private field"),e?e.call(r):t.get(r)),g=(r,t,e)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,e)},c=(r,t,e,i)=>(et(r,t,"write to private field"),i?i.call(r,e):t.set(r,e),e);var B=(r,t,e)=>(et(r,t,"access private method"),e);import{r as w,j as it,_ as ft}from"./index-_ebBRA-9.js";import"./react-spring_web.modern-8qwzvL-G.js";function lt(r){const[t,e]=w.useState(r),i=w.useRef(t);return[i,h=>{h instanceof Function?(i.current=h(i.current),e(h)):(i.current=h,e(h))}]}class rt{constructor(t){u(this,"grid");u(this,"index");u(this,"position");u(this,"dir",{NW:()=>this.getNeighbourInDirection(y.NW),N:()=>this.getNeighbourInDirection(y.N),NE:()=>this.getNeighbourInDirection(y.NE),E:()=>this.getNeighbourInDirection(y.E),SE:()=>this.getNeighbourInDirection(y.SE),S:()=>this.getNeighbourInDirection(y.S),SW:()=>this.getNeighbourInDirection(y.SW),W:()=>this.getNeighbourInDirection(y.W)});this.grid=t,this.index=-1,this.position=new d(0,0)}getNeighbourInDirection(t){if(this.position)return this.grid.getAtPosition(this.position.add(t))}getNeighbourhood(){const t=[];return yt.forEach(e=>{const i=this.getNeighbourInDirection(e);t.push(i)}),t}getLineTo(t,e){return this.grid.getPositionsInLine(this.position,t,e)}swapWith(t){this.grid.swap(this,t)}getRGBA(){return[0,0,0,0]}}var M,U,st;class nt{constructor(t){g(this,U);u(this,"size");u(this,"alternateRows");u(this,"createEmpty");u(this,"grid");g(this,M,void 0);const{size:e,alternateRows:i,createEmpty:a}={alternateRows:!1,...t};this.grid=[],c(this,M,new Set([])),this.size=e,this.alternateRows=i,this.createEmpty=a?()=>a(this):()=>new rt(this),B(this,U,st).call(this)}clear(){B(this,U,st).call(this),this.resetChanges()}indexOf(t){return t?t.index:-1}positionOf(t){if(t)return t.position}forEach(t,e){const{alternateRowDirections:i,evenRows:a,oddRows:h,evenCols:f,oddCols:C,startRow:x,endRow:p,startCol:A,endCol:I}={evenRows:!0,oddRows:!0,evenCols:!0,oddCols:!0,...e},R=new Set,N=(l,z)=>{const S=this.position2index(new d(l,z)),o=this.grid[S];if(!o||R.has(o))return;if(t(o,S)===!1)return!1;R.add(o)};for(let l=x||0;l<(p||this.size.y);l++){const z=l%2;if(z===0&&!a)continue;if(z===1&&!h)continue;let S;if(i&&l%2===0&&Math.random()<.5){for(let o=(I||this.size.x)-1;o>=(A||0);o--){const E=o%2;if(!(E===0&&!f)&&!(E===1&&!C)&&(S=N(o,l),S===!1))break}if(S===!1)break;continue}for(let o=A||0;o<(I||this.size.x);o++){const E=o%2;if(!(E===0&&!f)&&!(E===1&&!C)&&(S=N(o,l),S===!1))break}if(S===!1)break}}map(t){return this.grid.map(t)}mapChanged(t){return this.getAllChanges().map(t)}getAllChanges(){return[...s(this,M).values()]}countChanges(){return s(this,M).size}forEachChanged(t,e=!1){s(this,M).forEach(t),e&&this.resetChanges()}registerChanged(t){t.index<0||t.index>=this.grid.length||s(this,M).has(t)||s(this,M).add(t)}resetChanges(){s(this,M).clear()}position2index(t){const{x:e,y:i}=t;return e<0||e>=this.size.x||i<0||i>=this.size.y?-1:e+i*this.size.x}index2position(t){const e=Math.floor(t/this.size.x),i=t-e*this.size.x;return new d(i,e)}get(t){return this.getAtPosition(t)}set(t,e){this.setAtPosition(t,e)}getPositionsInLine(t,e,i){const{excludeStart:a,excludeEnd:h,maxSteps:f}={maxSteps:500,...i},C=e.x-t.x,x=e.y-t.y;if(C===0&&x===0)return[t];const p=C<0?-1:1,A=x<0?-1:1,I=Math.abs(C),R=Math.abs(x),N=I>=R,l=Math.min(I,R),z=Math.max(I,R),S=l/z,o=[],E=a?1:0,D=h?z:z+1,T=D-E,m=T>f?Math.round(T/f):1;for(let v=E;v<D;v+=m){const W=Math.round(v*S);N?o.push(new d(t.x+v*p,t.y+W*A)):o.push(new d(t.x+W*p,t.y+v*A))}return o}getAtPosition(t){const e=this.position2index(t);if(e!==-1)return this.getAtIndex(e)}setAtPosition(t,e){if(t.x<0||t.x>=this.size.x||t.y<0||t.y>=this.size.y)return;const i=this.position2index(t);this.setAtIndex(i,e)}getAtIndex(t){return this.grid[t]}swap(t,e){const i=this.indexOf(t),a=this.indexOf(e);if(i===-1||a===-1)throw new Error("Can't swap unless both cells exists in the grid");const h=this.grid[i];this.setAtIndex(i,this.grid[a]),this.setAtIndex(a,h)}setAtIndex(t,e){if(t<0)throw new Error(`invalid index: ${t}`);e.index=t,e.position=this.index2position(t),this.grid[t]=e,this.registerChanged(e)}}M=new WeakMap,U=new WeakSet,st=function(){const t=this.size.x*this.size.y;this.grid.length=t;for(let e=0;e<t;e++)this.setAtIndex(e,this.createEmpty())};var P,F,q,$;class gt extends rt{constructor(e,i){super(e);u(this,"parent");g(this,P,new Set);g(this,F,void 0);g(this,q,void 0);g(this,$,void 0);this.parent=i}get dirtyRect(){return s(this,$)}forEach(e,i){const a=this.parent.chunkSize,h=this.position.multiply(a),f=this.position.multiply(a).add(a);this.parent.forEach(e,{startRow:h.y,endRow:f.y,startCol:h.x,endCol:f.x,...i})}haveChanges(){return s(this,P).size>0}countChanges(){return s(this,P).size}registerChange(e){s(this,P).has(e)||(s(this,P).add(e),c(this,F,d.min(s(this,F)||d.positiveInfinity,e.position)),c(this,q,d.max(s(this,q)||d.negativeInfinity,e.position)),c(this,$,new pt(s(this,F),s(this,q).subtract(s(this,F)))))}resetChanges(){s(this,P).clear(),c(this,F,void 0),c(this,q,void 0),c(this,$,void 0)}forEachChangedCell(e,i=!1){s(this,P).forEach(e),i&&this.resetChanges()}}P=new WeakMap,F=new WeakMap,q=new WeakMap,$=new WeakMap;function xt(r){return new Worker("/assets/worker-G1OrwRg-.js",{name:r==null?void 0:r.name})}var b,J,L,X,V,ot,_,at,tt,ht;class mt extends nt{constructor(e){const{chunkSize:i,workerize:a,...h}=e;super(h);g(this,V);g(this,_);g(this,tt);u(this,"chunkSize",new d(64,64));g(this,b,void 0);g(this,J,void 0);g(this,L,void 0);g(this,X,[]);this.chunkSize=i||new d(64,64),c(this,b,new nt({size:this.size.divide(this.chunkSize),createEmpty:f=>new gt(f,this)})),c(this,J,a||!1),s(this,J)&&(c(this,L,new xt),s(this,L).onmessage=this.handleWorkerResponse),B(this,V,ot).call(this)}clear(){super.clear(),this.resetChanges()}registerChanged(e){if(e.index<0||e.index>=this.grid.length)return;const i=this.chunkOf(e);i&&i.registerChange(e)}resetChanges(){super.resetChanges(),this.forEachChunk(e=>e.resetChanges())}countChanges(){return this.mapChunks(e=>e.countChanges()).reduce((e,i)=>e+i)}forEachChanged(e,i){this.forEachChunk(a=>{a.haveChanges()&&a.forEachChangedCell(e,i)})}chunkOf(e){if(!e||!this.chunkSize)return;const i=e.position.divide(this.chunkSize).floor();return s(this,b).get(i)}forEachChunk(e,i){s(this,b).forEach(e,i)}mapChunks(e){return s(this,b).map(e)}forEachChangedChunkPass(e,i=!1){this.forEachChunkPass(a=>{const h=a.filter(f=>f.haveChanges());h.length!==0&&(e(h),i&&h.forEach(f=>f.resetChanges()))})}forEachChunkPass(e){s(this,X).forEach((i,a)=>{s(this,J)?B(this,tt,ht).call(this,()=>e(i,a)):e(i,a)})}handleWorkerResponse(e){console.log("worker says:",this,e.data)}}b=new WeakMap,J=new WeakMap,L=new WeakMap,X=new WeakMap,V=new WeakSet,ot=function(){for(let e=0;e<s(this,b).size.x*s(this,b).size.y;e++)s(this,b).setAtIndex(e,s(this,b).createEmpty());B(this,_,at).call(this)},_=new WeakSet,at=function(){const e=[[!1,!1],[!1,!0],[!0,!1],[!0,!0]],i=[];e.forEach(([a,h])=>{const f=[];this.forEachChunk(C=>{f.push(C)},{evenRows:!a,oddRows:a,evenCols:!h,oddCols:h}),i.push(f)}),c(this,X,i)},tt=new WeakSet,ht=function(e){s(this,L)&&s(this,L).postMessage({f:e})};class pt{constructor(t,e){u(this,"position");u(this,"size");this.position=t,this.size=e}toArray(){return[...this.position.toArray(),...this.size.toArray()]}}const n=class n{constructor(t=0,e=0){u(this,"x");u(this,"y");this.x=t,this.y=e}clone(){return new n(this.x,this.y)}add(t){return new n(this.x+t.x,this.y+t.y)}addScalar(t){return new n(this.x+t,this.y+t)}subtract(t=n.zero){return new n(this.x-t.x,this.y-t.y)}subtractScalar(t){return new n(this.x-t,this.y-t)}multiply(t){return new n(this.x*t.x,this.y*t.y)}multiplyScalar(t){return new n(this.x*t,this.y*t)}divide(t){return new n(this.x/t.x,this.y/t.y)}divideScalar(t){return new n(this.x/t,this.y/t)}mod(t){return new n(this.x%t.x,this.y%t.y)}modScalar(t){return new n(this.x%t,this.y%t)}abs(){return new n(Math.abs(this.x),Math.abs(this.y))}round(){return new n(Math.round(this.x),Math.round(this.y))}floor(){return new n(Math.floor(this.x),Math.floor(this.y))}ceil(){return new n(Math.ceil(this.x),Math.ceil(this.y))}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){const t=this.length();return t===0?n.zero:this.multiplyScalar(1/t)}dot(t){const e=this.multiply(t);return e.x+e.y}isEqual(t){return this.x===t.x&&this.y===t.y}isNear(t,e=.001){const i=this.subtract(t).abs();return i.x<=e&&i.y<=e}toArray(){return[this.x,this.y]}join(t){return this.toArray().join(t)}static min(...t){return new n(Math.min(...t.map(e=>e.x)),Math.min(...t.map(e=>e.y)))}static max(...t){return new n(Math.max(...t.map(e=>e.x)),Math.max(...t.map(e=>e.y)))}static fromArray([t,e]){return new n(t,e)}static random(){return new n(Math.random(),Math.random())}};u(n,"zero",new n),u(n,"one",new n(1,1)),u(n,"up",new n(0,-1)),u(n,"down",new n(0,1)),u(n,"left",new n(-1,0)),u(n,"right",new n(1,0)),u(n,"negativeInfinity",new n(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)),u(n,"positiveInfinity",new n(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY));let d=n;const y={NW:new d(-1,-1),N:new d(0,-1),NE:new d(1,-1),E:new d(1,0),SE:new d(1,1),S:new d(0,1),SW:new d(-1,1),W:new d(-1,0)},yt=[y.NW,y.N,y.NE,y.W,y.E,y.SW,y.S,y.SE];class bt{constructor(t){u(this,"grid");const{gridOptions:e}=t;this.grid=this.createGrid(e)}clear(){this.grid.clear()}}function wt(r,t){const{children:e,grid:i,debugDraw:a,pickColor:h,...f}={debugDraw:!1,...r},C=w.useRef(null),x=w.useRef(null),p=w.useRef(),[A,I]=lt(!0);w.useImperativeHandle(t,()=>({clear:l,render:z})),w.useEffect(()=>{i&&(l(),z(i))},[i]);function R(){return x.current||(x.current=C.current?C.current.getContext("2d"):null,x.current&&(x.current.imageSmoothingEnabled=!1,x.current.translate(.5,.5))),x.current}function N(){if(p.current)return p.current;if(!i)return;const o=R();if(o)return p.current=o.createImageData(...i.size.toArray()),p.current}function l(){const o=N();o&&(o.data.fill(0),I(!0))}function z(o,E={debugDraw:a}){const{debugDraw:D,resetChanges:T}={debugDraw:!1,resetChanges:!1,...E};if(!o)return;const m=R();if(!m)return;const v=N();v&&(A.current===!0?o.forEach(W=>S({imageData:v,cell:W})):o.forEachChanged(W=>S({imageData:v,cell:W}),T),m.putImageData(v,0,0),D&&o instanceof mt&&o.forEachChunkPass((W,ut)=>{W.forEach(j=>{m.strokeStyle=j.haveChanges()?"rgba(255, 255, 255, 0.8)":"rgba(0, 0, 0, 0.2)",m.fillStyle=m.strokeStyle,m.lineWidth=1;const Z=j.position.multiply(o.chunkSize);m.strokeRect(...Z.toArray(),...o.chunkSize.toArray()),m.textAlign="right",m.fillText(j.position.toArray().toString(),...Z.add(o.chunkSize).subtractScalar(2).toArray()),m.textAlign="left",m.fillText(ut.toString(),...Z.add(o.chunkSize.multiply(d.down).add(d.fromArray([2,-2]))).toArray(),o.chunkSize.x),j.dirtyRect&&(m.strokeStyle="red",m.fillStyle="red",m.textAlign="left",m.fillText(j.countChanges().toString(),...Z.add(d.fromArray([2,10])).toArray()),m.strokeRect(...j.dirtyRect.position.toArray(),...j.dirtyRect.size.toArray()))})}),I(!1))}function S(o){const{imageData:E,cell:D}=o;if(D.index===-1)return;const T=h?h({cell:D}):D.getRGBA();T&&E.data.set(T,D.index*4)}if(i)return it.jsxs("div",{className:"grid canvas",children:[it.jsx("canvas",{ref:C,width:i.size.x||1,height:i.size.y||1,...f}),e]})}const Ct=w.forwardRef(wt);var G,K,k,Q,O,Y,H;class St{constructor(t){g(this,G,void 0);g(this,K,void 0);g(this,k,void 0);u(this,"limitFps");g(this,Q,void 0);g(this,O,!0);g(this,Y,void 0);g(this,H,void 0);const{gridRenderer:e,renderOptions:i,simulation:a,limitFps:h,onStep:f}=t;c(this,G,e),c(this,K,i),c(this,k,a),this.limitFps=h,c(this,Q,f),this._stepInternal=this._stepInternal.bind(this),c(this,Y,requestAnimationFrame(this._stepInternal))}_stepInternal(t){this.step(t),c(this,Y,requestAnimationFrame(this._stepInternal))}get simulation(){return s(this,k)}destroy(){var t,e;this.stop(),(t=s(this,k))==null||t.clear(),(e=s(this,G))==null||e.clear(),s(this,Y)!==void 0&&cancelAnimationFrame(s(this,Y))}start(){s(this,O)||(c(this,O,!0),this._stepInternal(Date.now()))}stop(){c(this,O,!1)}restart(){this.destroy(),this.start()}isRunning(){return s(this,O)}registerSimulation(t){s(this,k)&&(console.error("already have one"),this.destroy()),c(this,k,t)}registerGridRenderer(t,e){c(this,G,t),e&&c(this,K,e)}step(t){if(s(this,H)===void 0)c(this,H,t);else{const e=(t-s(this,H))/1e3;if(this.limitFps===void 0||e>1/this.limitFps){if(s(this,k)){const i=s(this,k).grid;if(!i)throw new Error("simulation or grid must be provided");s(this,O)&&s(this,k).step(e),s(this,Q)&&s(this,Q).call(this,{grid:i,deltaTime:e}),s(this,G)&&s(this,G).render(i,{resetChanges:!1,...s(this,K)}),i.resetChanges()}c(this,H,t)}}}}G=new WeakMap,K=new WeakMap,k=new WeakMap,Q=new WeakMap,O=new WeakMap,Y=new WeakMap,H=new WeakMap;function Et(r,t){var R,N;const{limitFps:e,renderOptions:i,children:a,initSimulation:h,onStep:f,...C}=r,x=w.useRef(null),p=w.useRef(null),A=w.useRef();w.useImperativeHandle(t,()=>p.current),w.useEffect(()=>{if(x.current&&!p.current)return p.current=new St({gridRenderer:x.current,simulation:h(),limitFps:e,renderOptions:i,onStep:f}),()=>{var l;(l=p.current)==null||l.destroy()}}),w.useEffect(()=>{var l;x.current&&(ft.isEqual(i,A.current)||(A.current=i,(l=p.current)==null||l.registerGridRenderer(x.current,i)))},[i]);function I(l){l.preventDefault()}return it.jsx(Ct,{ref:x,grid:(N=(R=p.current)==null?void 0:R.simulation)==null?void 0:N.grid,children:a,onContextMenu:I,...C})}const kt=w.forwardRef(Et);export{mt as C,rt as G,bt as S,d as V,kt as a,nt as b,yt as n,lt as u};

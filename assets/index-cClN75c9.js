var ye=Object.defineProperty;var ve=(i,e,t)=>e in i?ye(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var r=(i,e,t)=>(ve(i,typeof e!="symbol"?e+"":e,t),t),O=(i,e,t)=>{if(!e.has(i))throw TypeError("Cannot "+t)};var m=(i,e,t)=>(O(i,e,"read from private field"),t?t.call(i):e.get(i)),R=(i,e,t)=>{if(e.has(i))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(i):e.set(i,t)},y=(i,e,t,s)=>(O(i,e,"write to private field"),s?s.call(i,t):e.set(i,t),t);var ie=(i,e,t,s)=>({set _(u){y(i,e,u,t)},get _(){return m(i,e,s)}}),re=(i,e,t)=>(O(i,e,"access private method"),t);import{r as p,_ as ne,j as d}from"./index-FInyT7v3.js";import{G as Me,V as c,a as xe,u as j,b as Se}from"./index-i8gkJ72h.js";var W;class I extends Me{constructor(t,s){super(t);r(this,"empty");r(this,"shouldTryAwakeNeighbours");r(this,"color");R(this,W,!1);r(this,"index",-1);r(this,"position",new c(0,0));r(this,"brushSize",4);r(this,"brushFillRate",.05);r(this,"velocity",new c(0,0));r(this,"gravity",new c(0,9));const{empty:u,shouldTryAwakeNeighbours:n}={empty:!1,shouldTryAwakeNeighbours:!0,...s};this.empty=u,this.shouldTryAwakeNeighbours=n,this.color=this.getRGBA()}isSleeping(){return m(this,W)}sleep(){y(this,W,!0),this.grid.registerChanged(this)}awake(){y(this,W,!1),this.grid.registerChanged(this)}die(){this.grid.set(this.position,new D(this.grid))}getRGBA(){return this.color}}W=new WeakMap;class D extends I{constructor(t){super(t,{empty:!0});r(this,"brushSize",2);r(this,"brushFillRate",1);r(this,"color",[50,50,50,255]);this.sleep()}awake(){}step(){}}class G extends I{}class A extends I{constructor(t,s){super(t,s);r(this,"numFramesOfHorizontalMovement",0);r(this,"maxFramesOfHorizontalMovement",100+Math.random()*25);r(this,"numFramesWithoutMovement",0);r(this,"maxFramesWithoutMovement",100+Math.random()*25);r(this,"dispersionRate");r(this,"erosionFactor");const{dispersionRate:u,erosionFactor:n}=s||{};this.dispersionRate=u||12,this.erosionFactor=n||.005}step(t){var n,h;let s=!1;const u=[-1,1];if(Math.random()>.5&&u.reverse(),this.isSleeping()){const o=this.getNeighbourInDirection(this.gravity.y<0?c.up():c.down());o!=null&&o.empty&&this.swapWith(o),this.numFramesOfHorizontalMovement=0}else{this.velocity=this.velocity.add(this.gravity.multiplyScalar(t));let o=this;if(this.getLineTo(this.position.add(this.velocity),{excludeStart:!0}).every(l=>{const f=this.grid.get(l);return f!=null&&f.empty?(o=f,!0):!1}),o!==this)this.swapWith(o),s=!0,this.numFramesOfHorizontalMovement=0;else if(this.numFramesOfHorizontalMovement<=this.maxFramesOfHorizontalMovement){const l=this.dir.N();l instanceof A&&Math.random()<5e-4?this.swapWith(l):u.every(f=>{const N=this.grid;if(this.erosionFactor>0){const g=this.dir.S();if(g instanceof E&&Math.random()<this.erosionFactor)return this.swapWith(g),!0}return N.getPositionsInLine(this.position,this.position.add(new c(f*this.dispersionRate,0).multiplyScalar(t)),{excludeStart:!0}).every(g=>{const M=N.getAtPosition(g);return M!=null&&M.empty?(this.swapWith(M),s=!0,this.numFramesOfHorizontalMovement++,!1):!(M instanceof G)}),!s})}else((n=this.dir.W())!=null&&n.empty||(h=this.dir.E())!=null&&h.empty)&&this.die()}s?(u.every(o=>{const l=this.getNeighbourInDirection(new c(o,0));return l!=null&&l.empty||l==null||l.awake(),!0}),this.numFramesWithoutMovement=0):(this.numFramesWithoutMovement++,this.numFramesWithoutMovement>=this.maxFramesWithoutMovement&&this.sleep())}}var k,z;class E extends G{constructor(){super(...arguments);R(this,k,0);R(this,z,100)}step(t){let s=!1;const u=[-1,1];if(Math.random()>=.5&&u.reverse(),this.isSleeping()){const n=this.dir.S();(n!=null&&n.empty||n instanceof A)&&(this.swapWith(n),s=!0)}else{this.velocity=this.velocity.add(this.gravity.multiplyScalar(t));let n=this;this.getLineTo(this.position.add(this.velocity),{excludeStart:!0}).every(h=>{const o=this.grid.get(h);return o==null||o.awake(),o!=null&&o.empty?(n=o,!0):(this.velocity=this.velocity.multiply(c.up().multiplyScalar(.1)),!1)}),n!==this?(this.swapWith(n),s=!0):u.every(h=>{const o=this.getNeighbourInDirection(new c(h,1));return o!=null&&o.empty||o instanceof A?(this.swapWith(o),s=!0,!1):!0})}s?(u.every(n=>{const h=this.getNeighbourInDirection(new c(n,0));return h!=null&&h.empty||h==null||h.awake(),!0}),y(this,k,0)):(ie(this,k)._++,m(this,k)>=m(this,z)&&this.sleep())}}k=new WeakMap,z=new WeakMap;class Fe extends E{constructor(){super(...arguments);r(this,"_r",Math.random()*20);r(this,"color",[191-this._r,155-this._r,123-this._r,255])}}class B extends A{}class oe extends A{constructor(t,s){super(t,{dispersionRate:8,erosionFactor:0,shouldTryAwakeNeighbours:!1,...s});r(this,"gravity",new c(0,-4))}step(t){const s=this.dir.N();if(s instanceof B){this.swapWith(s);return}super.step(t)}}class Re extends oe{constructor(){super(...arguments);r(this,"color",[90,90,90,Math.round(Math.random()*185)+70])}}class L extends E{constructor(){super(...arguments);r(this,"_r",Math.random()*20);r(this,"color",[220-this._r,220-this._r,255,255])}step(t){if(!this.isSleeping()||Math.random()<.995){super.step(t);return}this.getNeighbourhood().map(n=>n.empty?.5:n instanceof L?-1:n instanceof G?2:n instanceof B?1:0).reduce((n,h)=>n+h)>0&&this.die()}getRGBA(){return this.isSleeping()?this.color:[255,255,255,255]}die(){this.grid.set(this.position,Math.random()<.25?new q(this.grid):new D(this.grid))}}class ae extends oe{constructor(){super(...arguments);r(this,"_r",Math.round(Math.random()*80)+100);r(this,"color",[255,255,255,this._r])}die(){this.grid.set(this.position,Math.random()<.05?new q(this.grid):new D(this.grid))}}class he extends G{constructor(t,s){super(t,{shouldTryAwakeNeighbours:!1,...s});r(this,"brushSize",2);r(this,"brushFillRate",1);this.sleep()}awake(){}step(){}}class be extends he{constructor(){super(...arguments);r(this,"color",[100,100,100,255])}}class q extends B{constructor(t,s){super(t,{...s,dispersionRate:3});r(this,"_r",Math.round(Math.random()*100)+155);r(this,"color",[46,137,255,this._r])}die(){this.grid.set(this.position,Math.random()<.25?new ae(this.grid):new D(this.grid))}}class We extends he{constructor(){super(...arguments);r(this,"_r",Math.random()*20);r(this,"color",[180-this._r,100-this._r,100-this._r,255-this._r])}}var v,b,C,ue;class ke{constructor(e){R(this,C);R(this,v,void 0);R(this,b,!0);r(this,"materialPalette");y(this,v,new xe({...e,createEmpty:t=>new D(t)})),this.materialPalette=re(this,C,ue).call(this,m(this,v))}isRunning(){return m(this,b)}start(){y(this,b,!0)}stop(){y(this,b,!1)}restart(){this.stop(),m(this,v).clear(),this.start()}getGrid(){return m(this,v)}step(e){if(!m(this,b))return;m(this,v).forEach(s=>{s.empty||s.step(e)},{alternateRows:!0})}}v=new WeakMap,b=new WeakMap,C=new WeakSet,ue=function(e){return{empty:()=>new D(e),sand:()=>new Fe(e),smoke:()=>new Re(e),snow:()=>new L(e),steam:()=>new ae(e),stone:()=>new be(e),water:()=>new q(e),wood:()=>new We(e)}};function je(){var Q;const t=p.useRef(null),s=p.useRef(),u=p.useRef(),n=p.useRef(),h=p.useRef(),o=p.useRef(void 0),[l,f]=j(!1),[N,V]=j([0,0]),[g,M]=j("sand"),[X,le]=p.useState([0]),[Y,ce]=j(!1),[de,me]=p.useState([]);p.useEffect(()=>(s.current=new ke({width:320,height:180}),u.current=s.current.getGrid(),me(ne.keys(s.current.materialPalette)),K(),n.current=requestAnimationFrame(U),()=>{n.current!==void 0&&cancelAnimationFrame(n.current)}),[]);function fe(a){a.preventDefault()}function pe(a){const w=a.target,{x,y:S,width:F,height:Z}=w.getBoundingClientRect();V([(a.clientX-x)/F,(a.clientY-S)/Z])}function U(a){if(h.current!==void 0){const w=(a-h.current)/1e3;{const x=s.current;if(!x)return;const S=x.getGrid();we(S),x.step(w),h.current=a,le(F=>[...F.slice(F.length-100),1/w])}}n.current=requestAnimationFrame(U)}function ge(){f(!0)}function J(){f(!1),o.current=void 0}function we(a){if(!l.current||!g.current)return;const[w,x]=N.current,S=new c(Math.floor(w*a.width),Math.floor(x*a.height)),F=s.current;if(!F)return;const P=F.materialPalette[g.current];if(!P)return;const _=P(),$=Math.floor(_.brushSize);(o.current?a.getPositionsInLine(o.current,S):[S]).every(ee=>{for(let T=-$;T<_.brushSize;T++)for(let H=-$;H<_.brushSize;H++){if(Math.random()>_.brushFillRate)continue;const te=ee.x+H;if(te<0)continue;const se=ee.y+T;se<0||a.setAtPosition(new c(te,se),P())}return!0}),o.current=S}function K(){const a=s.current;a&&a.restart()}return d.jsxs("div",{className:"route sand",ref:t,children:[d.jsxs("div",{className:"materials",children:[d.jsx("div",{className:"material",children:"reset",onClick:K}),d.jsx("div",{className:"separator"}),ne.map(de,a=>d.jsx("div",{className:"material",children:a,onClick:()=>M(a),style:g.current===a?{border:"1px solid white"}:void 0},a)),d.jsx("div",{className:"separator"}),d.jsxs("div",{children:[d.jsx("input",{id:"debugDraw",type:"checkbox",checked:Y.current,onChange:a=>ce(a.target.checked)}),d.jsx("label",{htmlFor:"debugDraw",children:"debugDraw"})]}),d.jsx("div",{className:"separator"}),d.jsxs("div",{children:["fps: ",Math.round(X.reduce((a,w)=>a+w)/X.length||1)]})]}),d.jsx(Se,{grid:(Q=s.current)==null?void 0:Q.getGrid(),onMouseDown:ge,onMouseUp:J,onMouseLeave:J,onMouseMove:pe,onContextMenu:fe,pickColor:a=>Y.current&&!a.isSleeping()?[255,255,255,255]:a.getRGBA()})]})}export{je as default};

var Rt=Object.defineProperty;var zt=(r,t,e)=>t in r?Rt(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var f=(r,t,e)=>(zt(r,typeof t!="symbol"?t+"":t,e),e),dt=(r,t,e)=>{if(!t.has(r))throw TypeError("Cannot "+e)};var s=(r,t,e)=>(dt(r,t,"read from private field"),e?e.call(r):t.get(r)),g=(r,t,e)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,e)},c=(r,t,e,i)=>(dt(r,t,"write to private field"),i?i.call(r,e):t.set(r,e),e);var pt=(r,t,e,i)=>({set _(n){c(r,t,n,e)},get _(){return s(r,t,i)}}),U=(r,t,e)=>(dt(r,t,"access private method"),e);import{r as w,j as gt,_ as vt}from"./index-0fGeCcMT.js";import"./react-spring_web.modern-ApfulI3L.js";function At(r){const[t,e]=w.useState(r),i=w.useRef(t);return[i,o=>{o instanceof Function?(i.current=o(i.current),e(o)):(i.current=o,e(o))}]}class wt{constructor(t){f(this,"grid");f(this,"index");f(this,"position");f(this,"dir",{NW:()=>this.getNeighbourInDirection(E.NW),N:()=>this.getNeighbourInDirection(E.N),NE:()=>this.getNeighbourInDirection(E.NE),E:()=>this.getNeighbourInDirection(E.E),SE:()=>this.getNeighbourInDirection(E.SE),S:()=>this.getNeighbourInDirection(E.S),SW:()=>this.getNeighbourInDirection(E.SW),W:()=>this.getNeighbourInDirection(E.W)});this.grid=t,this.index=-1,this.position=h.create(0,0)}getNeighbourInDirection(t){if(this.position)return this.grid.getAtPosition(h.add(this.position,t))}getNeighbourhood(){const t=[];return Dt.forEach(e=>{const i=this.getNeighbourInDirection(e);t.push(i)}),t}getLineTo(t,e){return this.grid.getCellsInLine(this.position,t,e)}swapWith(t){this.grid.swap(this,t)}getRGBA(){return[0,0,0,0]}}var Mt=function(){function r(t){this._value=NaN,typeof t=="string"?this._seed=this.hashCode(t):typeof t=="number"?this._seed=this.getSafeSeed(t):this._seed=this.getSafeSeed(r.MIN+Math.floor((r.MAX-r.MIN)*Math.random())),this.reset()}return r.prototype.next=function(t,e){return t===void 0&&(t=0),e===void 0&&(e=1),this.recalculate(),this.map(this._value,r.MIN,r.MAX,t,e)},r.prototype.nextInt=function(t,e){return t===void 0&&(t=10),e===void 0&&(e=100),this.recalculate(),Math.floor(this.map(this._value,r.MIN,r.MAX,t,e+1))},r.prototype.nextString=function(t,e){t===void 0&&(t=16),e===void 0&&(e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789");for(var i="";i.length<t;)i+=this.nextChar(e);return i},r.prototype.nextChar=function(t){return t===void 0&&(t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"),t.substr(this.nextInt(0,t.length-1),1)},r.prototype.nextArrayItem=function(t){return t[this.nextInt(0,t.length-1)]},r.prototype.nextBoolean=function(){return this.recalculate(),this._value>.5},r.prototype.skip=function(t){for(t===void 0&&(t=1);t-- >0;)this.recalculate()},r.prototype.reset=function(){this._value=this._seed},r.prototype.recalculate=function(){this._value=this.xorshift(this._value)},r.prototype.xorshift=function(t){return t^=t<<13,t^=t>>17,t^=t<<5,t},r.prototype.map=function(t,e,i,n,o){return(t-e)/(i-e)*(o-n)+n},r.prototype.hashCode=function(t){var e=0;if(t)for(var i=t.length,n=0;n<i;n++)e=(e<<5)-e+t.charCodeAt(n),e|=0,e=this.xorshift(e);return this.getSafeSeed(e)},r.prototype.getSafeSeed=function(t){return t===0?1:t},r.MIN=-2147483648,r.MAX=2147483647,r}();const Nt=new Mt,yt=()=>Nt.next();var Y,j;class kt{constructor(t,e){g(this,Y,void 0);g(this,j,void 0);c(this,Y,t),c(this,j,e)}set(t,e){t&&c(this,Y,t),e&&c(this,j,e)}get position(){return s(this,Y)}get size(){return s(this,j)}get area(){return s(this,j).x*s(this,j).y}toArray(){return[...s(this,Y).toArray(),...s(this,j).toArray()]}}Y=new WeakMap,j=new WeakMap;const a=class a{constructor(t=0,e=0){f(this,"x");f(this,"y");this.x=t,this.y=e}clone(){return new a(this.x,this.y)}setXY(t,e){this.x=t,this.y=e}set(t){this.x=t.x,this.y=t.y}add(t){return this.x=this.x+t.x,this.y=this.y+t.y,this}addScalar(t){return this.x=this.x+t,this.y=this.y+t,this}subtract(t=a.zero){return this.x=this.x-t.x,this.y=this.y-t.y,this}subtractScalar(t){return this.x=this.x-t,this.y=this.y-t,this}multiply(t){return this.x=this.x*t.x,this.y=this.y*t.y,this}multiplyScalar(t){return this.x=this.x*t,this.y=this.y*t,this}divide(t){return this.x=this.x/t.x,this.y=this.y/t.y,this}divideScalar(t){return this.x=this.x/t,this.y=this.y/t,this}mod(t){return this.x=this.x%t.x,this.y=this.y%t.y,this}modScalar(t){return this.x=this.x%t,this.y=this.y%t,this}abs(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}frac(){return this.subtract(this.clone().floor())}normalize(){const t=this.length();return t===0?this:this.multiplyScalar(1/t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}dot(t){const e=a.multiply(this,t);return e.x+e.y}isEqual(t){return this.x===t.x&&this.y===t.y}isNear(t,e=.001){const i=a.subtract(this,t).abs();return i.x<=e&&i.y<=e}isLessThan(t){return a.isLessThan(this,t)}isGreaterThan(t){return a.isGreaterThan(this,t)}toArray(){return[this.x,this.y]}join(t){return this.toArray().join(t)}static create(t=0,e=0){return new a(t,e)}static add(t,e){return new a(t.x+e.x,t.y+e.y)}static addScalar(t,e){return new a(t.x+e,t.y+e)}static subtract(t,e=a.zero){return new a(t.x-e.x,t.y-e.y)}static subtractScalar(t,e){return new a(t.x-e,t.y-e)}static multiply(t,e){return new a(t.x*e.x,t.y*e.y)}static multiplyScalar(t,e){return new a(t.x*e,t.y*e)}static divide(t,e){return new a(t.x/e.x,t.y/e.y)}static divideScalar(t,e){return new a(t.x/e,t.y/e)}static mod(t,e){return new a(t.x%e.x,t.y%e.y)}static modScalar(t,e){return new a(t.x%e,t.y%e)}static abs(t){return new a(Math.abs(t.x),Math.abs(t.y))}static round(t){return new a(Math.round(t.x),Math.round(t.y))}static floor(t){return new a(Math.floor(t.x),Math.floor(t.y))}static ceil(t){return new a(Math.ceil(t.x),Math.ceil(t.y))}static frac(t){return a.subtract(t,a.floor(t))}static isLessThan(t,e){return t.x<e.x||t.y<e.y}static isGreaterThan(t,e){return t.x>e.x||t.y>e.y}static length(t){return Math.sqrt(t.x*t.x+t.y*t.y)}static normalize(t){const e=t.length();return e===0?t:a.multiplyScalar(t,1/e)}static dot(t,e){const i=a.multiply(t,e);return i.x+i.y}static isEqual(t,e){return t.x===e.x&&t.y===e.y}static isNear(t,e,i=.001){const n=a.subtract(t,e).abs();return n.x<=i&&n.y<=i}static min(...t){return new a(Math.min(...t.map(e=>e.x)),Math.min(...t.map(e=>e.y)))}static max(...t){return new a(Math.max(...t.map(e=>e.x)),Math.max(...t.map(e=>e.y)))}static from(t){return new a(t.x,t.y)}static fromArray([t,e]){return new a(t,e)}static random(){return new a(yt(),yt())}};f(a,"zero",Object.freeze(new a)),f(a,"one",Object.freeze(new a(1,1))),f(a,"up",Object.freeze(new a(0,-1))),f(a,"down",Object.freeze(new a(0,1))),f(a,"left",Object.freeze(new a(-1,0))),f(a,"right",Object.freeze(new a(1,0))),f(a,"negativeInfinity",Object.freeze(new a(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY))),f(a,"positiveInfinity",Object.freeze(new a(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY)));let h=a;const E=Object.freeze({NW:h.create(-1,-1),N:h.up,NE:h.create(1,-1),E:h.right,SE:h.one,S:h.down,SW:h.create(-1,1),W:h.left}),Dt=[E.NW,E.N,E.NE,E.W,E.E,E.SW,E.S,E.SE];var B,H;class St extends kt{constructor(){super(h.positiveInfinity.clone(),h.negativeInfinity.clone());g(this,B,!1);g(this,H,void 0);c(this,H,h.negativeInfinity.clone())}get area(){return s(this,B)?super.area:0}haveChanges(){return s(this,B)}reset(){this.position.set(h.positiveInfinity),this.size.set(h.negativeInfinity),s(this,H).set(h.negativeInfinity),c(this,B,!1)}registerPoint(e){this.position.min(e),s(this,H).max(e),this.size.set(h.subtract(s(this,H),this.position).addScalar(1)),c(this,B,!0)}}B=new WeakMap,H=new WeakMap;var D,st,rt,xt;class mt{constructor(t){g(this,rt);f(this,"size");f(this,"alternateRows");f(this,"createEmpty");f(this,"grid");g(this,D,void 0);g(this,st,0);const{size:e,alternateRows:i,createEmpty:n}={alternateRows:!1,...t};if(!h.frac(e).isEqual(h.zero))throw new Error(`Grid size must be integers (${e.toArray().join(", ")})`);this.grid=[],c(this,D,new St),this.size=e,this.alternateRows=i,this.createEmpty=n?()=>n(this):()=>new wt(this),U(this,rt,xt).call(this)}clear(){U(this,rt,xt).call(this),this.resetChanges()}indexOf(t){return t?t.index:-1}positionOf(t){if(t)return t.position}forEach(t,e){const{alternateRowDirections:i,evenRows:n,oddRows:o,evenCols:u,oddCols:x,startRow:l,endRow:b,startCol:S,endCol:m}={evenRows:!0,oddRows:!0,evenCols:!0,oddCols:!0,...e},M=new Set,W=(I,z)=>{const y=this.xy2index(I,z),p=this.grid[y];p&&(M.has(p)||(t(p,y),M.add(p)))};for(let I=l||0;I<(b||this.size.y);I++){const z=I%2;if(!(z===0&&!n)&&!(z===1&&!o)){if(i&&I%2===0){for(let y=(m||this.size.x)-1;y>=(S||0);y--){const p=y%2;p===0&&!u||p===1&&!x||W(y,I)}continue}for(let y=S||0;y<(m||this.size.x);y++){const p=y%2;p===0&&!u||p===1&&!x||W(y,I)}}}}map(t){return this.grid.map(t)}mapChanged(t){return this.getAllChanges().map(t)}getAllChanges(t=!1){const e=[];return this.forEachChanged(i=>e.push(i),t),e}countChanges(){return s(this,D).area}forEachChanged(t,e=!1){if(!s(this,D).haveChanges())return;const i=s(this,D).position.clone(),n=s(this,D).position.clone().add(s(this,D).size);this.forEach(t,{startRow:i.y,endRow:n.y,startCol:i.x,endCol:n.x}),e&&this.resetChanges()}registerChanged(t){s(this,D).registerPoint(t.position)}resetChanges(){s(this,D).reset()}xy2index(t,e){return t<0||t>=this.size.x||e<0||e>=this.size.y?-1:t+e*this.size.x}position2index(t){const{x:e,y:i}=t;return this.xy2index(e,i)}index2position(t){const e=Math.floor(t/this.size.x),i=t-e*this.size.x;return h.create(i,e)}get(t){return this.getAtPosition(t)}set(t,e){this.setAtPosition(t,e)}getCellsInLine(t,e,i){const{excludeStart:n,excludeEnd:o,maxSteps:u}={maxSteps:s(this,st),...i},x=e.x-t.x,l=e.y-t.y;if(x===0&&l===0){const P=this.getAtPosition(t);return P?[P]:[]}const b=x<0?-1:1,S=l<0?-1:1,m=Math.abs(x),M=Math.abs(l),W=m>=M,I=Math.min(m,M),z=Math.max(m,M),y=I/z,p=[],d=n?1:0,K=o?z:z+1,F=K-d,Q=u!==void 0&&F>u?Math.floor(F/u):1;for(let P=d;P<K;P+=Q){const v=Math.round(P*y);if(W){const T=this.getAtXY(t.x+P*b,t.y+v*S);T&&p.push(T)}else{const T=this.getAtXY(t.x+v*b,t.y+P*S);T&&p.push(T)}}return p}getAtXY(t,e){const i=this.xy2index(t,e);if(i!==-1)return this.getAtIndex(i)}getAtPosition(t){const e=this.position2index(t);if(e!==-1)return this.getAtIndex(e)}setAtPosition(t,e){if(t.x<0||t.x>=this.size.x||t.y<0||t.y>=this.size.y)return;const i=this.position2index(t);this.setAtIndex(i,e)}getAtIndex(t){if(t%1!==0)throw new Error(`not int: ${t}`);return this.grid[t]}swap(t,e){const i=this.indexOf(t),n=this.indexOf(e);if(i===-1||n===-1)throw new Error("Can't swap unless both cells exists in the grid");const o=this.grid[i];this.setAtIndex(i,this.grid[n]),this.setAtIndex(n,o)}setAtIndex(t,e){if(t<0)throw new Error(`invalid index: ${t}`);e.index=t,e.position=this.index2position(t),this.grid[t]=e,this.registerChanged(e)}}D=new WeakMap,st=new WeakMap,rt=new WeakSet,xt=function(){const t=this.size.x*this.size.y;this.grid.length=t;for(let e=0;e<t;e++)this.setAtIndex(e,this.createEmpty());c(this,st,this.size.length())};var R;class Ot extends wt{constructor(e,i){super(e);f(this,"parent");g(this,R,void 0);this.parent=i,c(this,R,new St)}get dirtyRect(){return s(this,R)}forEachDirty(e,i){if(!s(this,R).haveChanges())return;const{resetChanges:n,...o}={resetChanges:!1,...i},u=s(this,R).position.clone(),x=s(this,R).position.clone().add(s(this,R).size);n&&this.resetChanges(),this.parent.forEach(e,{startRow:u.y,endRow:x.y,startCol:u.x,endCol:x.x,...o})}forEach(e,i){const n=this.parent.chunkSize,o=h.multiply(this.position,n),u=h.multiply(this.position,n).add(n);this.parent.forEach(e,{startRow:o.y,endRow:u.y,startCol:o.x,endCol:u.x,...i})}haveChanges(){return s(this,R).haveChanges()}countChanges(){return s(this,R).haveChanges()?s(this,R).area:0}registerChange(e){s(this,R).registerPoint(e.position)}resetChanges(){s(this,R).reset()}}R=new WeakMap;function Pt(r){return new Worker("/assets/worker-G1OrwRg-.js",{name:r==null?void 0:r.name})}var N,Z,$,nt,ot,It,ut,Et,ct,bt;class Wt extends mt{constructor(e){const{chunkSize:i,workerize:n,...o}=e;super(o);g(this,ot);g(this,ut);g(this,ct);f(this,"chunkSize",h.create(64,64));g(this,N,void 0);g(this,Z,void 0);g(this,$,void 0);g(this,nt,[]);this.chunkSize=i||h.create(64,64),c(this,N,new mt({size:h.divide(this.size,this.chunkSize),createEmpty:u=>new Ot(u,this)})),c(this,Z,n||!1),s(this,Z)&&(c(this,$,new Pt),s(this,$).onmessage=this.handleWorkerResponse),U(this,ot,It).call(this)}registerChanged(e){if(e.index<0||e.index>=this.grid.length)return;const i=this.chunkOf(e);i&&i.registerChange(e)}resetChanges(){super.resetChanges(),this.forEachChunk(e=>e.resetChanges())}countChanges(){return this.mapChunks(e=>e.countChanges()).reduce((e,i)=>e+i)}getAllChanges(){const e=[];return this.forEachChanged(i=>e.push(i)),e}forEachChanged(e,i){this.forEachChunk(n=>{n.haveChanges()&&n.forEachDirty(e,{resetChanges:i})})}chunkOf(e){if(!e||!this.chunkSize)return;const i=h.divide(e.position,this.chunkSize).floor();return s(this,N).get(i)}getChunk(e){return s(this,N).get(e)}forEachChunk(e,i){s(this,N).forEach(e,i)}mapChunks(e){return s(this,N).map(e)}forEachChangedChunkPass(e,i=!1){this.forEachChunkPass(n=>{const o=n.filter(u=>u.haveChanges());o.length!==0&&(e(o),i&&o.forEach(u=>u.resetChanges()))})}forEachChunkPass(e){s(this,nt).forEach((i,n)=>{s(this,Z)?U(this,ct,bt).call(this,()=>e(i,n)):e(i,n)})}handleWorkerResponse(e){console.log("worker says:",this,e.data)}}N=new WeakMap,Z=new WeakMap,$=new WeakMap,nt=new WeakMap,ot=new WeakSet,It=function(){for(let e=0;e<s(this,N).size.x*s(this,N).size.y;e++)s(this,N).setAtIndex(e,s(this,N).createEmpty());U(this,ut,Et).call(this)},ut=new WeakSet,Et=function(){const e=[[!1,!1],[!1,!0],[!0,!1],[!0,!0]],i=[];e.forEach(([n,o])=>{const u=[];this.forEachChunk(x=>{u.push(x)},{evenRows:!n,oddRows:n,evenCols:!o,oddCols:o}),i.push(u)}),c(this,nt,i)},ct=new WeakSet,bt=function(e){s(this,$)&&s(this,$).postMessage({f:e})};class Bt{constructor(t){f(this,"grid");const{gridOptions:e}=t;this.grid=this.createGrid(e)}clear(){this.grid.clear()}}class Ft{}var V,lt;const ft=class ft extends Ft{constructor(e){super();g(this,V,0);g(this,lt,100);f(this,"gravity");f(this,"sideStep");f(this,"bounce");const{gravity:i,sideStep:n,bounce:o}={gravity:ft.defaultGravity,sideStep:!0,bounce:!0,...e};this.gravity=i,this.sideStep=n,this.bounce=o}step({cell:e,deltaTime:i}){let n=!1;const o=[-1,1];yt()>=.5&&o.reverse();const u=e.getNeighbourInDirection(this.gravity.y<0?h.up:h.down);e.isSleeping()?u!=null&&u.empty&&(e.acceleration.add(h.multiplyScalar(this.gravity,i)),n=!0):this.sideStep&&(u!=null&&u.empty?(e.acceleration.add(h.multiplyScalar(this.gravity,i)),n=!0):o.every(x=>{const l=e.getNeighbourInDirection(h.create(x,this.gravity.y<0?-1:1));return l!=null&&l.empty?(e.acceleration.add(h.subtract(l.position,e.position)),n=!0,!1):!0})),n?(c(this,V,0),o.forEach(x=>{const l=e.getNeighbourInDirection(h.create(x,0));l!=null&&l.empty||l==null||l.awake()})):(pt(this,V)._++,s(this,V)>=s(this,lt)&&e.sleep())}};V=new WeakMap,lt=new WeakMap,f(ft,"defaultGravity",h.create(0,9.81));let Ct=ft;function jt(r,t){const{children:e,grid:i,debugDraw:n,renderOptions:o,pickColor:u,...x}={debugDraw:!1,...r},l=w.useRef(null),b=w.useRef(null),S=w.useRef(),[m,M]=At(!0);w.useImperativeHandle(t,()=>({clear:z,render:y})),w.useEffect(()=>{i&&(z(),y(i,o))},[i]);function W(){return b.current||(b.current=l.current?l.current.getContext("2d"):null,b.current&&(b.current.imageSmoothingEnabled=!1,b.current.translate(.5,.5))),b.current}function I(){if(S.current)return S.current;if(!i)return;const d=W();if(d)return S.current=d.createImageData(...i.size.toArray()),S.current}function z(){const d=I();d&&(d.data.fill(0),M(!0))}function y(d,K={debugDraw:n}){const F={debugDraw:!1,resetChanges:!1,pixelScale:1,...K},{debugDraw:Q,resetChanges:P,pixelScale:v,onDebugDraw:T}=F;if(!d)return;if(l.current){const A=d.size.x,q=d.size.y;(l.current.width!==A||l.current.height!==q)&&(l.current.width=A*v,l.current.height=q*v,b.current=null)}const C=W();if(!C)return;const et=I();if(et){if(m.current===!0?d.forEach(A=>p({grid:d,imageData:et,cell:A})):d.forEachChanged(A=>p({grid:d,imageData:et,cell:A}),P),v!==1){const A=document.createElement("canvas");A.width=d.size.x,A.height=d.size.y;const q=A.getContext("2d");q==null||q.putImageData(et,0,0),C.drawImage(A,0,0,d.size.x*v,d.size.y*v)}else C.putImageData(et,0,0);Q&&(d instanceof Wt&&d.forEachChunkPass((A,q)=>{A.forEach(X=>{C.strokeStyle=X.haveChanges()?"rgba(255, 255, 255, 0.8)":"rgba(0, 0, 0, 0.2)",C.fillStyle=C.strokeStyle,C.lineWidth=1;const it=h.multiply(X.position,d.chunkSize),ht=h.multiplyScalar(d.chunkSize,v);v!==1&&it.multiplyScalar(v),C.strokeRect(...it.toArray(),...ht.toArray()),C.textAlign="right",C.fillText(X.position.toArray().toString(),...h.add(it,ht).subtractScalar(2).toArray()),C.textAlign="left",C.fillText(q.toString(),...h.add(it,h.multiply(ht,h.down).add(h.fromArray([2,-2]))).toArray(),ht.x),X.dirtyRect.haveChanges()&&(C.strokeStyle="red",C.fillStyle="red",C.textAlign="left",C.fillText(X.countChanges().toString(),...h.add(it,h.create(2,10)).toArray()),C.strokeRect(...h.multiplyScalar(X.dirtyRect.position,v).toArray(),...h.multiplyScalar(X.dirtyRect.size,v).toArray()))})}),T&&T(C)),M(!1)}}function p(d){const{imageData:K,cell:F}=d;if(F.index===-1)return;const Q=u?u({cell:F}):F.getRGBA();Q&&K.data.set(Q,F.index*4)}if(i)return gt.jsxs("div",{className:"grid canvas",children:[gt.jsx("canvas",{ref:l,...x}),e]})}const Gt=w.forwardRef(jt);var L,_,k,at,tt,O,J,G;class Tt{constructor(t){g(this,L,void 0);g(this,_,void 0);g(this,k,void 0);f(this,"limitFps");g(this,at,void 0);g(this,tt,void 0);g(this,O,!0);g(this,J,void 0);g(this,G,void 0);const{gridRenderer:e,renderOptions:i,simulation:n,limitFps:o,resetChanges:u,onStep:x}={resetChanges:!0,...t};c(this,L,e),c(this,_,i),c(this,k,n),this.limitFps=o,c(this,at,u),c(this,tt,x),this._stepInternal=this._stepInternal.bind(this),c(this,J,requestAnimationFrame(this._stepInternal))}_stepInternal(t){if(s(this,O)&&s(this,G)===void 0)c(this,G,t);else{const e=s(this,G)===void 0?0:(t-s(this,G))/1e3;if((this.limitFps===void 0||e>1/this.limitFps)&&s(this,k)){const i=s(this,k).grid;if(!i)throw new Error("simulation or grid must be provided");s(this,O)&&this.step(e),s(this,tt)&&s(this,tt).call(this,{grid:i,deltaTime:e}),s(this,L)&&s(this,L).render(i,{resetChanges:!1,...s(this,_)}),s(this,O)&&s(this,at)&&i.resetChanges()}}s(this,O)&&c(this,G,t),c(this,J,requestAnimationFrame(this._stepInternal))}get simulation(){return s(this,k)}destroy(){this.stop(),this.clear(),s(this,J)!==void 0&&cancelAnimationFrame(s(this,J))}start(){s(this,O)||(c(this,O,!0),this._stepInternal(Date.now()))}stop(){c(this,O,!1),c(this,G,void 0)}clear(){var t,e;(t=s(this,k))==null||t.clear(),(e=s(this,L))==null||e.clear()}isRunning(){return s(this,O)}registerSimulation(t){s(this,k)&&(console.error("already have one"),this.destroy()),c(this,k,t)}registerGridRenderer(t,e){c(this,L,t),e&&c(this,_,e)}step(t){s(this,k)&&s(this,k).step(t)}}L=new WeakMap,_=new WeakMap,k=new WeakMap,at=new WeakMap,tt=new WeakMap,O=new WeakMap,J=new WeakMap,G=new WeakMap;function qt(r,t){const{isRunning:e,limitFps:i,resetChanges:n,renderOptions:o,children:u,initSimulation:x,onStep:l,...b}={isRunning:!0,resetChanges:!0,...r},S=w.useRef(null),m=w.useRef(null),M=w.useRef(),[W,I]=w.useState(void 0);w.useImperativeHandle(t,()=>m.current),w.useEffect(()=>{var y;if(S.current&&!m.current)return m.current=new Tt({gridRenderer:S.current,simulation:x(),limitFps:i,resetChanges:n,renderOptions:o,onStep:l}),I((y=m.current.simulation)==null?void 0:y.grid),()=>{var p;(p=m.current)==null||p.destroy(),m.current=null,I(void 0)}},[]),w.useEffect(()=>{m.current&&(e?m.current.start():m.current.stop())},[e]),w.useEffect(()=>{var y;S.current&&(vt.isEqual(o,M.current)||(M.current=o,(y=m.current)==null||y.registerGridRenderer(S.current,o)))},[o]);function z(y){y.preventDefault()}return gt.jsx(Gt,{ref:S,renderOptions:o,grid:W,children:u,onContextMenu:z,...b})}const Ht=w.forwardRef(qt);export{Ft as B,Wt as C,wt as G,Bt as S,h as V,Ct as a,Ht as b,mt as c,Dt as n,yt as r,At as u};

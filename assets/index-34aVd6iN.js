var ct=Object.defineProperty;var lt=(r,t,e)=>t in r?ct(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var c=(r,t,e)=>(lt(r,typeof t!="symbol"?t+"":t,e),e),et=(r,t,e)=>{if(!t.has(r))throw TypeError("Cannot "+e)};var s=(r,t,e)=>(et(r,t,"read from private field"),e?e.call(r):t.get(r)),d=(r,t,e)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,e)},a=(r,t,e,i)=>(et(r,t,"write to private field"),i?i.call(r,e):t.set(r,e),e);var q=(r,t,e)=>(et(r,t,"access private method"),e);import{r as R,j as it,_ as ft}from"./index-uNHEf9r4.js";import"./react-spring_web.modern-b2BuRie1.js";function dt(r){const[t,e]=R.useState(r),i=R.useRef(t);return[i,h=>{h instanceof Function?(i.current=h(i.current),e(h)):(i.current=h,e(h))}]}class rt{constructor(t){c(this,"grid");c(this,"index");c(this,"position");c(this,"dir",{NW:()=>this.getNeighbourInDirection(C.NW),N:()=>this.getNeighbourInDirection(C.N),NE:()=>this.getNeighbourInDirection(C.NE),E:()=>this.getNeighbourInDirection(C.E),SE:()=>this.getNeighbourInDirection(C.SE),S:()=>this.getNeighbourInDirection(C.S),SW:()=>this.getNeighbourInDirection(C.SW),W:()=>this.getNeighbourInDirection(C.W)});this.grid=t,this.index=-1,this.position=new u(0,0)}getNeighbourInDirection(t){if(this.position)return this.grid.getAtPosition(this.position.add(t))}getNeighbourhood(){const t=[];return pt.forEach(e=>{const i=this.getNeighbourInDirection(e);t.push(i)}),t}getLineTo(t,e){return this.grid.getPositionsInLine(this.position,t,e)}swapWith(t){this.grid.swap(this,t)}getRGBA(){return[0,0,0,0]}}var A,b,K,st;class nt{constructor(t){d(this,K);c(this,"size");c(this,"alternateRows");c(this,"createEmpty");d(this,A,void 0);d(this,b,void 0);const{size:e,alternateRows:i,createEmpty:o}={alternateRows:!1,...t};a(this,A,[]),a(this,b,new Set([])),this.size=e,this.alternateRows=i,this.createEmpty=o?()=>o(this):()=>new rt(this),q(this,K,st).call(this)}clear(){q(this,K,st).call(this),this.resetChanges()}indexOf(t){return t?t.index:-1}positionOf(t){if(t)return t.position}forEach(t,e){const{alternateRowDirections:i,evenRows:o,oddRows:h,evenCols:g,oddCols:S}={evenRows:!0,oddRows:!0,evenCols:!0,oddCols:!0,...e},p=new Set,E=(m,I)=>{const y=this.position2index(new u(m,I)),l=s(this,A)[y];if(!l||p.has(l))return;if(t(l,y)===!1)return!1;p.add(l)};for(let m=0;m<this.size.y;m++){const I=m%2;if(I===0&&!o)continue;if(I===1&&!h)continue;let y;if(i&&m%2===0&&Math.random()<.5){for(let l=this.size.x-1;l>=0;l--){const x=l%2;if(!(x===0&&!g)&&!(x===1&&!S)&&(y=E(l,m),y===!1))break}if(y===!1)break;continue}for(let l=0;l<this.size.x;l++){const x=l%2;if(!(x===0&&!g)&&!(x===1&&!S)&&(y=E(l,m),y===!1))break}if(y===!1)break}}map(t){return s(this,A).map(t)}mapChanged(t){return this.getAllChanges().map(t)}getAllChanges(){return[...s(this,b).values()]}countChanges(){return s(this,b).size}forEachChanged(t,e=!1){s(this,b).forEach(t),e&&this.resetChanges()}registerChanged(t){s(this,b).has(t)||s(this,b).add(t)}resetChanges(){s(this,b).clear()}position2index(t){const{x:e,y:i}=t;return e<0||e>=this.size.x||i<0||i>=this.size.y?-1:e+i*this.size.x}index2position(t){const e=Math.floor(t/this.size.x),i=t-e*this.size.x;return new u(i,e)}get(t){return this.getAtPosition(t)}set(t,e){this.setAtPosition(t,e)}getPositionsInLine(t,e,i){const{excludeStart:o,excludeEnd:h}=i||{},g=e.x-t.x,S=e.y-t.y;if(g===0&&S===0)return[t];const p=g<0?-1:1,E=S<0?-1:1,m=Math.abs(g),I=Math.abs(S),y=m>=I,l=Math.min(m,I),x=Math.max(m,I),U=l/x,f=[];for(let N=o?1:0;N<(h?x:x+1);N++){const v=Math.round(N*U);y?f.push(new u(t.x+N*p,t.y+v*E)):f.push(new u(t.x+v*p,t.y+N*E))}return f}getAtPosition(t){const e=this.position2index(t);if(e!==-1)return this.getAtIndex(e)}setAtPosition(t,e){const i=this.position2index(t);this.setAtIndex(i,e)}getAtIndex(t){return s(this,A)[t]}swap(t,e){const i=this.indexOf(t),o=this.indexOf(e);if(i===-1||o===-1)throw new Error("Can't swap unless both cells exists in the grid");const h=s(this,A)[i];this.setAtIndex(i,s(this,A)[o]),this.setAtIndex(o,h)}setAtIndex(t,e){e.index=t,e.position=this.index2position(t),s(this,A)[t]=e,this.registerChanged(e)}}A=new WeakMap,b=new WeakMap,K=new WeakSet,st=function(){for(let t=0;t<this.size.x*this.size.y;t++)this.setAtIndex(t,this.createEmpty())};var M,D,G,L;class gt extends rt{constructor(){super(...arguments);d(this,M,new Set);d(this,D,void 0);d(this,G,void 0);d(this,L,void 0)}get dirtyRect(){return s(this,L)}haveChanges(){return s(this,M).size>0}countChanges(){return s(this,M).size}registerChange(e){s(this,M).has(e)||(s(this,M).add(e),a(this,D,u.min(s(this,D)||u.positiveInfinity,e.position)),a(this,G,u.max(s(this,G)||u.negativeInfinity,e.position)),a(this,L,new yt(s(this,D),s(this,G).subtract(s(this,D)))))}resetChanges(){s(this,M).clear(),a(this,D,void 0),a(this,G,void 0),a(this,L,void 0)}forEachChangedCell(e,i=!1){s(this,M).forEach(e),i&&this.resetChanges()}}M=new WeakMap,D=new WeakMap,G=new WeakMap,L=new WeakMap;function xt(r){return new Worker("/assets/worker-G1OrwRg-.js",{name:r==null?void 0:r.name})}var z,Y,O,Q,V,ot,_,ht,tt,at;class mt extends nt{constructor(e){const{chunkSize:i,workerize:o,...h}=e;super(h);d(this,V);d(this,_);d(this,tt);c(this,"chunkSize",new u(64,64));d(this,z,void 0);d(this,Y,void 0);d(this,O,void 0);d(this,Q,[]);this.chunkSize=i||new u(64,64),a(this,z,new nt({size:this.size.divide(this.chunkSize),createEmpty:g=>new gt(g)})),a(this,Y,o||!1),s(this,Y)&&(a(this,O,new xt),s(this,O).onmessage=this.handleWorkerResponse),q(this,V,ot).call(this)}clear(){super.clear(),this.resetChanges()}registerChanged(e){const i=this.chunkOf(e);i&&i.registerChange(e)}resetChanges(){super.resetChanges(),this.forEachChunk(e=>e.resetChanges())}countChanges(){return this.mapChunks(e=>e.countChanges()).reduce((e,i)=>e+i)}forEachChanged(e,i){this.forEachChunk(o=>{o.haveChanges()&&o.forEachChangedCell(e,i)})}chunkOf(e){if(!e||!this.chunkSize)return;const i=e.position.divide(this.chunkSize).floor();return s(this,z).get(i)}forEachChunk(e,i){s(this,z).forEach(e,i)}mapChunks(e){return s(this,z).map(e)}forEachChangedChunkPass(e,i=!1){this.forEachChunkPass(o=>{const h=o.filter(g=>g.haveChanges());h.length!==0&&(e(h),i&&h.forEach(g=>g.resetChanges()))})}forEachChunkPass(e){s(this,Q).forEach((i,o)=>{s(this,Y)?q(this,tt,at).call(this,()=>e(i,o)):e(i,o)})}handleWorkerResponse(e){console.log("worker says:",this,e.data)}}z=new WeakMap,Y=new WeakMap,O=new WeakMap,Q=new WeakMap,V=new WeakSet,ot=function(){for(let e=0;e<s(this,z).size.x*s(this,z).size.y;e++)s(this,z).setAtIndex(e,s(this,z).createEmpty());q(this,_,ht).call(this)},_=new WeakSet,ht=function(){const e=[[!1,!1],[!1,!0],[!0,!1],[!0,!0]],i=[];e.forEach(([o,h])=>{const g=[];this.forEachChunk(S=>{g.push(S)},{evenRows:!o,oddRows:o,evenCols:!h,oddCols:h}),i.push(g)}),a(this,Q,i)},tt=new WeakSet,at=function(e){s(this,O)&&s(this,O).postMessage({f:e})};class yt{constructor(t,e){c(this,"position");c(this,"size");this.position=t,this.size=e}toArray(){return[...this.position.toArray(),...this.size.toArray()]}}const n=class n{constructor(t=0,e=0){c(this,"x");c(this,"y");this.x=t,this.y=e}clone(){return new n(this.x,this.y)}add(t){return new n(this.x+t.x,this.y+t.y)}addScalar(t){return new n(this.x+t,this.y+t)}subtract(t=n.zero){return new n(this.x-t.x,this.y-t.y)}subtractScalar(t){return new n(this.x-t,this.y-t)}multiply(t){return new n(this.x*t.x,this.y*t.y)}multiplyScalar(t){return new n(this.x*t,this.y*t)}divide(t){return new n(this.x/t.x,this.y/t.y)}divideScalar(t){return new n(this.x/t,this.y/t)}mod(t){return new n(this.x%t.x,this.y%t.y)}modScalar(t){return new n(this.x%t,this.y%t)}abs(){return new n(Math.abs(this.x),Math.abs(this.y))}round(){return new n(Math.round(this.x),Math.round(this.y))}floor(){return new n(Math.floor(this.x),Math.floor(this.y))}ceil(){return new n(Math.ceil(this.x),Math.ceil(this.y))}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){const t=this.length();return t===0?n.zero:this.multiplyScalar(1/t)}dot(t){const e=this.multiply(t);return e.x+e.y}isEqual(t){return this.x===t.x&&this.y===t.y}isNear(t,e=.001){const i=this.subtract(t).abs();return i.x<=e&&i.y<=e}toArray(){return[this.x,this.y]}join(t){return this.toArray().join(t)}static min(t,e){return new n(Math.min(t.x,e.x),Math.min(t.y,e.y))}static max(t,e){return new n(Math.max(t.x,e.x),Math.max(t.y,e.y))}static fromArray([t,e]){return new n(t,e)}static random(){return new n(Math.random(),Math.random())}};c(n,"zero",new n),c(n,"one",new n(1,1)),c(n,"up",new n(0,-1)),c(n,"down",new n(0,1)),c(n,"left",new n(-1,0)),c(n,"right",new n(1,0)),c(n,"negativeInfinity",new n(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)),c(n,"positiveInfinity",new n(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY));let u=n;const C={NW:new u(-1,-1),N:new u(0,-1),NE:new u(1,-1),E:new u(1,0),SE:new u(1,1),S:new u(0,1),SW:new u(-1,1),W:new u(-1,0)},pt=[C.NW,C.N,C.NE,C.W,C.E,C.SW,C.S,C.SE];class kt{constructor(t){c(this,"grid");const{gridOptions:e}=t;this.grid=this.createGrid(e)}clear(){this.grid.clear()}}function wt(r,t){const{children:e,grid:i,debugDraw:o,pickColor:h,...g}={debugDraw:!1,...r},S=R.useRef(null),p=R.useRef(),[E,m]=dt(!0);R.useImperativeHandle(t,()=>({clear:l,render:x})),R.useEffect(()=>{i&&(l(),x(i))},[i]);function I(){return S.current?S.current.getContext("2d"):null}function y(){if(p.current)return p.current;if(!i)return;const f=I();if(f)return p.current=f.createImageData(...i.size.toArray()),p.current}function l(){const f=y();f&&(f.data.fill(0),m(!0))}function x(f,N={debugDraw:o}){const{debugDraw:v,resetChanges:X}={debugDraw:!1,resetChanges:!1,...N};if(!f)return;const w=I();if(!w)return;const Z=y();Z&&(E.current===!0?f.forEach(J=>U({imageData:Z,cell:J})):f.forEachChanged(J=>U({imageData:Z,cell:J}),X),w.putImageData(Z,0,0),v&&f instanceof mt&&f.forEachChunkPass((J,ut)=>{J.forEach(F=>{w.strokeStyle=F.haveChanges()?"white":"rgba(0, 0, 0, 0.2)",w.fillStyle=w.strokeStyle,w.lineWidth=1;const $=F.position.multiply(f.chunkSize);w.strokeRect(...$.toArray(),...f.chunkSize.toArray()),w.textAlign="right",w.fillText(F.position.toArray().toString(),...$.add(f.chunkSize).subtractScalar(2).toArray()),w.textAlign="left",w.fillText(ut.toString(),...$.add(f.chunkSize.multiply(u.down).add(u.fromArray([2,-2]))).toArray(),f.chunkSize.x),F.dirtyRect&&(w.strokeStyle="red",w.fillStyle="red",w.textAlign="left",w.fillText(F.countChanges().toString(),...$.add(u.fromArray([2,10])).toArray()),w.strokeRect(...F.dirtyRect.position.toArray(),...F.dirtyRect.size.toArray()))})}),m(!1))}function U(f){const{imageData:N,cell:v}=f;if(v.index===-1)return;const X=h?h({cell:v}):v.getRGBA();X&&N.data.set(X,v.index*4)}if(i)return it.jsxs("div",{className:"grid canvas",children:[it.jsx("canvas",{ref:S,width:i.size.x||1,height:i.size.y||1,...g}),e]})}const Ct=R.forwardRef(wt);var P,H,k,B,W,T,j;class St{constructor(t){d(this,P,void 0);d(this,H,void 0);d(this,k,void 0);c(this,"limitFps");d(this,B,void 0);d(this,W,!0);d(this,T,void 0);d(this,j,void 0);const{gridRenderer:e,renderOptions:i,simulation:o,limitFps:h,onStep:g}=t;a(this,P,e),a(this,H,i),a(this,k,o),this.limitFps=h,a(this,B,g),this._stepInternal=this._stepInternal.bind(this),a(this,T,requestAnimationFrame(this._stepInternal))}_stepInternal(t){this.step(t),a(this,T,requestAnimationFrame(this._stepInternal))}get simulation(){return s(this,k)}destroy(){var t,e;this.stop(),(t=s(this,k))==null||t.clear(),(e=s(this,P))==null||e.clear(),s(this,T)!==void 0&&cancelAnimationFrame(s(this,T))}start(){s(this,W)||(a(this,W,!0),this._stepInternal(Date.now()))}stop(){a(this,W,!1)}restart(){this.destroy(),this.start()}isRunning(){return s(this,W)}registerSimulation(t){s(this,k)&&(console.error("already have one"),this.destroy()),a(this,k,t)}registerGridRenderer(t,e){a(this,P,t),e&&a(this,H,e)}step(t){if(s(this,j)===void 0)a(this,j,t);else{const e=(t-s(this,j))/1e3;if(this.limitFps===void 0||e>1/this.limitFps){if(s(this,k)){const i=s(this,k).grid;if(!i)throw new Error("simulation or grid must be provided");s(this,W)&&s(this,k).step(e),s(this,B)&&s(this,B).call(this,{grid:i,deltaTime:e}),s(this,P)&&s(this,P).render(i,{resetChanges:!1,...s(this,H)}),i.resetChanges()}a(this,j,t)}}}}P=new WeakMap,H=new WeakMap,k=new WeakMap,B=new WeakMap,W=new WeakMap,T=new WeakMap,j=new WeakMap;function Et(r,t){var y,l;const{limitFps:e,renderOptions:i,children:o,initSimulation:h,onStep:g,...S}=r,p=R.useRef(null),E=R.useRef(null),m=R.useRef();R.useImperativeHandle(t,()=>E.current),R.useEffect(()=>{if(p.current&&!E.current)return E.current=new St({gridRenderer:p.current,simulation:h(),limitFps:e,renderOptions:i,onStep:g}),()=>{var x;(x=E.current)==null||x.destroy()}}),R.useEffect(()=>{var x;p.current&&(ft.isEqual(i,m.current)||(m.current=i,(x=E.current)==null||x.registerGridRenderer(p.current,i)))},[i]);function I(x){x.preventDefault()}return it.jsx(Ct,{ref:p,grid:(l=(y=E.current)==null?void 0:y.simulation)==null?void 0:l.grid,children:o,onContextMenu:I,...S})}const At=R.forwardRef(Et);export{mt as C,rt as G,kt as S,u as V,At as a,nt as b,pt as n,dt as u};

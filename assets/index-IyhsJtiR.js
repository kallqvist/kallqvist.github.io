var Ne=Object.defineProperty;var Pe=(n,t,e)=>t in n?Ne(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var r=(n,t,e)=>(Pe(n,typeof t!="symbol"?t+"":t,e),e),Y=(n,t,e)=>{if(!t.has(n))throw TypeError("Cannot "+e)};var f=(n,t,e)=>(Y(n,t,"read from private field"),e?e.call(n):t.get(n)),v=(n,t,e)=>{if(t.has(n))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(n):t.set(n,e)},y=(n,t,e,s)=>(Y(n,t,"write to private field"),s?s.call(n,e):t.set(n,e),e);var J=(n,t,e,s)=>({set _(i){y(n,t,i,e)},get _(){return f(n,t,s)}}),ue=(n,t,e)=>(Y(n,t,"access private method"),e);import{r as w,_ as ce,j as u,F as We,i as Be,l as Ge}from"./index-HCLPNXdc.js";import{G as Ee,V as c,a as Ie,u as B,b as ze}from"./index-KJY1D0CQ.js";var k;class U extends Ee{constructor(e,s){super(e);r(this,"empty");r(this,"shouldTryAwakeNeighbours");r(this,"color");r(this,"behaviors");v(this,k,!1);r(this,"index",-1);r(this,"position",new c(0,0));r(this,"age",0);r(this,"brushSize",4);r(this,"brushFillRate",.05);r(this,"velocity",new c(0,0));const{empty:i,shouldTryAwakeNeighbours:o,behaviors:l}={empty:!1,shouldTryAwakeNeighbours:!0,behaviors:[],...s};this.empty=i,this.shouldTryAwakeNeighbours=o,this.color=this.getRGBA(),this.behaviors=l}isSleeping(){return f(this,k)}sleep(){y(this,k,!0),this.grid.registerChanged(this)}awake(){y(this,k,!1),this.grid.registerChanged(this)}die(){this.grid.set(this.position,new N(this.grid))}getRGBA(){return this.color}addBehaviors(...e){this.behaviors.push(...e)}step(e){this.age+=e,this.behaviors.forEach(s=>{s.step({deltaTime:e,cell:this,grid:this.grid})})}}k=new WeakMap;class N extends U{constructor(e){super(e,{empty:!0});r(this,"name","empty");r(this,"brushSize",2);r(this,"brushFillRate",1);r(this,"color",[50,50,50,255]);this.sleep()}awake(){}step(){}}class p{}class de extends U{constructor(t,e){super(t,e);const{gravity:s,dispersionRate:i,erosionFactor:o}=e||{};this.addBehaviors(new me(s),new Le(i),new qe(o))}}class P extends de{}class K extends p{constructor(e=1){super();r(this,"sinkChance");this.sinkChance=e}step({cell:e}){if(Math.random()>this.sinkChance)return;const s=e.dir.S();if(s instanceof P){e.swapWith(s);return}const i=[-1,1];Math.random()>=.5&&i.reverse(),i.every(o=>{const l=e.getNeighbourInDirection(new c(o,1));return l instanceof P?(e.swapWith(l),!1):!0})}}class le extends p{constructor(e=1){super();r(this,"floatChance");this.floatChance=e}step({cell:e}){if(Math.random()>this.floatChance)return;const s=e.dir.N();s instanceof P&&e.swapWith(s)}}class L extends U{}class j extends L{constructor(t,e){super(t,e),this.addBehaviors(new me)}}class Te extends p{constructor(e=.05){super();r(this,"digChance");this.digChance=e}step({cell:e}){if(Math.random()>this.digChance)return;const s=e.getNeighbourhood().filter(i=>i&&!(i!=null&&i.empty)&&i instanceof j);if(s.length>0){const i=s[Math.floor(Math.random()*s.length)];if(!i)return;e.swapWith(i)}}}var G,I;class Le extends p{constructor(e=50){super();v(this,G,0);v(this,I,100+Math.random()*25);r(this,"dispersionRate");this.dispersionRate=e}step({cell:e,grid:s}){var l,d;let i=!1;const o=[-1,1];Math.random()>=.5&&o.reverse(),e.isSleeping()&&o.every(m=>{const h=e.getNeighbourInDirection(new c(m,0));return h!=null&&h.empty?(e.swapWith(h),!1):!0}),f(this,G)<=f(this,I)?o.every(m=>(s.getPositionsInLine(e.position,e.position.add(new c(m*this.dispersionRate,0)),{excludeStart:!0}).every(h=>{const g=s.getAtPosition(h);return g!=null&&g.empty?(e.swapWith(g),i=!0,J(this,G)._++,!1):!(g instanceof L)}),!i)):((l=e.dir.W())!=null&&l.empty||(d=e.dir.E())!=null&&d.empty)&&e.die()}}G=new WeakMap,I=new WeakMap;class He extends p{constructor(e=.05){super();r(this,"eatChance");this.eatChance=e}step({cell:e}){if(Math.random()>this.eatChance)return;const s=e.getNeighbourhood().filter(i=>i&&!(i!=null&&i.empty)&&i instanceof pe);if(s.length>0){const i=s[Math.floor(Math.random()*s.length)];if(!i)return;i.die()}}}class qe extends p{constructor(e=.005){super();r(this,"erosionFactor");this.erosionFactor=e}step({cell:e}){if(this.erosionFactor>0){const s=e.dir.S();s instanceof j&&Math.random()<this.erosionFactor&&e.swapWith(s)}}}class H extends L{constructor(e,s){super(e,{shouldTryAwakeNeighbours:!1,...s});r(this,"brushSize",2);r(this,"brushFillRate",1);this.sleep()}awake(){}step(){}}var _,z;class me extends p{constructor(e=new c(0,9)){super();v(this,_,0);v(this,z,100);r(this,"isFalling",!1);r(this,"gravity");this.gravity=e}step({cell:e,grid:s,deltaTime:i}){let o=!1;const l=[-1,1];if(Math.random()>=.5&&l.reverse(),e.isSleeping()){const d=e.getNeighbourInDirection(this.gravity.y<0?c.up():c.down());d!=null&&d.empty&&(e.swapWith(d),o=!0,this.isFalling=!0)}else{e.velocity=e.velocity.add(this.gravity.multiplyScalar(i));let d=e;e.getLineTo(e.position.add(e.velocity),{excludeStart:!0}).every(m=>{const h=s.get(m);if(!(h!=null&&h.empty)){if(this.isFalling&&(h instanceof H||h instanceof j)){const g=e.velocity.subtract((h==null?void 0:h.velocity)||c.zero()).abs(),E=Math.random()*.2,q=Math.random()*.05;g.length()>0&&(e.velocity=new c(e.velocity.x+(Math.random()<.5?-1:1)*g.y*E,-g.y*q),d=e,this.isFalling=!1)}return!1}return d=h,!0}),d!==e?(e.swapWith(d),o=!0):l.every(m=>{const h=e.getNeighbourInDirection(new c(m,1));return h!=null&&h.empty?(e.swapWith(h),o=!0,!1):!0})}o?(l.every(d=>{const m=e.getNeighbourInDirection(new c(d,0));return m!=null&&m.empty||m==null||m.awake(),!0}),y(this,_,0)):(this.isFalling=!1,J(this,_)._++,f(this,_)>=f(this,z)&&e.sleep())}}_=new WeakMap,z=new WeakMap;class Oe extends p{constructor(e=.05,s=1,i=2){super();r(this,"jumpChance");r(this,"jumpHeight");r(this,"jumpLength");this.jumpChance=e,this.jumpHeight=s,this.jumpLength=i}step({cell:e}){if(Math.random()>this.jumpChance)return;const s=(Math.random()*2-1)*this.jumpLength,i=-Math.random()*this.jumpHeight;e.velocity=new c(s,i),Math.random()<.1&&(e.velocity=e.velocity.multiplyScalar(1.2)),e.awake()}}class fe extends p{constructor(e,s=1){super();r(this,"maxAge");r(this,"survivalChance");this.maxAge=e,this.survivalChance=s}step({cell:e}){Math.random()<this.survivalChance||e.age>this.maxAge&&e.die()}}class Ve extends p{constructor(e=.05){super();r(this,"survivalChance");this.survivalChance=e}step({cell:e}){if(Math.random()<this.survivalChance)return;e.getNeighbourhood().map(o=>o instanceof P?1:0).reduce((o,l)=>o+l)>2&&e.die()}}class Xe extends p{constructor(e,s=3,i=5,o=.005){super();r(this,"spawn");r(this,"breedMinAge");r(this,"breedMaxAge");r(this,"breedChance");this.spawn=e,this.breedMinAge=s,this.breedMaxAge=i,this.breedChance=o}step({cell:e,grid:s}){if(e.isSleeping()||e.age<this.breedMinAge||e.age>this.breedMaxAge||Math.random()>this.breedChance)return;const i=e.dir.S();i&&i.constructor.prototype===e.constructor.prototype&&(i.age<this.breedMinAge||i.age>this.breedMaxAge||e.getNeighbourhood().every(o=>o!=null&&o.empty?(s.setAtIndex(o.index,this.spawn()),!1):!0))}}class Ye extends p{step({cell:t}){if(!t.isSleeping()||Math.random()<.995)return;t.getNeighbourhood().map(i=>i===void 0?1:i.empty?.5:i instanceof we?-1:i instanceof L?2:i instanceof P?1:0).reduce((i,o)=>i+o)>0&&t.die()}}class Q extends j{constructor(e,s){super(e,s);r(this,"name","flea");r(this,"_r",Math.random()*20);r(this,"color",[0,this._r,0,255]);r(this,"brushFillRate",.005);const i=5;this.addBehaviors(new Oe,new Xe(()=>new Q(e),3,i,.1),new le,new Ve(.95),new He,new Te,new fe(i,.95))}die(){this.grid.setAtIndex(this.index,new Je(this,this.grid))}}class Je extends j{constructor(e,s,i){super(s,i);r(this,"name","dead flea");r(this,"_r",Math.random()*20+10);r(this,"color");this.color=[...e.color.slice(0,3).map(o=>o+this._r),255],this.addBehaviors(new K(.05),new fe(10,.995))}}class pe extends H{constructor(){super(...arguments);r(this,"name","leaf");r(this,"_r",Math.random()*20);r(this,"color",[100-this._r,180-this._r,100-this._r,255-this._r]);r(this,"brushFillRate",.4)}}class Ue extends j{constructor(e,s){super(e,s);r(this,"name","sand");r(this,"_r",Math.random()*20);r(this,"color",[191-this._r,155-this._r,123-this._r,255]);this.addBehaviors(new K)}}class ge extends de{constructor(t,e){super(t,{dispersionRate:8,gravity:new c(0,-.25),erosionFactor:0,shouldTryAwakeNeighbours:!1,...e}),this.addBehaviors(new le(.2)),this.velocity=this.velocity.add(c.random().multiplyScalar(2).add(c.one().multiplyScalar(-1)).multiplyScalar(.025).multiply(c.right()))}}class Ke extends ge{constructor(){super(...arguments);r(this,"name","smoke");r(this,"color",[90,90,90,Math.round(Math.random()*185)+70])}}class we extends j{constructor(e,s){super(e,s);r(this,"name","snow");r(this,"_r",Math.random()*20);r(this,"color",[220-this._r,220-this._r,255,255]);this.addBehaviors(new Ye,new K(.05))}getRGBA(){return this.isSleeping()?this.color:[220,220,255,255]}die(){this.grid.set(this.position,Math.random()<.25?new Z(this.grid):new N(this.grid))}}class ve extends ge{constructor(){super(...arguments);r(this,"name","steam");r(this,"_r",Math.round(Math.random()*80)+100);r(this,"color",[255,255,255,this._r])}die(){this.grid.set(this.position,Math.random()<.05?new Z(this.grid):new N(this.grid))}}class Qe extends H{constructor(){super(...arguments);r(this,"name","stone");r(this,"color",[100,100,100,255])}}class Z extends P{constructor(e,s){super(e,{...s,dispersionRate:3});r(this,"name","water");r(this,"_r",Math.round(Math.random()*100)+155);r(this,"color",[46,137,255,this._r])}die(){this.grid.set(this.position,Math.random()<.25?new ve(this.grid):new N(this.grid))}}class Ze extends H{constructor(){super(...arguments);r(this,"name","wood");r(this,"_r",Math.random()*20);r(this,"color",[180-this._r,100-this._r,100-this._r,255-this._r])}}var M,A,T,xe;class $e{constructor(t){v(this,T);v(this,M,void 0);v(this,A,!0);r(this,"materialPalette");y(this,M,new Ie({...t,createEmpty:e=>new N(e)})),this.materialPalette=ue(this,T,xe).call(this,f(this,M))}isRunning(){return f(this,A)}start(){y(this,A,!0)}stop(){y(this,A,!1)}restart(){this.stop(),f(this,M).clear(),this.start()}getGrid(){return f(this,M)}step(t){if(!f(this,A))return;f(this,M).forEach(s=>{s.empty||s.step(t)},{alternateRowDirections:!0})}}M=new WeakMap,A=new WeakMap,T=new WeakSet,xe=function(t){return{empty:()=>new N(t),flea:()=>new Q(t),leaf:()=>new pe(t),sand:()=>new Ue(t),smoke:()=>new Ke(t),snow:()=>new we(t),steam:()=>new ve(t),stone:()=>new Qe(t),water:()=>new Z(t),wood:()=>new Ze(t)}};function rt(){var ie;const e=w.useRef(null),s=w.useRef(),i=w.useRef(),o=w.useRef(),l=w.useRef(),d=w.useRef(void 0),[m,h]=B(!0),[g,E]=B(!1),[q,ye]=B([0,0]),[O,Me]=B("sand"),[$,be]=w.useState([0]),[ee,Se]=B(!1),[Fe,Ce]=w.useState(void 0),[Re,Ae]=w.useState([]);w.useEffect(()=>(s.current=new $e({width:320,height:180}),i.current=s.current.getGrid(),Ae(ce.keys(s.current.materialPalette)),re(),o.current=requestAnimationFrame(te),()=>{o.current!==void 0&&cancelAnimationFrame(o.current)}),[]),w.useEffect(()=>{const a=s.current;a&&(m.current?a.start():a.stop())},[m.current]);function je(a){a.preventDefault()}function De(a){const x=a.target,{x:b,y:S,width:F,height:ne}=x.getBoundingClientRect(),C=[(a.clientX-b)/F,(a.clientY-S)/ne];ye(C);const R=s.current;if(!R)return;const D=R.getGrid(),ae=new c(Math.floor(C[0]*D.width),Math.floor(C[1]*D.height)),W=D.getAtPosition(ae);W&&Ce(W.name)}function te(a){if(l.current===void 0)l.current=a;else{const x=(a-l.current)/1e3;{const b=s.current;if(!b)return;const S=b.getGrid();_e(S),b.step(x),l.current=a,be(F=>[...F.slice(F.length-100),1/x])}}o.current=requestAnimationFrame(te)}function ke(){E(!0)}function se(){E(!1),d.current=void 0}function _e(a){if(!g.current||!O.current)return;const[x,b]=q.current,S=new c(Math.floor(x*a.width),Math.floor(b*a.height)),F=s.current;if(!F)return;const C=F.materialPalette[O.current];if(!C)return;const R=C(),D=Math.floor(R.brushSize);(d.current?a.getPositionsInLine(d.current,S):[S]).every(W=>{for(let V=-D;V<R.brushSize;V++)for(let X=-D;X<R.brushSize;X++){if(Math.random()>R.brushFillRate)continue;const oe=W.x+X;if(oe<0)continue;const he=W.y+V;he<0||a.setAtPosition(new c(oe,he),C())}return!0}),d.current=S}function re(){const a=s.current;a&&a.restart()}return u.jsxs("div",{className:"route sand",ref:e,children:[u.jsxs("div",{className:"materials",children:[u.jsxs("div",{children:[u.jsx("button",{onClick:()=>h(a=>!a),children:m.current?u.jsxs(u.Fragment,{children:[u.jsx(We,{}),"stop"]}):u.jsxs(u.Fragment,{children:[u.jsx(Be,{}),"start"]})}),u.jsxs("button",{onClick:()=>re(),children:[u.jsx(Ge,{}),"reset"]})]}),u.jsx("div",{className:"separator"}),ce.map(Re,a=>u.jsx("div",{className:"material",children:a,onClick:()=>Me(a),style:O.current===a?{border:"1px solid white"}:void 0},a)),u.jsx("div",{className:"separator"}),u.jsxs("div",{children:[u.jsx("input",{id:"debugDraw",type:"checkbox",checked:ee.current,onChange:a=>Se(a.target.checked)}),u.jsx("label",{htmlFor:"debugDraw",children:"debugDraw"})]}),u.jsx("div",{className:"separator"}),u.jsxs("div",{style:{width:"60px",whiteSpace:"nowrap"},children:["fps: ",Math.round($.reduce((a,x)=>a+x)/$.length||1)]})]}),u.jsx(ze,{grid:(ie=s.current)==null?void 0:ie.getGrid(),onMouseDown:ke,onMouseUp:se,onMouseLeave:se,onMouseMove:De,onContextMenu:je,pickColor:a=>ee.current&&!a.isSleeping()?[255,255,255,255]:a.getRGBA(),children:u.jsx("div",{style:{position:"absolute",top:0,right:0,padding:"0.25em",fontSize:"0.8em"},children:Fe})})]})}export{rt as default};

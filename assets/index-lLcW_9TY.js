var dt=Object.defineProperty;var lt=(s,t,e)=>t in s?dt(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var d=(s,t,e)=>(lt(s,typeof t!="symbol"?t+"":t,e),e),st=(s,t,e)=>{if(!t.has(s))throw TypeError("Cannot "+e)};var n=(s,t,e)=>(st(s,t,"read from private field"),e?e.call(s):t.get(s)),l=(s,t,e)=>{if(t.has(s))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(s):t.set(s,e)},u=(s,t,e,i)=>(st(s,t,"write to private field"),i?i.call(s,e):t.set(s,e),e);var H=(s,t,e)=>(st(s,t,"access private method"),e);import{r as S,j as nt,_ as gt}from"./index-ybDCGMjX.js";import"./react-spring_web.modern-Laymt9A_.js";function pt(s){const[t,e]=S.useState(s),i=S.useRef(t);return[i,a=>{a instanceof Function?(i.current=a(i.current),e(a)):(i.current=a,e(a))}]}class ht{constructor(t){d(this,"grid");d(this,"index");d(this,"position");d(this,"dir",{NW:()=>this.getNeighbourInDirection(m.NW),N:()=>this.getNeighbourInDirection(m.N),NE:()=>this.getNeighbourInDirection(m.NE),E:()=>this.getNeighbourInDirection(m.E),SE:()=>this.getNeighbourInDirection(m.SE),S:()=>this.getNeighbourInDirection(m.S),SW:()=>this.getNeighbourInDirection(m.SW),W:()=>this.getNeighbourInDirection(m.W)});this.grid=t,this.index=-1,this.position=new f(0,0)}getNeighbourInDirection(t){if(this.position)return this.grid.getAtPosition(this.position.add(t))}getNeighbourhood(){const t=[];return Et.forEach(e=>{const i=this.getNeighbourInDirection(e);t.push(i)}),t}getLineTo(t,e){return this.grid.getPositionsInLine(this.position,t,e)}swapWith(t){this.grid.swap(this,t)}getRGBA(){return[0,0,0,0]}}var M,U,Z,rt;class ot{constructor(t){l(this,Z);d(this,"size");d(this,"alternateRows");d(this,"createEmpty");d(this,"grid");l(this,M,void 0);l(this,U,0);const{size:e,alternateRows:i,createEmpty:r}={alternateRows:!1,...t};if(!e.frac().isEqual(f.zero))throw new Error(`Grid size must be integers (${e.toArray().join(", ")})`);this.grid=[],u(this,M,new Set([])),this.size=e,this.alternateRows=i,this.createEmpty=r?()=>r(this):()=>new ht(this),H(this,Z,rt).call(this)}clear(){H(this,Z,rt).call(this),this.resetChanges()}indexOf(t){return t?t.index:-1}positionOf(t){if(t)return t.position}forEach(t,e){const{alternateRowDirections:i,evenRows:r,oddRows:a,evenCols:c,oddCols:g,startRow:w,endRow:C,startCol:E,endCol:z}={evenRows:!0,oddRows:!0,evenCols:!0,oddCols:!0,...e},b=new Set,N=(y,p)=>{const I=this.position2index(new f(y,p)),h=this.grid[I];if(!h||b.has(h))return;if(t(h,I)===!1)return!1;b.add(h)};for(let y=w||0;y<(C||this.size.y);y++){const p=y%2;if(p===0&&!r)continue;if(p===1&&!a)continue;let I;if(i&&y%2===0){for(let h=(z||this.size.x)-1;h>=(E||0);h--){const R=h%2;if(!(R===0&&!c)&&!(R===1&&!g)&&(I=N(h,y),I===!1))break}if(I===!1)break;continue}for(let h=E||0;h<(z||this.size.x);h++){const R=h%2;if(!(R===0&&!c)&&!(R===1&&!g)&&(I=N(h,y),I===!1))break}if(I===!1)break}}map(t){return this.grid.map(t)}mapChanged(t){return this.getAllChanges().map(t)}getAllChanges(){return[...n(this,M).values()]}countChanges(){return n(this,M).size}forEachChanged(t,e=!1){n(this,M).forEach(t),e&&this.resetChanges()}registerChanged(t){t.index<0||t.index>=this.grid.length||n(this,M).has(t)||n(this,M).add(t)}resetChanges(){n(this,M).clear()}position2index(t){const{x:e,y:i}=t;return e<0||e>=this.size.x||i<0||i>=this.size.y?-1:e+i*this.size.x}index2position(t){const e=Math.floor(t/this.size.x),i=t-e*this.size.x;return new f(i,e)}get(t){return this.getAtPosition(t)}set(t,e){this.setAtPosition(t,e)}getPositionsInLine(t,e,i){const{excludeStart:r,excludeEnd:a,maxSteps:c}={maxSteps:n(this,U),...i},g=e.x-t.x,w=e.y-t.y;if(g===0&&w===0)return[t];const C=g<0?-1:1,E=w<0?-1:1,z=Math.abs(g),b=Math.abs(w),N=z>=b,y=Math.min(z,b),p=Math.max(z,b),I=y/p,h=[],R=r?1:0,P=a?p:p+1,q=P-R,x=c!==void 0&&q>c?Math.floor(q/c):1;for(let k=R;k<P;k+=x){const F=Math.round(k*I);N?h.push(new f(t.x+k*C,t.y+F*E)):h.push(new f(t.x+F*C,t.y+k*E))}return h}getAtPosition(t){const e=this.position2index(t);if(e!==-1)return this.getAtIndex(e)}setAtPosition(t,e){if(t.x<0||t.x>=this.size.x||t.y<0||t.y>=this.size.y)return;const i=this.position2index(t);this.setAtIndex(i,e)}getAtIndex(t){return this.grid[t]}swap(t,e){const i=this.indexOf(t),r=this.indexOf(e);if(i===-1||r===-1)throw new Error("Can't swap unless both cells exists in the grid");const a=this.grid[i];this.setAtIndex(i,this.grid[r]),this.setAtIndex(r,a)}setAtIndex(t,e){if(t<0)throw new Error(`invalid index: ${t}`);e.index=t,e.position=this.index2position(t),this.grid[t]=e,this.registerChanged(e)}}M=new WeakMap,U=new WeakMap,Z=new WeakSet,rt=function(){const t=this.size.x*this.size.y;this.grid.length=t;for(let e=0;e<t;e++)this.setAtIndex(e,this.createEmpty());u(this,U,this.size.length())};var D,G,B,W;class xt extends ht{constructor(e,i){super(e);d(this,"parent");l(this,D,new Set);l(this,G,void 0);l(this,B,void 0);l(this,W,void 0);this.parent=i}get dirtyRect(){return n(this,W)}forEachDirty(e,i){if(!n(this,W))return;const{onBeforeAll:r,...a}=i||{},c=n(this,W).tl,g=n(this,W).br;r&&r(),this.parent.forEach(e,{startRow:c.y,endRow:g.y,startCol:c.x,endCol:g.x,...a})}forEach(e,i){const r=this.parent.chunkSize,a=this.position.multiply(r),c=this.position.multiply(r).add(r);this.parent.forEach(e,{startRow:a.y,endRow:c.y,startCol:a.x,endCol:c.x,...i})}haveChanges(){return n(this,D).size>0}countChanges(){return n(this,D).size}registerChange(e){n(this,D).has(e)||(n(this,D).add(e),u(this,G,f.min(n(this,G)||f.positiveInfinity,e.position)),u(this,B,f.max(n(this,B)||f.negativeInfinity,e.position)),u(this,W,new St(n(this,G),n(this,B).subtract(n(this,G)))))}resetChanges(){n(this,D).clear(),u(this,G,void 0),u(this,B,void 0),u(this,W,void 0)}forEachChangedCell(e,i=!1){n(this,D).forEach(e),i&&this.resetChanges()}}D=new WeakMap,G=new WeakMap,B=new WeakMap,W=new WeakMap;function yt(s){return new Worker("/assets/worker-G1OrwRg-.js",{name:s==null?void 0:s.name})}var v,J,X,$,tt,at,et,ut,it,ct;class mt extends ot{constructor(e){const{chunkSize:i,workerize:r,...a}=e;super(a);l(this,tt);l(this,et);l(this,it);d(this,"chunkSize",new f(64,64));l(this,v,void 0);l(this,J,void 0);l(this,X,void 0);l(this,$,[]);this.chunkSize=i||new f(64,64),u(this,v,new ot({size:this.size.divide(this.chunkSize),createEmpty:c=>new xt(c,this)})),u(this,J,r||!1),n(this,J)&&(u(this,X,new yt),n(this,X).onmessage=this.handleWorkerResponse),H(this,tt,at).call(this)}clear(){super.clear(),this.resetChanges()}registerChanged(e){if(e.index<0||e.index>=this.grid.length)return;const i=this.chunkOf(e);i&&i.registerChange(e)}resetChanges(){super.resetChanges(),this.forEachChunk(e=>e.resetChanges())}countChanges(){return this.mapChunks(e=>e.countChanges()).reduce((e,i)=>e+i)}getAllChanges(){const e=[];return this.forEachChanged(i=>e.push(i)),e}forEachChanged(e,i){this.forEachChunk(r=>{r.haveChanges()&&r.forEachChangedCell(e,i)})}chunkOf(e){if(!e||!this.chunkSize)return;const i=e.position.divide(this.chunkSize).floor();return n(this,v).get(i)}getChunk(e){return n(this,v).get(e)}forEachChunk(e,i){n(this,v).forEach(e,i)}mapChunks(e){return n(this,v).map(e)}forEachChangedChunkPass(e,i=!1){this.forEachChunkPass(r=>{const a=r.filter(c=>c.haveChanges());a.length!==0&&(e(a),i&&a.forEach(c=>c.resetChanges()))})}forEachChunkPass(e){n(this,$).forEach((i,r)=>{n(this,J)?H(this,it,ct).call(this,()=>e(i,r)):e(i,r)})}handleWorkerResponse(e){console.log("worker says:",this,e.data)}}v=new WeakMap,J=new WeakMap,X=new WeakMap,$=new WeakMap,tt=new WeakSet,at=function(){for(let e=0;e<n(this,v).size.x*n(this,v).size.y;e++)n(this,v).setAtIndex(e,n(this,v).createEmpty());H(this,et,ut).call(this)},et=new WeakSet,ut=function(){const e=[[!1,!1],[!1,!0],[!0,!1],[!0,!0]],i=[];e.forEach(([r,a])=>{const c=[];this.forEachChunk(g=>{c.push(g)},{evenRows:!r,oddRows:r,evenCols:!a,oddCols:a}),i.push(c)}),u(this,$,i)},it=new WeakSet,ct=function(e){n(this,X)&&n(this,X).postMessage({f:e})};var wt=function(){function s(t){this._value=NaN,typeof t=="string"?this._seed=this.hashCode(t):typeof t=="number"?this._seed=this.getSafeSeed(t):this._seed=this.getSafeSeed(s.MIN+Math.floor((s.MAX-s.MIN)*Math.random())),this.reset()}return s.prototype.next=function(t,e){return t===void 0&&(t=0),e===void 0&&(e=1),this.recalculate(),this.map(this._value,s.MIN,s.MAX,t,e)},s.prototype.nextInt=function(t,e){return t===void 0&&(t=10),e===void 0&&(e=100),this.recalculate(),Math.floor(this.map(this._value,s.MIN,s.MAX,t,e+1))},s.prototype.nextString=function(t,e){t===void 0&&(t=16),e===void 0&&(e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789");for(var i="";i.length<t;)i+=this.nextChar(e);return i},s.prototype.nextChar=function(t){return t===void 0&&(t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"),t.substr(this.nextInt(0,t.length-1),1)},s.prototype.nextArrayItem=function(t){return t[this.nextInt(0,t.length-1)]},s.prototype.nextBoolean=function(){return this.recalculate(),this._value>.5},s.prototype.skip=function(t){for(t===void 0&&(t=1);t-- >0;)this.recalculate()},s.prototype.reset=function(){this._value=this._seed},s.prototype.recalculate=function(){this._value=this.xorshift(this._value)},s.prototype.xorshift=function(t){return t^=t<<13,t^=t>>17,t^=t<<5,t},s.prototype.map=function(t,e,i,r,a){return(t-e)/(i-e)*(a-r)+r},s.prototype.hashCode=function(t){var e=0;if(t)for(var i=t.length,r=0;r<i;r++)e=(e<<5)-e+t.charCodeAt(r),e|=0,e=this.xorshift(e);return this.getSafeSeed(e)},s.prototype.getSafeSeed=function(t){return t===0?1:t},s.MIN=-2147483648,s.MAX=2147483647,s}();const Ct=new wt,kt=()=>Ct.next();class St{constructor(t,e){d(this,"position");d(this,"size");this.position=t,this.size=e}get tl(){return this.position}get tr(){return this.position.add(new f(this.size.x,0))}get br(){return this.position.add(this.size)}get bl(){return this.position.add(this.size.multiply(f.down))}toArray(){return[...this.position.toArray(),...this.size.toArray()]}}const o=class o{constructor(t=0,e=0){d(this,"x");d(this,"y");this.x=t,this.y=e}clone(){return new o(this.x,this.y)}add(t){return new o(this.x+t.x,this.y+t.y)}addScalar(t){return new o(this.x+t,this.y+t)}subtract(t=o.zero){return new o(this.x-t.x,this.y-t.y)}subtractScalar(t){return new o(this.x-t,this.y-t)}multiply(t){return new o(this.x*t.x,this.y*t.y)}multiplyScalar(t){return new o(this.x*t,this.y*t)}divide(t){return new o(this.x/t.x,this.y/t.y)}divideScalar(t){return new o(this.x/t,this.y/t)}mod(t){return new o(this.x%t.x,this.y%t.y)}modScalar(t){return new o(this.x%t,this.y%t)}abs(){return new o(Math.abs(this.x),Math.abs(this.y))}round(){return new o(Math.round(this.x),Math.round(this.y))}floor(){return new o(Math.floor(this.x),Math.floor(this.y))}ceil(){return new o(Math.ceil(this.x),Math.ceil(this.y))}frac(){return this.subtract(this.floor())}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){const t=this.length();return t===0?o.zero:this.multiplyScalar(1/t)}dot(t){const e=this.multiply(t);return e.x+e.y}isEqual(t){return this.x===t.x&&this.y===t.y}isNear(t,e=.001){const i=this.subtract(t).abs();return i.x<=e&&i.y<=e}toArray(){return[this.x,this.y]}join(t){return this.toArray().join(t)}static min(...t){return new o(Math.min(...t.map(e=>e.x)),Math.min(...t.map(e=>e.y)))}static max(...t){return new o(Math.max(...t.map(e=>e.x)),Math.max(...t.map(e=>e.y)))}static fromArray([t,e]){return new o(t,e)}static random(){return new o(Math.random(),Math.random())}};d(o,"zero",new o),d(o,"one",new o(1,1)),d(o,"up",new o(0,-1)),d(o,"down",new o(0,1)),d(o,"left",new o(-1,0)),d(o,"right",new o(1,0)),d(o,"negativeInfinity",new o(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)),d(o,"positiveInfinity",new o(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY));let f=o;const m={NW:new f(-1,-1),N:f.up,NE:new f(1,-1),E:f.right,SE:f.one,S:f.down,SW:new f(-1,1),W:f.left},Et=[m.NW,m.N,m.NE,m.W,m.E,m.SW,m.S,m.SE];class Mt{constructor(t){d(this,"grid");const{gridOptions:e}=t;this.grid=this.createGrid(e)}clear(){this.grid.clear()}}function It(s,t){const{children:e,grid:i,debugDraw:r,pickColor:a,...c}={debugDraw:!1,...s},g=S.useRef(null),w=S.useRef(null),C=S.useRef(),[E,z]=pt(!0);S.useImperativeHandle(t,()=>({clear:y,render:p})),S.useEffect(()=>{i&&(y(),p(i))},[i]);function b(){return w.current||(w.current=g.current?g.current.getContext("2d"):null,w.current&&(w.current.imageSmoothingEnabled=!1,w.current.translate(.5,.5))),w.current}function N(){if(C.current)return C.current;if(!i)return;const h=b();if(h)return C.current=h.createImageData(...i.size.toArray()),C.current}function y(){const h=N();h&&(h.data.fill(0),z(!0))}function p(h,R={debugDraw:r}){const{debugDraw:P,resetChanges:q}={debugDraw:!1,resetChanges:!1,...R};if(!h)return;const x=b();if(!x)return;const k=N();k&&(E.current===!0?h.forEach(F=>I({imageData:k,cell:F})):h.forEachChanged(F=>I({imageData:k,cell:F}),q),x.putImageData(k,0,0),P&&h instanceof mt&&h.forEachChunkPass((F,ft)=>{F.forEach(L=>{x.strokeStyle=L.haveChanges()?"rgba(255, 255, 255, 0.8)":"rgba(0, 0, 0, 0.2)",x.fillStyle=x.strokeStyle,x.lineWidth=1;const _=L.position.multiply(h.chunkSize);x.strokeRect(..._.toArray(),...h.chunkSize.toArray()),x.textAlign="right",x.fillText(L.position.toArray().toString(),..._.add(h.chunkSize).subtractScalar(2).toArray()),x.textAlign="left",x.fillText(ft.toString(),..._.add(h.chunkSize.multiply(f.down).add(f.fromArray([2,-2]))).toArray(),h.chunkSize.x),L.dirtyRect&&(x.strokeStyle="red",x.fillStyle="red",x.textAlign="left",x.fillText(L.countChanges().toString(),..._.add(f.fromArray([2,10])).toArray()),x.strokeRect(...L.dirtyRect.position.toArray(),...L.dirtyRect.size.toArray()))})}),z(!1))}function I(h){const{imageData:R,cell:P}=h;if(P.index===-1)return;const q=a?a({cell:P}):P.getRGBA();q&&R.data.set(q,P.index*4)}if(i)return nt.jsxs("div",{className:"grid canvas",children:[nt.jsx("canvas",{ref:g,width:i.size.x||1,height:i.size.y||1,...c}),e]})}const Rt=S.forwardRef(It);var O,K,A,V,Q,T,Y,j;class zt{constructor(t){l(this,O,void 0);l(this,K,void 0);l(this,A,void 0);d(this,"limitFps");l(this,V,void 0);l(this,Q,void 0);l(this,T,!0);l(this,Y,void 0);l(this,j,void 0);const{gridRenderer:e,renderOptions:i,simulation:r,limitFps:a,resetChanges:c,onStep:g}={resetChanges:!0,...t};u(this,O,e),u(this,K,i),u(this,A,r),this.limitFps=a,u(this,V,c),u(this,Q,g),this._stepInternal=this._stepInternal.bind(this),u(this,Y,requestAnimationFrame(this._stepInternal))}_stepInternal(t){this.step(t),u(this,Y,requestAnimationFrame(this._stepInternal))}get simulation(){return n(this,A)}destroy(){var t,e;this.stop(),(t=n(this,A))==null||t.clear(),(e=n(this,O))==null||e.clear(),n(this,Y)!==void 0&&cancelAnimationFrame(n(this,Y))}start(){n(this,T)||(u(this,T,!0),this._stepInternal(Date.now()))}stop(){u(this,T,!1),u(this,j,void 0)}restart(){this.destroy(),this.start()}isRunning(){return n(this,T)}registerSimulation(t){n(this,A)&&(console.error("already have one"),this.destroy()),u(this,A,t)}registerGridRenderer(t,e){u(this,O,t),e&&u(this,K,e)}step(t){if(n(this,j)===void 0)u(this,j,t);else{const e=(t-n(this,j))/1e3;if(this.limitFps===void 0||e>1/this.limitFps){if(n(this,A)){const i=n(this,A).grid;if(!i)throw new Error("simulation or grid must be provided");n(this,T)&&n(this,A).step(e),n(this,Q)&&n(this,Q).call(this,{grid:i,deltaTime:e}),n(this,O)&&n(this,O).render(i,{resetChanges:!1,...n(this,K)}),n(this,V)&&i.resetChanges()}u(this,j,t)}}}}O=new WeakMap,K=new WeakMap,A=new WeakMap,V=new WeakMap,Q=new WeakMap,T=new WeakMap,Y=new WeakMap,j=new WeakMap;function vt(s,t){var N,y;const{limitFps:e,resetChanges:i,renderOptions:r,children:a,initSimulation:c,onStep:g,...w}=s,C=S.useRef(null),E=S.useRef(null),z=S.useRef();S.useImperativeHandle(t,()=>E.current),S.useEffect(()=>{if(C.current&&!E.current)return E.current=new zt({gridRenderer:C.current,simulation:c(),limitFps:e,resetChanges:i,renderOptions:r,onStep:g}),()=>{var p;(p=E.current)==null||p.destroy()}}),S.useEffect(()=>{var p;C.current&&(gt.isEqual(r,z.current)||(z.current=r,(p=E.current)==null||p.registerGridRenderer(C.current,r)))},[r]);function b(p){p.preventDefault()}return nt.jsx(Rt,{ref:C,grid:(y=(N=E.current)==null?void 0:N.simulation)==null?void 0:y.grid,children:a,onContextMenu:b,...w})}const Pt=S.forwardRef(vt);export{mt as C,ht as G,Mt as S,f as V,Pt as a,ot as b,Et as n,kt as r,pt as u};

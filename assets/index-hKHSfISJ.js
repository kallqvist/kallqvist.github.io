var Ne=Object.defineProperty;var Pe=(r,t,e)=>t in r?Ne(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var i=(r,t,e)=>(Pe(r,typeof t!="symbol"?t+"":t,e),e),Y=(r,t,e)=>{if(!t.has(r))throw TypeError("Cannot "+e)};var f=(r,t,e)=>(Y(r,t,"read from private field"),e?e.call(r):t.get(r)),v=(r,t,e)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,e)},y=(r,t,e,s)=>(Y(r,t,"write to private field"),s?s.call(r,e):t.set(r,e),e);var J=(r,t,e,s)=>({set _(n){y(r,t,n,e)},get _(){return f(r,t,s)}}),ue=(r,t,e)=>(Y(r,t,"access private method"),e);import{r as g,_ as ce,j as u,F as Be,i as We,l as Ge}from"./index-k5VurcMA.js";import{G as Ie,V as c,a as ze,u as W,b as Ee}from"./index-Yvswd0Rb.js";var _;class U extends Ie{constructor(e,s){super(e);i(this,"empty");i(this,"shouldTryAwakeNeighbours");i(this,"color");i(this,"behaviors");v(this,_,!1);i(this,"index",-1);i(this,"position",new c(0,0));i(this,"age",0);i(this,"brushSize",4);i(this,"brushFillRate",.05);i(this,"velocity",new c(0,0));const{empty:n,shouldTryAwakeNeighbours:o,behaviors:l}={empty:!1,shouldTryAwakeNeighbours:!0,behaviors:[],...s};this.empty=n,this.shouldTryAwakeNeighbours=o,this.color=this.getRGBA(),this.behaviors=l}isSleeping(){return f(this,_)}sleep(){y(this,_,!0),this.grid.registerChanged(this)}awake(){y(this,_,!1),this.grid.registerChanged(this)}die(){this.grid.set(this.position,new D(this.grid))}getRGBA(){return this.color}addBehaviors(...e){this.behaviors.push(...e)}step(e){this.age+=e,this.behaviors.forEach(s=>{s.step({deltaTime:e,cell:this,grid:this.grid})})}}_=new WeakMap;class D extends U{constructor(e){super(e,{empty:!0});i(this,"brushSize",2);i(this,"brushFillRate",1);i(this,"color",[50,50,50,255]);this.sleep()}awake(){}step(){}}class w{}class de extends U{constructor(t,e){super(t,e);const{gravity:s,dispersionRate:n,erosionFactor:o}=e||{};this.addBehaviors(new me(s),new Te(n),new Le(o))}}class N extends de{}class K extends w{constructor(e=1){super();i(this,"sinkChance");this.sinkChance=e}step({cell:e}){if(Math.random()>this.sinkChance)return;const s=e.dir.S();if(s instanceof N){e.swapWith(s);return}const n=[-1,1];Math.random()>=.5&&n.reverse(),n.every(o=>{const l=e.getNeighbourInDirection(new c(o,1));return l instanceof N?(e.swapWith(l),!1):!0})}}class le extends w{constructor(e=1){super();i(this,"floatChance");this.floatChance=e}step({cell:e}){if(Math.random()>this.floatChance)return;const s=e.dir.N();if(s instanceof N){e.swapWith(s);return}}}class L extends U{}var G,z;class Te extends w{constructor(e=50){super();v(this,G,0);v(this,z,100+Math.random()*25);i(this,"dispersionRate");this.dispersionRate=e}step({cell:e,grid:s}){var l,d;let n=!1;const o=[-1,1];Math.random()>=.5&&o.reverse(),e.isSleeping()&&o.every(m=>{const h=e.getNeighbourInDirection(new c(m,0));return h!=null&&h.empty?(e.swapWith(h),!1):!0}),f(this,G)<=f(this,z)?o.every(m=>(s.getPositionsInLine(e.position,e.position.add(new c(m*this.dispersionRate,0)),{excludeStart:!0}).every(h=>{const p=s.getAtPosition(h);return p!=null&&p.empty?(e.swapWith(p),n=!0,J(this,G)._++,!1):!(p instanceof L)}),!n)):((l=e.dir.W())!=null&&l.empty||(d=e.dir.E())!=null&&d.empty)&&e.die()}}G=new WeakMap,z=new WeakMap;class P extends L{constructor(t,e){super(t,e),this.addBehaviors(new me)}}class Le extends w{constructor(e=.005){super();i(this,"erosionFactor");this.erosionFactor=e}step({cell:e}){if(this.erosionFactor>0){const s=e.dir.S();s instanceof P&&Math.random()<this.erosionFactor&&e.swapWith(s)}}}class H extends L{constructor(e,s){super(e,{shouldTryAwakeNeighbours:!1,...s});i(this,"brushSize",2);i(this,"brushFillRate",1);this.sleep()}awake(){}step(){}}var k,E;class me extends w{constructor(e=new c(0,9)){super();v(this,k,0);v(this,E,100);i(this,"isFalling",!1);i(this,"gravity");this.gravity=e}step({cell:e,grid:s,deltaTime:n}){let o=!1;const l=[-1,1];if(Math.random()>=.5&&l.reverse(),e.isSleeping()){const d=e.getNeighbourInDirection(this.gravity.y<0?c.up():c.down());d!=null&&d.empty&&(e.swapWith(d),o=!0,this.isFalling=!0)}else{e.velocity=e.velocity.add(this.gravity.multiplyScalar(n));let d=e;e.getLineTo(e.position.add(e.velocity),{excludeStart:!0}).every(m=>{const h=s.get(m);if(!(h!=null&&h.empty)){if(this.isFalling&&(h instanceof H||h instanceof P)){const p=e.velocity.subtract((h==null?void 0:h.velocity)||c.zero()).abs(),I=Math.random()*.2,q=Math.random()*.05;p.length()>0&&(e.velocity=new c(e.velocity.x+(Math.random()<.5?-1:1)*p.y*I,-p.y*q),d=e,this.isFalling=!1)}return!1}return d=h,!0}),d!==e?(e.swapWith(d),o=!0):l.every(m=>{const h=e.getNeighbourInDirection(new c(m,1));return h!=null&&h.empty?(e.swapWith(h),o=!0,!1):!0})}o?(l.every(d=>{const m=e.getNeighbourInDirection(new c(d,0));return m!=null&&m.empty||m==null||m.awake(),!0}),y(this,k,0)):(this.isFalling=!1,J(this,k)._++,f(this,k)>=f(this,E)&&e.sleep())}}k=new WeakMap,E=new WeakMap;class He extends w{constructor(e=.05,s=1,n=2){super();i(this,"jumpChance");i(this,"jumpHeight");i(this,"jumpLength");this.jumpChance=e,this.jumpHeight=s,this.jumpLength=n}step({cell:e}){if(e.velocity&&Math.random()<this.jumpChance){const s=(Math.random()*2-1)*this.jumpLength,n=-Math.random()*this.jumpHeight;e.velocity=new c(s,n),Math.random()<.1&&(e.velocity=e.velocity.multiplyScalar(1.2)),e.awake()}}}class fe extends w{constructor(e,s=1){super();i(this,"maxAge");i(this,"survivalChance");this.maxAge=e,this.survivalChance=s}step({cell:e}){Math.random()<this.survivalChance||e.age>this.maxAge&&e.die()}}class qe extends w{constructor(e=.05){super();i(this,"survivalChance");this.survivalChance=e}step({cell:e}){if(Math.random()<this.survivalChance)return;e.getNeighbourhood().map(o=>o instanceof N?1:0).reduce((o,l)=>o+l)>2&&e.die()}}class Oe extends w{constructor(e,s=3,n=5,o=.005){super();i(this,"spawn");i(this,"breedMinAge");i(this,"breedMaxAge");i(this,"breedChance");this.spawn=e,this.breedMinAge=s,this.breedMaxAge=n,this.breedChance=o}step({cell:e,grid:s}){if(e.isSleeping()||e.age<this.breedMinAge||e.age>this.breedMaxAge||Math.random()>this.breedChance)return;const n=e.dir.S();n&&n.constructor.prototype===e.constructor.prototype&&(n.age<this.breedMinAge||n.age>this.breedMaxAge||e.getNeighbourhood().every(o=>o!=null&&o.empty?(s.setAtIndex(o.index,this.spawn()),!1):!0))}}class Ve extends w{step({cell:t}){if(!t.isSleeping()||Math.random()<.995)return;t.getNeighbourhood().map(n=>n===void 0?1:n.empty?.5:n instanceof we?-1:n instanceof L?2:n instanceof N?1:0).reduce((n,o)=>n+o)>0&&t.die()}}class Q extends P{constructor(e,s){super(e,s);i(this,"_r",Math.random()*20);i(this,"color",[0,this._r,0,255]);i(this,"brushFillRate",.005);const n=5;this.addBehaviors(new He,new le,new Oe(()=>new Q(e),3,n,.05),new qe(.95),new fe(n,.995))}die(){this.grid.setAtIndex(this.index,new Xe(this,this.grid))}}class Xe extends P{constructor(e,s,n){super(s,n);i(this,"_r",Math.random()*20+10);i(this,"color");this.color=[...e.color.slice(0,3).map(o=>o+this._r),255],this.addBehaviors(new K(.05),new fe(10,.995))}die(){this.grid.setAtIndex(this.index,new pe(this.grid))}}class Ye extends H{constructor(){super(...arguments);i(this,"_r",Math.random()*20);i(this,"color",[100-this._r,180-this._r,100-this._r,255-this._r]);i(this,"brushFillRate",.4)}}class pe extends P{constructor(e,s){super(e,s);i(this,"_r",Math.random()*20);i(this,"color",[191-this._r,155-this._r,123-this._r,255]);this.addBehaviors(new K)}}class ge extends de{constructor(t,e){super(t,{dispersionRate:8,gravity:new c(0,-.25),erosionFactor:0,shouldTryAwakeNeighbours:!1,...e}),this.addBehaviors(new le(.2)),this.velocity=this.velocity.add(c.random().multiplyScalar(2).add(c.one().multiplyScalar(-1)).multiplyScalar(.025).multiply(c.right()))}}class Je extends ge{constructor(){super(...arguments);i(this,"color",[90,90,90,Math.round(Math.random()*185)+70])}}class we extends P{constructor(e,s){super(e,s);i(this,"_r",Math.random()*20);i(this,"color",[220-this._r,220-this._r,255,255]);this.addBehaviors(new Ve,new K(.05))}getRGBA(){return this.isSleeping()?this.color:[220,220,255,255]}die(){this.grid.set(this.position,Math.random()<.25?new Z(this.grid):new D(this.grid))}}class ve extends ge{constructor(){super(...arguments);i(this,"_r",Math.round(Math.random()*80)+100);i(this,"color",[255,255,255,this._r])}die(){this.grid.set(this.position,Math.random()<.05?new Z(this.grid):new D(this.grid))}}class Ue extends H{constructor(){super(...arguments);i(this,"color",[100,100,100,255])}}class Z extends N{constructor(e,s){super(e,{...s,dispersionRate:3});i(this,"_r",Math.round(Math.random()*100)+155);i(this,"color",[46,137,255,this._r])}die(){this.grid.set(this.position,Math.random()<.25?new ve(this.grid):new D(this.grid))}}class Ke extends H{constructor(){super(...arguments);i(this,"_r",Math.random()*20);i(this,"color",[180-this._r,100-this._r,100-this._r,255-this._r])}}var M,C,T,xe;class Qe{constructor(t){v(this,T);v(this,M,void 0);v(this,C,!0);i(this,"materialPalette");y(this,M,new ze({...t,createEmpty:e=>new D(e)})),this.materialPalette=ue(this,T,xe).call(this,f(this,M))}isRunning(){return f(this,C)}start(){y(this,C,!0)}stop(){y(this,C,!1)}restart(){this.stop(),f(this,M).clear(),this.start()}getGrid(){return f(this,M)}step(t){if(!f(this,C))return;f(this,M).forEach(s=>{s.empty||s.step(t)},{alternateRows:!0})}}M=new WeakMap,C=new WeakMap,T=new WeakSet,xe=function(t){return{empty:()=>new D(t),flea:()=>new Q(t),leaf:()=>new Ye(t),sand:()=>new pe(t),smoke:()=>new Je(t),snow:()=>new we(t),steam:()=>new ve(t),stone:()=>new Ue(t),water:()=>new Z(t),wood:()=>new Ke(t)}};function tt(){var ie;const e=g.useRef(null),s=g.useRef(),n=g.useRef(),o=g.useRef(),l=g.useRef(),d=g.useRef(void 0),[m,h]=W(!0),[p,I]=W(!1),[q,ye]=W([0,0]),[O,Me]=W("sand"),[$,be]=g.useState([0]),[ee,Se]=W(!1),[Fe,Re]=g.useState(void 0),[Ae,Ce]=g.useState([]);g.useEffect(()=>(s.current=new Qe({width:320,height:180}),n.current=s.current.getGrid(),Ce(ce.keys(s.current.materialPalette)),re(),o.current=requestAnimationFrame(te),()=>{o.current!==void 0&&cancelAnimationFrame(o.current)}),[]),g.useEffect(()=>{const a=s.current;a&&(m.current?a.start():a.stop())},[m.current]);function je(a){a.preventDefault()}function _e(a){const x=a.target,{x:b,y:S,width:F,height:ne}=x.getBoundingClientRect(),R=[(a.clientX-b)/F,(a.clientY-S)/ne];ye(R);const A=s.current;if(!A)return;const j=A.getGrid(),ae=new c(Math.floor(R[0]*j.width),Math.floor(R[1]*j.height)),B=j.getAtPosition(ae);B&&Re(B.constructor.name.toLowerCase())}function te(a){if(l.current===void 0)l.current=a;else{const x=(a-l.current)/1e3;{const b=s.current;if(!b)return;const S=b.getGrid();De(S),b.step(x),l.current=a,be(F=>[...F.slice(F.length-100),1/x])}}o.current=requestAnimationFrame(te)}function ke(){I(!0)}function se(){I(!1),d.current=void 0}function De(a){if(!p.current||!O.current)return;const[x,b]=q.current,S=new c(Math.floor(x*a.width),Math.floor(b*a.height)),F=s.current;if(!F)return;const R=F.materialPalette[O.current];if(!R)return;const A=R(),j=Math.floor(A.brushSize);(d.current?a.getPositionsInLine(d.current,S):[S]).every(B=>{for(let V=-j;V<A.brushSize;V++)for(let X=-j;X<A.brushSize;X++){if(Math.random()>A.brushFillRate)continue;const oe=B.x+X;if(oe<0)continue;const he=B.y+V;he<0||a.setAtPosition(new c(oe,he),R())}return!0}),d.current=S}function re(){const a=s.current;a&&a.restart()}return u.jsxs("div",{className:"route sand",ref:e,children:[u.jsxs("div",{className:"materials",children:[u.jsxs("div",{children:[u.jsx("button",{onClick:()=>h(a=>!a),children:m.current?u.jsxs(u.Fragment,{children:[u.jsx(Be,{}),"stop"]}):u.jsxs(u.Fragment,{children:[u.jsx(We,{}),"start"]})}),u.jsxs("button",{onClick:()=>re(),children:[u.jsx(Ge,{}),"reset"]})]}),u.jsx("div",{className:"separator"}),ce.map(Ae,a=>u.jsx("div",{className:"material",children:a,onClick:()=>Me(a),style:O.current===a?{border:"1px solid white"}:void 0},a)),u.jsx("div",{className:"separator"}),u.jsxs("div",{children:[u.jsx("input",{id:"debugDraw",type:"checkbox",checked:ee.current,onChange:a=>Se(a.target.checked)}),u.jsx("label",{htmlFor:"debugDraw",children:"debugDraw"})]}),u.jsx("div",{className:"separator"}),u.jsxs("div",{style:{width:"60px",whiteSpace:"nowrap"},children:["fps: ",Math.round($.reduce((a,x)=>a+x)/$.length||1)]})]}),u.jsx(Ee,{grid:(ie=s.current)==null?void 0:ie.getGrid(),onMouseDown:ke,onMouseUp:se,onMouseLeave:se,onMouseMove:_e,onContextMenu:je,pickColor:a=>ee.current&&!a.isSleeping()?[255,255,255,255]:a.getRGBA(),children:u.jsx("div",{style:{position:"absolute",top:0,right:0,padding:"0.25em",fontSize:"0.8em"},children:Fe})})]})}export{tt as default};

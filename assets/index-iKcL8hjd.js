var ce=Object.defineProperty;var ue=(n,e,t)=>e in n?ce(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var a=(n,e,t)=>(ue(n,typeof e!="symbol"?e+"":e,t),t),q=(n,e,t)=>{if(!e.has(n))throw TypeError("Cannot "+t)};var u=(n,e,t)=>(q(n,e,"read from private field"),t?t.call(n):e.get(n)),D=(n,e,t)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,t)},v=(n,e,t,i)=>(q(n,e,"write to private field"),i?i.call(n,t):e.set(n,t),t);var _=(n,e,t,i)=>({set _(r){v(n,e,r,t)},get _(){return u(n,e,i)}}),$=(n,e,t)=>(q(n,e,"access private method"),t);import{r as g,j as p,_ as X}from"./index-i3b4oVmR.js";function P(n){const[e,t]=g.useState(n),i=g.useRef(e);return[i,o=>{o instanceof Function?(i.current=o(i.current),t(o)):(i.current=o,t(o))}]}class c{constructor(e,t){a(this,"x");a(this,"y");this.x=e,this.y=t}add(e){return new c(this.x+e.x,this.y+e.y)}}const b={NW:new c(-1,-1),N:new c(0,-1),NE:new c(1,-1),E:new c(1,0),SE:new c(1,1),S:new c(0,1),SW:new c(-1,1),W:new c(-1,0)};var C;class Y{constructor(e,t){a(this,"empty",!1);a(this,"color");a(this,"grid");a(this,"shouldTryAwakeNeighbours");a(this,"index",-1);a(this,"position",new c(0,0));D(this,C,!0);a(this,"maxSpeed",8);a(this,"acceleration",.4);a(this,"velocity",0);a(this,"dir",{NW:()=>this.getNeighbourInDirection(b.NW),N:()=>this.getNeighbourInDirection(b.N),NE:()=>this.getNeighbourInDirection(b.NE),E:()=>this.getNeighbourInDirection(b.E),SE:()=>this.getNeighbourInDirection(b.SE),S:()=>this.getNeighbourInDirection(b.S),SW:()=>this.getNeighbourInDirection(b.SW),W:()=>this.getNeighbourInDirection(b.W)});const{isEmpty:i,shouldTryAwakeNeighbours:r}={shouldTryAwakeNeighbours:!0,...t};this.grid=e,this.shouldTryAwakeNeighbours=r,this.empty=i||!1,this.maxSpeed=8,this.acceleration=.4,this.velocity=0,this.color=this.getRGBA()}isSleeping(){return u(this,C)}sleep(){v(this,C,!0),this.grid.registerChanged(this)}awake(){v(this,C,!1),this.grid.registerChanged(this)}getPosition(){return this.grid.positionOf(this)}getNeighbourInDirection(e){const t=this.grid,i=t.positionOf(this);if(i)return t.getAtPosition(i.add(e))}swap(e){this.grid.swap(this,e)}}C=new WeakMap;class ee extends Y{constructor(e){super(e,{isEmpty:!0})}getRGBA(){return[50,50,50,255]}awake(){}step(){}}class B extends Y{}class H extends Y{constructor(t,i){super(t,i);a(this,"numFramesOfHorizontalMovement",0);a(this,"maxFramesOfHorizontalMovement",100);a(this,"dispersionRate");a(this,"fallDirection");a(this,"erosionFactor");const{dispersionRate:r,fallDirection:o,erosionFactor:s}=i||{};this.dispersionRate=r||5,this.fallDirection=o||1,this.erosionFactor=s||.03}step(){let t=!1;const i=[-this.dispersionRate,this.dispersionRate];Math.random()>.5&&i.reverse(),this.shouldTryAwakeNeighbours&&!this.isSleeping()&&i.every(o=>{const s=this.getNeighbourInDirection(new c(o,0));s!=null&&s.empty||s==null||s.awake(),this.erosionFactor>0&&s instanceof te&&Math.random()<this.erosionFactor&&this.swap(s)});const r=this.getNeighbourInDirection(new c(0,this.fallDirection));r!=null&&r.empty?(this.swap(r),t=!0,this.numFramesOfHorizontalMovement=0):this.numFramesOfHorizontalMovement<=this.maxFramesOfHorizontalMovement&&i.every(o=>{const s=this.grid;return s.getPositionsInLine(this.position,this.position.add(new c(o,0)),{excludeStart:!0}).every(w=>{const m=s.getAtPosition(w);return m!=null&&m.empty?(this.swap(m),t=!0,this.numFramesOfHorizontalMovement++,!1):!(m instanceof B)}),!t}),t||this.sleep()}}var O,z;class te extends B{constructor(){super(...arguments);D(this,O,0);D(this,z,100)}step(){let t=!1;const i=[-1,1];Math.random()>=.5&&i.reverse();const r=this.dir.S();r!=null&&r.empty||r instanceof H?(this.swap(r),t=!0):this.isSleeping()||i.every(o=>{const s=this.getNeighbourInDirection(new c(o,1));return s!=null&&s.empty||s instanceof H?(this.swap(s),t=!0,!1):!0}),t?(i.every(o=>{const s=this.getNeighbourInDirection(new c(o,0));return s!=null&&s.empty||s==null||s.awake(),!0}),v(this,O,0)):(_(this,O)._++,u(this,O)>=u(this,z)&&this.sleep())}}O=new WeakMap,z=new WeakMap;class he extends te{getRGBA(){const e=Math.random()*20;return[191-e,155-e,123-e,255]}}class de extends H{constructor(e,t){super(e,{...t,dispersionRate:3})}getRGBA(){return[46,137,255,Math.round(Math.random()*100)+155]}}class le extends B{constructor(e,t){super(e,{shouldTryAwakeNeighbours:!1,...t})}awake(){}step(){}}class fe extends le{getRGBA(){return[100,100,100,255]}}class U extends H{constructor(e,t){super(e,{fallDirection:-1,dispersionRate:3,erosionFactor:0,shouldTryAwakeNeighbours:!1,...t})}step(){super.step();const e=[-this.dispersionRate,this.dispersionRate];Math.random()>.5&&e.reverse();let t=!1;if(Math.random()<.98){const i=this.dir.N();i instanceof H&&!(i instanceof U)&&(this.swap(i),t=!0)}else this.numFramesOfHorizontalMovement<=this.maxFramesOfHorizontalMovement&&e.every(i=>{const r=this.grid;return r.getPositionsInLine(this.position,this.position.add(new c(i,0)),{excludeStart:!0}).every(s=>{const f=r.getAtPosition(s);return f!=null&&f.empty?(this.swap(f),t=!0,this.numFramesOfHorizontalMovement++,!1):!(f instanceof B)}),!t});t||this.sleep()}}class ge extends U{getRGBA(){return[90,90,90,Math.round(Math.random()*185)+70]}}var y,k;class me{constructor(e,t){a(this,"width");a(this,"height");D(this,y,void 0);D(this,k,void 0);this.width=e,this.height=t,v(this,y,[]),v(this,k,new Set([])),this.clear()}clear(){for(let e=0;e<this.width*this.height;e++)this.setAtIndex(e,new ee(this))}indexOf(e){return e?e.index:-1}positionOf(e){if(e)return e.position}forEach(e){const t=new Set;for(let i=0;i<u(this,y).length;i++){const r=u(this,y)[i];if(t.has(r))continue;if(e(r,i)===!1)break;t.add(r)}}forEachChanged(e,t=!0){u(this,k).forEach(i=>e(i)),t&&u(this,k).clear()}position2index(e){const{x:t,y:i}=e;return t<0||t>=this.width||i<0||i>=this.height?-1:t+i*this.width}index2position(e){let t=Math.floor(e/this.width),i=e-t*this.width;return new c(i,t)}get(e){return this.getAtPosition(e)}set(e,t){this.setAtPosition(e,t)}getPositionsInLine(e,t,i){const{excludeStart:r,excludeEnd:o}=i||{},s=t.x-e.x,f=t.y-e.y;if(s===0&&f===0)return[e];const w=s<0?-1:1,m=f<0?-1:1,R=Math.abs(s),x=Math.abs(f),j=R>=x,I=Math.min(R,x),d=Math.max(R,x),l=I/d,M=[];for(let N=r?1:0;N<(o?d:d+1);N++){const G=Math.round(N*l);j?M.push(new c(e.x+N*w,e.y+G*m)):M.push(new c(e.x+G*w,e.y+N*m))}return M}getAtPosition(e){const t=this.position2index(e);if(t!==-1)return this.getAtIndex(t)}setAtPosition(e,t){const i=this.position2index(e);this.setAtIndex(i,t)}getAtIndex(e){return u(this,y)[e]}registerChanged(e){u(this,k).add(e)}swap(e,t){const i=this.indexOf(e),r=this.indexOf(t),o=u(this,y)[i];this.setAtIndex(i,u(this,y)[r]),this.setAtIndex(r,o),e.awake(),t.awake()}setAtIndex(e,t){t.index=e,t.position=this.index2position(e),u(this,y)[e]=t,this.registerChanged(t)}}y=new WeakMap,k=new WeakMap;var A,E,T,ie;class pe{constructor(e){D(this,T);D(this,A,void 0);D(this,E,!0);a(this,"materialPalette");const{width:t,height:i}=e;v(this,A,new me(t,i)),this.materialPalette=$(this,T,ie).call(this,u(this,A))}isRunning(){return u(this,E)}start(){v(this,E,!0)}stop(){v(this,E,!1)}restart(){this.stop(),u(this,A).clear(),this.start()}getGrid(){return u(this,A)}step(){if(!u(this,E))return;u(this,A).forEach(t=>{t.empty||t.step(-1)})}}A=new WeakMap,E=new WeakMap,T=new WeakSet,ie=function(e){return{empty:()=>new ee(e),sand:()=>new he(e),water:()=>new de(e),stone:()=>new fe(e),smoke:()=>new ge(e)}};const we=g.forwardRef((n,e)=>{const{grid:t,debugDraw:i,...r}=n,o=g.useRef(null),s=g.useRef(),[f,w]=P(!0);g.useImperativeHandle(e,()=>({clear:x,render:j})),g.useEffect(()=>{w(!0),x()},[t]);function m(){return o.current?o.current.getContext("2d"):null}function R(){if(s.current)return s.current;if(!t)return;const d=m();if(d)return s.current=d.createImageData(t.width,t.height),s.current}function x(){const d=R();d&&(d.data.fill(255),w(!0))}function j(){if(!t)return;const d=m();if(!d)return;const l=R();l&&(f.current===!0?t.forEach(M=>I(l,M)):t.forEachChanged(M=>I(l,M)),d.putImageData(l,0,0),w(!1))}function I(d,l){l.index!==-1&&t&&d.data.set(i&&!l.isSleeping()?[255,255,255,255]:l.color,l.index*4)}return t?p.jsx("div",{className:"grid canvas",children:p.jsx("canvas",{ref:o,width:t.width,height:t.height,...r})}):null});function ye(){var Q;const t=g.useRef(null),i=g.useRef(null),r=g.useRef(),o=g.useRef(),s=g.useRef(),[f,w]=P(!1),[m,R]=P([0,0]),[x,j]=P(void 0),[I,d]=P(!1),[l,M]=P("sand"),[N,G]=g.useState([]);g.useEffect(()=>(r.current=new pe({width:320,height:180}),o.current=r.current.getGrid(),G(X.keys(r.current.materialPalette)),K(),s.current=requestAnimationFrame(J),()=>{s.current!==void 0&&cancelAnimationFrame(s.current)}),[]);function se(h){h.preventDefault()}function ne(h){const F=h.target,{x:W,y:S,width:V,height:L}=F.getBoundingClientRect();R([(h.clientX-W)/V,(h.clientY-S)/L])}function J(h){var S;const F=r.current;if(!F)return;const W=F.getGrid();ae(W),F.step(),(S=t.current)==null||S.render(),s.current=requestAnimationFrame(J)}function re(){w(!0)}function oe(){w(!1),j(void 0)}function ae(h){if(!f.current||!l.current)return;const[F,W]=m.current,S=new c(Math.floor(F*320),Math.floor(W*180));(x.current?h.getPositionsInLine(x.current,S):[S]).every(L=>{var Z;return h.setAtPosition(L,X.invoke((Z=r.current)==null?void 0:Z.materialPalette,l.current)),!0}),x.current=S}function K(){const h=r.current;h&&h.restart()}return p.jsxs("div",{className:"route sand",ref:i,children:[p.jsxs("div",{className:"materials",children:[p.jsx("div",{className:"material",children:"reset",onClick:K}),p.jsx("div",{className:"separator"}),X.map(N,h=>p.jsx("div",{className:"material",children:h,onClick:()=>M(h),style:l.current===h?{border:"1px solid white"}:void 0},h)),p.jsx("div",{className:"separator"}),p.jsxs("div",{children:[p.jsx("input",{id:"debugDraw",type:"checkbox",checked:I.current,onChange:h=>d(h.target.checked)}),p.jsx("label",{htmlFor:"debugDraw",children:"debugDraw"})]})]}),p.jsx(we,{ref:t,grid:(Q=r.current)==null?void 0:Q.getGrid(),debugDraw:I.current,onMouseDown:re,onMouseUp:oe,onMouseMove:ne,onContextMenu:se})]})}export{ye as default};
